<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="new" noun="Sale">
        <in-parameters>
            <parameter name="tillShiftId" required="true"/>
            <parameter name="customerPartyId" default-value="cliente0"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId" required="true"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="moitutils.TillShift" value-field="tillShift"/>
            <entity-find-one entity-name="mantle.product.store.ProductStore" value-field="productStore" auto-field-map="tillShift"/>
            <service-call name="mchile.TillServices.check#TillOpen" in-map="context"/>
            <entity-find entity-name="mantle.facility.FacilityContactMech" list="contactMechs">
                <econdition field-name="facilityId" from="productStore.inventoryFacilityId"/>
                <econdition field-name="contactMechPurposeId" value="PostalPrimary"/>
                <date-filter/>
            </entity-find>
            <service-call name="mantle.order.OrderServices.create#Order" in-map="[entryDate:ec.user.nowTimestamp,
                    statusId:'OrderOpen', productStoreId:tillShift.productStoreId, customerPartyId:customerPartyId,
                    tillShiftId:tillShiftId, shipmentMethodEnumId:'ShMthPickUp',
                    postalContactMechId:contactMechs.first?.contactMechId]" out-map="context"/>
        </actions>
    </service>

    <service verb="get" noun="CurrentSale">
        <in-parameters>
            <parameter name="tillShiftId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId"/>
        </out-parameters>
        <actions>
            <service-call name="mchile.TillServices.check#TillOpen" in-map="context"/>
            <service-call name="mantle.party.PartyServices.setup#UserOrganizationInfo" out-map="context"/>
            <entity-find entity-name="mantle.order.OrderHeaderAndPart" list="orders" limit="1">
                <econdition field-name="tillShiftId" from="tillShiftId"/>
                <econdition field-name="statusId" operator="in" from="['OrderOpen', 'OrderPlaced', 'OrderApproved', 'OrderClosed']"/>
                <econdition field-name="vendorPartyId" operator="in" from="userOrgIds"/>
                <order-by field-name="-entryDate"/>
            </entity-find>
            <if condition="orders">
                <then>
                    <set field="orderId" from="orders.get(0).orderId"/>
                    <set field="orderPartSeqId" from="orders.get(0).orderPartSeqId"/>
                </then>
                <else>
                    <service-call name="mchile.SaleServices.new#Sale" in-map="[tillShiftId:tillShiftId]" out-map="context"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="add" noun="OrderItemByBarcode">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="barcode" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.product.ProductIdentification" value-field="pid"
                             auto-field-map="[idValue:barcode]"/>
            <if condition="pid == null">
                <return message="No product found with barcode '${barcode}'."/>
            </if>
            <set field="productId" from="pid.productId"/>
            <service-call name="mantle.order.OrderServices.add#OrderProductQuantity"
                          in-map="[orderId:orderId, productId:productId]"/>
        </actions>
    </service>
    
    <service verb="check" noun="Sale">
        <!-- TODO: replace this with a SECA on mantle.order.OrderInfoServices.check#OrderPreApprove -->
        <in-parameters>
            <parameter name="orderId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="salesWarnings"/>
            <parameter name="salesErrors"/>
        </out-parameters>
        <actions>
            <set field="salesWarnings" type="List" from="[]"/>
            <set field="salesErrors" type="List" from="[]"/>
            <entity-find entity-name="mantle.order.OrderHeaderAndPart" list="orderHP">
                <econdition field-name="orderId" from="orderId"/>
            </entity-find>
            <if condition="!orderHP">
                <!--script>salesErrors.add("No OrderHeaderAndPart for orderId ${orderId}")</script-->
                <script>salesErrors.add("Error en operación: no hay datos para orden ${orderId}")</script>
                <return/>
            </if>
            <iterate list="orderHP" entry="ohp">
                <entity-find entity-name="mantle.order.OrderItem" list="items">
                    <econdition field-name="orderId" from="ohp.orderId"/>
                    <econdition field-name="orderPartSeqId" from="ohp.orderPartSeqId"/>
                </entity-find>
                <iterate list="items" entry="item">
                    <script><![CDATA[
                        if (item.unitAmount <= 0) {
                            //salesWarnings.add("Price <= 0 for item ${item.orderPartSeqId}.${item.orderItemSeqId} ('${item.itemDescription}')")
                            salesWarnings.add("Nota: item ${item.orderPartSeqId}.${item.orderItemSeqId} ('${item.itemDescription}') tiene precio <= 0")
                        }
                    ]]></script>
                </iterate>
            </iterate>
        </actions>
    </service>

    <service verb="place" noun="Order">
        <in-parameters>
            <parameter name="orderId"/>
            <parameter name="orderPartSeqId"/>
            <parameter name="statusId" default-value="InvoiceFinalized"/>
        </in-parameters>
        <actions>
            <service-call name="mantle.order.OrderServices.place#Order" in-map="context" out-map="context"/>
            <service-call name="mantle.account.InvoiceServices.create#EntireOrderPartInvoice" in-map="context"/>
        </actions>
    </service>

    <service verb="add" noun="Payment">
        <in-parameters>
            <auto-parameters entity-name="mantle.account.payment.Payment" include="nonpk"/>
            <parameter name="bankPartyId"/>
            <parameter name="checkDate" type="Timestamp"/>
        </in-parameters>
        <out-parameters>
            <parameter name="paymentId"/>
        </out-parameters>
        <actions>
            <service-call name="mantle.order.OrderInfoServices.get#OrderDisplayInfo" in-map="[orderId:orderId]" out-map="context"/>
            <if condition="invoiceIdSet.size() > 1">
                <return error="true" message="Cannot handle more than 1 invoice per Order for order ${orderId}"/>
            </if>
        <set field="invoiceId" from="invoiceIdSet.first()"/>
        <set field="orderPart" from="orderPartList.first"/>
        <set field="orderPartInfo" from="orderPartInfoList.get(0)"/>
        <set field="productStoreId" from="orderHeader.productStoreId"/>
        <set field="tillShiftId" from="orderHeader.tillShiftId"/>
        <service-call name="mchile.TillServices.check#TillOpen" in-map="context"/>
        <entity-find-one entity-name="moitutils.TillShift" value-field="tillShift"/>
        <set field="finAccountId" from="tillShift.finAccountId"/>
        <entity-find-one entity-name="mantle.account.financial.FinancialAccount" value-field="finAccount"/>
        <entity-find-one entity-name="mchile.ProductStorePaymentGlAccount" value-field="psglacc"
                         auto-field-map="[productStoreId:orderHeader.productStoreId,
                            paymentInstrumentEnumId:paymentInstrumentEnumId]"/>
        <set field="paymentBaseMap"
             from="[orderId:orderId, orderPartSeqId:orderPartSeqId, fromPartyId:orderPart.customerPartyId,
                   toPartyId:orderPart.vendorPartyId, statusId:'PmntPromised',
                   paymentInstrumentEnumId:paymentInstrumentEnumId, effectiveDate:ec.user.nowTimestamp,
                   overrideGlAccountId:psglacc?.glAccountId, paymentRefNum:paymentRefNum,
                   forInvoiceId:invoiceId]"/>

        <if condition="psglacc?.voucherTaxReceiptType != null">
            <if condition="!paymentRefNum">
                <return error="true" message="Card Voucher Number is required."/>
            </if>
        </if>
        <set field="tillShiftDocumentBaseMap"
             from="[tillShiftId:tillShift.tillShiftId, documentRefNum:paymentRefNum, statusId:'TsdCollectedAtTill']"/>
        <if condition="paymentInstrumentEnumId in ['PiPersonalCheck', 'PiCompanyCheck']">
            <service-call name="mchile.SaleServices.check#BankAccountForCheck" in-map="context" out-map="context"/>
            <set field="paymentBaseMap.effectiveDate" from="checkDate"/>
            <set field="paymentBaseMap.paymentMethodId" from="paymentMethodId"/>
            <service-call name="create#moitutils.TillShiftDocument"
                          in-map="tillShiftDocumentBaseMap + [documentTypeEnumId:'TsdtCheck']" out-map="context"/>
        </if>
        <if condition="paymentInstrumentEnumId in ['PiCreditCard', 'PiDebitCard']">
            <service-call name="create#mchile.dte.FiscalTaxDocument"
                          in-map="[invoiceId:invoiceId, fiscalTaxDocumentId:paymentRefNum,
                               fiscalTaxDocumentTypeEnumId:'PvtRedcompra', amount:amount]"/>
            <service-call name="create#moitutils.TillShiftDocument"
                          in-map="tillShiftDocumentBaseMap + [documentTypeEnumId:'TsdtCardVoucher']" out-map="context"/>
        </if>
        <set field="paymentAmount" from="(amount >= orderPartInfo.partTotalUnpaid)? orderPartInfo.partTotalUnpaid: amount"/>
        <set field="changeAmount" from="amount - paymentAmount"/>
        <if condition="paymentInstrumentEnumId == 'PiCash'">
            <then>
                <service-call name="mantle.account.FinancialAccountServices.deposit#FinancialAccount"
                              in-map="[finAccountId:finAccountId, reasonEnumId:'FatrCustomerPayment',
                      orderId:orderId, performedByUserId:ec.user.userId, amount:amount,
                      fromPartyId:orderPart.customerPartyId]" out-map="finTrans"/>
                <script>paymentBaseMap += [finAccountId:finAccountId]</script>
                <service-call name="mantle.order.OrderServices.add#OrderPartPayment"
                              in-map="paymentBaseMap+[amount:paymentAmount, finAccountId:finAccountId,
                                      finAccountTransId:finTrans.finAccountTransId]" out-map="context"/>
            </then>
            <else>
                <service-call name="mantle.order.OrderServices.add#OrderPartPayment" in-map="paymentBaseMap+[amount:amount]" out-map="context"/>
            </else>
        </if>

        <if condition="changeAmount > 0">
            <if condition="psglacc?.allowsHandingCashChange == 'Y'">
                <then>
                    <service-call name="mantle.account.FinancialAccountServices.withdraw#FinancialAccount"
                                  in-map="[finAccountId:finAccountId, reasonEnumId:'FatrCustomerChange',
                              orderId:orderId, performedByUserId:ec.user.userId, amount:changeAmount,
                              toPartyId:orderPart.customerPartyId]"/>
                </then>
                <else>
                    <entity-find-one entity-name="moqui.basic.Enumeration" value-field="paymentInstrument" auto-field-map="[enumId:paymentInstrumentEnumId]"/>
                    <return error="true" message="Cannot give change for paymentInstrument ${paymentInstrument.description}"/>
                </else>
            </if>
        </if>
        <if condition="tillShiftDocumentId">
            <service-call name="update#moitutils.TillShiftDocument" in-map="[tillShiftDocumentId:tillShiftDocumentId,
                                paymentId:paymentId]"/>
        </if>
        <if condition="paymentInstrumentEnumId in ['PiPersonalCheck', 'PiCompanyCheck']">
            <service-call name="create#mantle.account.method.BankAccountCheck" in-map="[paymentMethodId:paymentMethodId, checkNumber:paymentRefNum, paymentId:paymentId]"/>
        </if>
        <!-- Status change triggers applying and posting payment (add Effective Date?) -->
            <!--set field="effectiveDate" from="ec.user.nowTimestamp"/-->
            <service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentId, statusId:'PmntDelivered']"/>
            <service-call name="mchile.SaleServices.check#OrderAutoApprove" in-map="[orderId:orderId]"/>
        </actions>
    </service>


    <!-- Método para pago de abonos -->
    <service verb="add" noun="PrePayment">
        <in-parameters>
            <auto-parameters entity-name="mantle.account.payment.Payment" include="nonpk"/>
            <parameter name="bankPartyId"/>
            <parameter name="checkDate" type="Timestamp"/>
        </in-parameters>
        <actions>
            <service-call name="mantle.order.OrderInfoServices.get#OrderDisplayInfo" in-map="[orderId:orderId]" out-map="context"/>

            <set field="productStoreId" from="orderHeader.productStoreId"/>
            <set field="tillShiftId" from="orderHeader.tillShiftId"/>
            <service-call name="mchile.TillServices.check#TillOpen" in-map="context"/>
            <entity-find-one entity-name="moitutils.TillShift" value-field="tillShift"/>
            <set field="finAccountId" from="tillShift.finAccountId"/>
            <entity-find-one entity-name="mantle.account.financial.FinancialAccount" value-field="finAccount"/>
            <entity-find-one entity-name="mchile.ProductStorePaymentGlAccount" value-field="psglacc"
                             auto-field-map="[productStoreId:orderHeader.productStoreId,
                            paymentInstrumentEnumId:paymentInstrumentEnumId]"/>
            <set field="paymentBaseMap"
                 from="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:'PmntPromised',
                   paymentInstrumentEnumId:paymentInstrumentEnumId, effectiveDate:ec.user.nowTimestamp,
                   overrideGlAccountId:psglacc?.glAccountId, paymentRefNum:paymentRefNum,
                   forInvoiceId:invoiceId]"/>
            <if condition="psglacc?.voucherTaxReceiptType != null">
                <if condition="!paymentRefNum">
                    <return error="true" message="Card Voucher Number is required."/>
                </if>
            </if>
            <set field="tillShiftDocumentBaseMap"
                 from="[tillShiftId:tillShift.tillShiftId, documentRefNum:paymentRefNum, statusId:'TsdCollectedAtTill']"/>
            <if condition="paymentInstrumentEnumId in ['PiPersonalCheck', 'PiCompanyCheck']">
                <service-call name="mchile.SaleServices.check#BankAccountForCheck" in-map="context" out-map="context"/>
                <set field="paymentBaseMap.effectiveDate" from="checkDate"/>
                <set field="paymentBaseMap.paymentMethodId" from="paymentMethodId"/>
                <service-call name="create#moitutils.TillShiftDocument"
                              in-map="tillShiftDocumentBaseMap + [documentTypeEnumId:'TsdtCheck']" out-map="context"/>
            </if>
            <if condition="paymentInstrumentEnumId in ['PiCreditCard', 'PiDebitCard']">
                <service-call name="create#mchile.dte.FiscalTaxDocument"
                              in-map="[invoiceId:invoiceId, fiscalTaxDocumentId:paymentRefNum,
                               fiscalTaxDocumentTypeEnumId:'PvtRedcompra', amount:amount]"/>
                <service-call name="create#moitutils.TillShiftDocument"
                              in-map="tillShiftDocumentBaseMap + [documentTypeEnumId:'TsdtCardVoucher']" out-map="context"/>
            </if>
            <!--set field="paymentAmount" from="(amount >= orderPartInfo.partTotalUnpaid)? orderPartInfo.partTotalUnpaid: amount"/>
            <set field="changeAmount" from="amount - paymentAmount"/-->
            <set field="paymentAmount" from="amount"/>
            <if condition="paymentInstrumentEnumId == 'PiCash'">
                <then>
                    <service-call name="mantle.account.FinancialAccountServices.deposit#FinancialAccount"
                                  in-map="[finAccountId:finAccountId, reasonEnumId:'FatrCustomerPayment',
                      orderId:orderId, performedByUserId:ec.user.userId, amount:amount ]" out-map="finTrans"/>
                    <script>paymentBaseMap += [finAccountId:finAccountId]</script>
                    <service-call name="mantle.order.OrderServices.add#OrderPartPayment"
                                  in-map="paymentBaseMap+[amount:paymentAmount, finAccountId:finAccountId,
                                      finAccountTransId:finTrans.finAccountTransId]" out-map="context"/>
                </then>
                <else>
                    <service-call name="mantle.order.OrderServices.add#OrderPartPayment" in-map="paymentBaseMap+[amount:amount]" out-map="context"/>
                </else>
            </if>

            <if condition="changeAmount > 0">
                <if condition="psglacc?.allowsHandingCashChange == 'Y'">
                    <then>
                        <service-call name="mantle.account.FinancialAccountServices.withdraw#FinancialAccount"
                                      in-map="[finAccountId:finAccountId, reasonEnumId:'FatrCustomerChange',
                              orderId:orderId, performedByUserId:ec.user.userId, amount:changeAmount]"/>
                    </then>
                    <else>
                        <entity-find-one entity-name="moqui.basic.Enumeration" value-field="paymentInstrument" auto-field-map="[enumId:paymentInstrumentEnumId]"/>
                        <return error="true" message="Cannot give change for paymentInstrument ${paymentInstrument.description}"/>
                    </else>
                </if>
            </if>
            <if condition="tillShiftDocumentId">
                <service-call name="update#moitutils.TillShiftDocument" in-map="[tillShiftDocumentId:tillShiftDocumentId,
                                paymentId:paymentId]"/>
            </if>
            <if condition="paymentInstrumentEnumId in ['PiPersonalCheck', 'PiCompanyCheck']">
                <service-call name="create#mantle.account.method.BankAccountCheck" in-map="[paymentMethodId:paymentMethodId, checkNumber:paymentRefNum, paymentId:paymentId]"/>
            </if>
            <!-- Status change triggers applying and posting payment (add Effective Date?) -->
            <!--set field="effectiveDate" from="ec.user.nowTimestamp"/-->
            <service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentId, statusId:'PmntDelivered']"/>
        </actions>
    </service>

    <service verb="check" noun="BankAccountForCheck">
        <in-parameters>
            <parameter name="checkDate" required="true"/>
            <parameter name="paymentRefNum" required="true"/>
            <parameter name="bankPartyId" required="true"/>
            <parameter name="orderPart" type="Map"/>
            <parameter name="customerPartyId" default-value="cliente0"/>
        </in-parameters>
        <out-parameters>
            <parameter name="paymentMethodId"/>
        </out-parameters>
        <actions>
            <set field="custPartyId" value="none"/>
            <if condition="!orderPart">
                <then>
                    <set field="custPartyId" from="customerPartyId"/>
                    <entity-find entity-name="mchile.BankAccountAndPaymentMethod" list="existingAccounts">
                        <econdition field-name="ownerPartyId" from="customerPartyId"/>
                        <econdition field-name="paymentMethodTypeEnumId" value="PmtBankAccount"/>
                        <econdition field-name="bankPartyId" from="bankPartyId"/>
                    </entity-find>
                </then>
                <else>
                    <set field="custPartyId" from="orderPart.customerPartyId"/>
                    <entity-find entity-name="mchile.BankAccountAndPaymentMethod" list="existingAccounts">
                        <econdition field-name="ownerPartyId" from="orderPart.customerPartyId"/>
                        <econdition field-name="paymentMethodTypeEnumId" value="PmtBankAccount"/>
                        <econdition field-name="bankPartyId" from="bankPartyId"/>
                    </entity-find>
                </else>
            </if>


            <if condition="!existingAccounts">
                <then>
                    <entity-find-one entity-name="mantle.party.Organization" value-field="bank"
                                     auto-field-map="[partyId:bankPartyId]"/>
                    <entity-find-one entity-name="mantle.party.Party" value-field="party"
                                     auto-field-map="[partyId:custPartyId]"/>
                    <set field="paymentMethodMap" from="[paymentMethodTypeEnumId:'PmtBankAccount',
                                                             ownerPartyId:custPartyId, formDate:ec.user.nowTimestamp,
                                                             currencyUomId:currencyUomId]"/>
                    <if condition="party.partyTypeEnumId == 'PtyPerson'">
                        <then>
                            <entity-find-one entity-name="mantle.party.Person" value-field="person"
                                             auto-field-map="[partyId:custPartyId]"/>
                            <script><![CDATA[ paymentMethodMap += [firstNameOnAccount:person.firstName,
                                    middleNameOnAccount:person.middleName, lastNameOnAccount:person.lastName,
                                    titleOnAccount:person.personalTitle, suffixOnAccount:person.suffix] ]]></script>
                        </then>
                        <else>
                            <entity-find-one entity-name="mantle.party.Organization" value-field="organization"/>
                            <script><![CDATA[ paymentMethodMap += [companyNameOnAccount:organization.organizationName] ]]></script>
                        </else>
                    </if>
                    <service-call name="create#mantle.account.method.PaymentMethod" in-map="paymentMethodMap" out-map="context"/>
                    <service-call name="create#mantle.account.method.BankAccount"
                                  in-map="[paymentMethodId:paymentMethodId, bankPartyId:bankPartyId, bankName:bank.organizationName]"/>
                </then>
                <else>
                    <set field="paymentMethodId" from="existingAccounts.first.paymentMethodId"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="manuallyApprove" noun="Order">
        <implements service="mantle.order.OrderServices.change#OrderStatusInterface"/>
        <actions>
            <service-call name="mantle.order.OrderServices.approve#Order" in-map="context" out-map="context"/>
            <service-call name="mchile.SaleServices.process#OrderApproval" in-map="context"/>
        </actions>
    </service>

    <service verb="process" noun="OrderApproval">
        <in-parameters>
            <parameter name="orderId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-count entity-name="mantle.product.issuance.AssetReservation" count-field="reservedItems">
                <econdition field-name="orderId" from="orderId"/>
            </entity-find-count>
            <if condition="reservedItems > 0">
                <then>
                    <entity-find entity-name="mantle.order.OrderPart" list="orderParts">
                        <econdition field-name="orderId" from="orderId"/>
                    </entity-find>
                    <iterate list="orderParts" entry="orderPart">
                        <service-call name="mantle.shipment.ShipmentServices.ship#OrderPart" in-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId]" out-map="context"/>
                        <service-call name="update#mantle.shipment.Shipment" out-map="context" in-map="[shipmentId:shipmentId, statusId:'ShipDelivered']"/>
                    </iterate>
                </then>
            </if>
        </actions>
    </service>

    <service verb="check" noun="OrderPreApprove">
        <in-parameters><parameter name="orderId" required="true"/></in-parameters>
        <out-parameters><parameter name="approveWarnings"/></out-parameters>
        <actions>
            <!-- Si la orden no está puesta, el botón cambiar distribuidor falla -->
            <service-call name="mantle.order.OrderInfoServices.check#OrderPreApprove" in-map="[orderId:orderId]" out-map="context"/>
            <!-- Ignore similar order warnings -->
            <script>warningsToRemove = []</script>
            <iterate list="approveWarnings" entry="warning">
                <if condition="warning.startsWith('Found similar order ')">
                    <script>warningsToRemove.add(warning)</script>
                </if>
            </iterate>
            <script>approveWarnings.removeAll(warningsToRemove)</script>
        </actions>
    </service>

    <service verb="check" noun="OrderAutoApprove">
        <!-- This is based on but different to mantle.account.PaymentServices.authorize#OrderPayments:
             * warnings regarding similar orders are ignored
             * invoke process#OrderApproval for additional processing
             -->
        <in-parameters><parameter name="orderId" required="true"/></in-parameters>
        <out-parameters><parameter name="approveWarnings"/></out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/>
            <entity-find entity-name="mantle.account.payment.Payment" list="paymentList">
                <econdition field-name="orderId"/></entity-find>
            <set field="totalAuthorized" from="0"/>
            <iterate list="paymentList" entry="payment">
                <if condition="payment.statusId in ['PmntAuthorized', 'PmntDelivered', 'PmntConfirmed']">
                    <set field="totalAuthorized" from="totalAuthorized + (payment.amount ?: 0.0)"/>
                    <continue/>
                </if>
            </iterate>
            <if condition="totalAuthorized &gt;= orderHeader.grandTotal">
                <service-call name="mchile.SaleServices.check#OrderPreApprove" in-map="[orderId:orderId]" out-map="context"/>
                <if condition="!approveWarnings">
                    <service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, statusId:'OrderApproved']"/>
                    <service-call name="mchile.SaleServices.process#OrderApproval" in-map="[orderId:orderId]"/>
                </if>
            </if>
        </actions>
    </service>

    <service verb="finish" noun="Sale">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderPartSeqId" required="true"/>
        </in-parameters>
        <actions>
            <service-call name="mantle.order.OrderServices.complete#OrderPart" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId]"/>
        </actions>
    </service>

    <service verb="update" noun="TaxDocument">
        <in-parameters>
            <parameter name="invoiceId" required="true"/>
            <parameter name="amount"/>
            <parameter name="fiscalTaxDocumentId"/>
            <parameter name="fiscalTaxDocumentTypeEnumId"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="ftd" for-update="true"/>
            <if condition="ftd == null">
                <message error="true">Updating inexistent FiscalTaxDocument ${fiscalTaxDocumentId}</message>
                <!--
                <service-call name="create#mchile.dte.FiscalTaxDocument" in-map="[invoiceId:invoiceId,
                                    fiscalTaxDocumentId:fiscalTaxDocumentId,
                                    fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId,
                                    amount:amount]"/>
                                    -->
                <return/>
            </if>
            <if condition="fiscalTaxDocumentId">
                <script>ftd.fiscalTaxDocumentId = fiscalTaxDocumentId</script>
            </if>
            <if condition="fiscalTaxDocumentTypeEnumId">
                <script>ftd.fiscalTaxDocumentTypeEnumId = fiscalTaxDocumentTypeEnumId</script>
            </if>
            <if condition="amount">
                <script>ftd.amount = amount</script>
            </if>
            <entity-update value-field="ftd"/>
        </actions>
    </service>

    <service verb="park" noun="Sale">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderName" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/>
            <if condition="orderHeader">
                <service-call name="store#mantle.order.OrderHeader" in-map="[orderId:orderId, orderName:orderName]"/>
            </if>
        </actions>
    </service>

    <service verb="get" noun="CustomerList">
        <in-parameters>
            <parameter name="term"/>
        </in-parameters>
        <actions>
            <service-call name="mchile.SaleServices.get#CounterpartList" in-map="context"/>
        </actions>
    </service>

    <service verb="get" noun="CounterpartList">
        <in-parameters>
            <parameter name="term"/>
            <parameter name="counterpartType" default-value="Customer"/>
        </in-parameters>
        <actions>
            <set field="indexName" value="mantle"/>
            <set field="documentType" value="MantleParty"/>
            <log message="getting counterpartList for ${counterpartType}"/>
            <script><![CDATA[
                    StringBuilder termSb = new StringBuilder()
                    termSb.append('( combinedName:').append(term).append('* OR identifications.idValue:').append(term).append('* )')
                    termSb.append(' AND roles.roleTypeId:' + counterpartType)
                    ]]>
            </script>
            <service-call name="org.moqui.search.SearchServices.search#DataDocuments" out-map="context"
                          in-map="[queryString:termSb.toString(), indexName:indexName, documentType:documentType]"/>
            <script>
                def outList = []
                for (def document in documentList) {
                    label = document.combinedName + (document.idValue? (' (RUT ' + document.idValue + ')'):'')
                    outList.add([value:document._id, label:label])
                }
                ec.web.sendJsonResponse(outList)
            </script>
        </actions>
    </service>

    <service verb="change" noun="Customer">
        <implements service="mchile.SaleServices.change#CounterpartInterface"/>
        <actions>
            <service-call name="mchile.SaleServices.change#Counterpart" in-map="context+[counterpartType:'Customer']"/>
        </actions>
    </service>

    <service verb="change" noun="CounterpartInterface" type="interface">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderPartSeqId" required="true"/>
            <parameter name="counterpartType" required="true"/>
            <parameter name="partyId"/>
            <parameter name="organizationName"/>
            <parameter name="firstName"/>
            <parameter name="lastName"/>
            <parameter name="rut" type="String"/>
            <parameter name="run" type="String"/>
            <parameter name="orgEmailAddress"/>
            <parameter name="orgCountryCode" type="String"/>
            <parameter name="orgContactNumber"/>
            <parameter name="persEmailAddress"/>
            <parameter name="persCountryCode" type="String"/>
            <parameter name="persContactNumber"/>
            <parameter name="postalContactMechPurposeId"/>
            <parameter name="countryGeoId"/>
            <parameter name="address1"/>
            <parameter name="unitNumber"/>
            <parameter name="address2"/>
            <parameter name="stateProvinceGeoId"/>
        </in-parameters>
    </service>

    <service verb="change" noun="Counterpart">
        <implements service="mchile.SaleServices.change#CounterpartInterface"/>
        <actions>
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/>
            <set field="tillShiftId" from="orderHeader.tillShiftId"/>
            <if condition="tillShiftId"><service-call name="mchile.TillServices.check#TillOpen" in-map="context"/></if>
            <entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/>
            <if condition="orderPart == null">
                <return error="true" message="Could not find orderPart for orderId ${orderId}, orderPartSeqId ${orderPartSeqId}"/>
            </if>
            <if condition="!partyId">
                <service-call name="mchile.SaleServices.create#Counterpart" in-map="context" out-map="context"/>
            </if>
            <if condition="counterpartType == 'Customer'">
                <then><set field="orderPart.customerPartyId" from="partyId"/></then>
                <else><set field="orderPart.vendorPartyId" from="partyId"/></else>
            </if>
            <entity-update value-field="orderPart"/>
        </actions>
    </service>

    <service verb="create" noun="Counterpart">
        <in-parameters>
            <parameter name="counterpartType" required="true"/>
            <parameter name="organizationName"/>
            <parameter name="firstName"/>
            <parameter name="lastName"/>
            <parameter name="rut" type="String"/>
            <parameter name="run" type="String"/>
            <parameter name="orgEmailAddress"></parameter>
            <parameter name="orgCountryCode" type="String"/>
            <parameter name="orgContactNumber"></parameter>
            <parameter name="persEmailAddress"></parameter>
            <parameter name="persCountryCode" type="String"/>
            <parameter name="persContactNumber"></parameter>
            <parameter name="postalContactMechPurposeId"/>
            <parameter name="countryGeoId"/>
            <parameter name="address1"/>
            <parameter name="unitNumber"/>
            <parameter name="address2"/>
            <parameter name="stateProvinceGeoId"/>
            <parameter name="customerPartyId"/>
        </in-parameters>
        <out-parameters><parameter name="partyId"/></out-parameters>
        <actions>
            <if condition="!counterpartType in ['Customer', 'Supplier']">
                <return error="true" message="counterpartType has to be either Customer or Supplier"/>
            </if>
            <if condition="organizationName">
                <then>
                    <set field="emailAddress" from="orgEmailAddress"/>
                    <set field="countryCode" from="orgCountryCode"/>
                    <set field="contactNumber" from="orgContactNumber"/>
                    <service-call name="mantle.party.PartyServices.create#Organization" in-map="context"
                                  out-map="context"/>
                </then>
                <else-if condition="firstName || lastName">
                    <set field="emailAddress" from="persEmailAddress"/>
                    <set field="countryCode" from="persCountryCode"/>
                    <set field="contactNumber" from="persContactNumber"/>
                    <set field="rut" from="run"/>
                    <service-call name="mantle.party.PartyServices.create#Person" in-map="context"
                                  out-map="context"/>
                </else-if>
                <else>
                    <!--return error="true" message="Please select existing Customer or provide name and RUT for new customer"/-->
                    <return error="true" message="Seleccione sujeto ya existente o cree uno nuevo"/>
                </else>
            </if>
            <service-call name="create#mantle.party.PartyRole" in-map="[partyId:partyId, roleTypeId:counterpartType]"/>
            <if condition="emailAddress">
                <set field="emailContactMechPurposeId" value="EmailPrimary"/>
            </if>
            <if condition="contactNumber">
                <set field="telecomContactMechPurposeId" value="PhonePrimary"/>
            </if>
            <if condition="address1">
                <service-call name="mantle.party.ContactServices.create#PostalAddress"
                              in-map="[address1:address1, address2:address2, unitNumber:unitNumber,
                                  stateProvinceGeoId:stateProvinceGeoId, countryGeoId:countryGeoId]"
                              out-map="context"/>
            </if>
            <service-call name="mantle.party.ContactServices.store#PartyContactInfo" in-map="context"/>
            <if condition="rut">
                <service-call name="create#mantle.party.PartyIdentification"
                              in-map="[partyId:partyId, partyIdTypeEnumId:'PtidNationalTaxId', idValue:rut]"/>
            </if>
            <if condition="customerPartyId"><then>
                <service-call name="create#mantle.party.PartyRelationship" in-map="[relationshipTypeEnumId:'PrtSupplier', fromPartyId:partyId, fromRoleTypeId:'Vendor',
                                toPartyId:customerPartyId, toRoleTypeId:'Customer']"/>
            </then></if>
        </actions>
    </service>

    <service verb="set" noun="DefaultTillSeqId">
        <in-parameters><parameter name="productStoreId"/></in-parameters>
        <actions>
            <log message="set#DefaultTillSeqId: productStoreId = ${productStoreId}"/>
            <if condition="currentTillShiftId == null &amp;&amp; ec.web.sessionAttributes.get('TfPosTillShiftIdSelection') == null">
                <entity-find entity-name="moitutils.TillShiftDetail" list="tillshifts">
                    <econdition field-name="ownerPartyId" from="ec.user.userAccount.partyId"/>
                    <econdition field-name="statusId" value="TillShiftOpen"/>
                    <econdition field-name="productStoreId"/>
                    <date-filter/>
                </entity-find>
                <if condition="tillshifts.size() == 1">
                    <script>ec.web.sessionAttributes.put('TfPosTillShiftIdSelection', tillshifts.first.tillShiftId)</script>
                </if>
            </if>
        </actions>
    </service>

    <service verb="get" noun="TillDetail">
        <in-parameters><parameter name="orderPartInfo" type="Map"/></in-parameters>
        <out-parameters>
            <parameter name="customerName"/>
            <parameter name="orderPartSeqId"/>
            <parameter name="tillChangeTotal"/>
            <parameter name="tillPaymentsTotal"/>
            <parameter name="pendingToInvoiceFiscal" type="BigDecimal"/>
            <parameter name="partEditable"/>
        </out-parameters>
        <actions>
            <set field="customerName" from="orderPartInfo.customerDetail.organizationName?:'' + (orderPartInfo.customerDetail.firstName?:'')+ (orderPartInfo.customerDetail.lastName ? ' ' + orderPartInfo.customerDetail.lastName : '')"/>
            <set field="orderPartSeqId" from="orderPartInfo.orderPart.orderPartSeqId"/>
            <!-- Calculate total paid and change based on financialAccount -->
            <set field="payments" from="orderPartInfo.partPaymentList"/>
            <set field="tillPaymentsTotal" value="0" type="BigDecimal"/>
            <iterate entry="payment" list="payments">
                <if condition="!payment.finAccountId">
                    <set field="tillPaymentsTotal" from="tillPaymentsTotal+payment.amount"/>
                </if>
                <if condition="payment.forInvoiceId"><set field="invoiceId" from="payment.forInvoiceId"/></if>
            </iterate>
            <entity-find entity-name="mantle.account.financial.FinancialAccountTrans" list="finPayments">
                <econdition field-name="orderId" from="orderPartInfo.orderPart.orderId"/>
            </entity-find>
            <set field="changeTotal" value="0" type="BigDecimal"/>
            <iterate list="finPayments" entry="payment">
                <if condition="payment.reasonEnumId == 'FatrCustomerChange'">
                    <then><set field="tillChangeTotal" from="changeTotal - payment.amount"/></then>
                    <else><set field="tillPaymentsTotal" from="tillPaymentsTotal + payment.amount"/></else>
                </if>
            </iterate>
            <!--entity-find entity-name="mchile.dte.FiscalTaxDocument" list="fiscalInvoices"-->
            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="fiscalInvoices">
                <econdition field-name="invoiceId" from="invoiceId"/>
            </entity-find>
            <set field="invoicedTotal" from="0"/>
            <iterate list="fiscalInvoices" entry="invoice">
                <script>invoicedTotal += invoice?.amount?:0</script>
            </iterate>
            <set field="pendingToInvoiceFiscal" from="orderPartInfo.paymentsTotal - invoicedTotal"/>
            <set field="partEditable" from="orderPartInfo.orderPart.statusId in ['OrderBeingChanged', 'OrderOpen', 'OrderWishList', 'OrderGiftRegistry', 'OrderAutoReorder']"/>
        </actions>
    </service>

    <service verb="change" noun="OrderShift">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="tillShiftId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="oldTillShiftId"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="order"/>
            <set field="oldTillShiftId" from="order.tillShiftId"/>
            <set field="order.tillShiftId" from="tillShiftId"/>
            <entity-update value-field="order"/>
        </actions>
    </service>

    <service verb="place" noun="WebOrder">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="partyId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="paymentInstrumentId" required="true"/>
            <parameter name="statusId" default-value="InvoiceFinalized"/>
        </in-parameters>
        <actions>
            <entity-find entity-name="mantle.order.OrderItem" list="orderList">
                <econdition field-name="orderId" value="${orderId}"/>
            </entity-find>
            <script>
                int amount = 0
            </script>
            <iterate list="orderList" entry="order">
                <set field="quantity" from="order.quantity" type="BigDecimal"/>
                <set field="amountQuantity" from="order.unitAmount" type="BigDecimal"/>
                <script>
                    amount = (quantity*amountQuantity) + amount
                </script>
            </iterate>

            <service-call name="mantle.order.OrderServices.place#Order" in-map="context" out-map="context"/>

            <set field="updateMap" from="[paymentTypeEnumId:'PtInvoicePayment', fromPartyId:partyId, toPartyId:organizationPartyId, paymentInstrumentId:paymentInstrumentId,
            statusId:'PmntPromised', amount:amount, reconcileStatusId:'PmtrNot', orderPartSeqId:'01', effectiveDate:ec.user.nowTimestamp,
            orderId:orderId, paymentInstrumentEnumId:paymentInstrumentId, amountUomId:defaultCurrencyUomId]"/>
            <service-call name="create#mantle.account.payment.Payment" out-map="context" in-map="updateMap"/>
        </actions>
    </service>


    <!-- TODO: Order Cart Services -->
    <service verb="add" noun="OrderProductQuantity">
        <in-parameters>
            <parameter name="orderId"/>
            <parameter name="orderPartSeqId"/>
            <!-- OrderHeader settings -->
            <parameter name="productStoreId"/>
            <parameter name="currencyUomId"/>
            <parameter name="salesChannelEnumId"/>
            <!-- OrderPart settings -->
            <parameter name="customerPartyId"/>
            <parameter name="carrierPartyId"/><parameter name="shipmentMethodEnumId"/>

            <parameter name="productId" required="true"/>
            <parameter name="description"/>
            <parameter name="quantity" type="BigDecimal"><description>Defaults to 1 if addToQuantity=true (default)</description></parameter>
            <parameter name="addToQuantity" type="Boolean" default="true">
                <description>If true add to existing quantity, if false set quantity on current item</description></parameter>
            <parameter name="updateExisting" type="Boolean" default="true">
                <description>If true update existing item by productId, if false always create a new item</description></parameter>
            <parameter name="itemTypeEnumId" default-value="ItemProduct"/>
            <parameter name="unitAmount" type="BigDecimal"/>
            <parameter name="standardCost" type="BigDecimal"/>
            <parameter name="requiredByDate" type="Timestamp"/>
            <parameter name="otherPartyProductId"/>
            <parameter name="productFeatureId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderPartSeqId" required="true"/>
            <parameter name="orderItemSeqId" required="true"/>
        </out-parameters>
        <actions>
            <set field="defaultOrderParameters" from="[orderId:cartOrderId, customerPartyId:customerPartyId, currencyUomId:currencyUomId,
                productStoreId:productStoreId, salesChannelEnumId:'ScWeb']"/>
            <!--service-call name="mantle.order.OrderServices.add#OrderProductQuantity" out-map="addOut"
                          in-map="defaultOrderParameters + [productId:productId, quantity:quantity, productFeatureId:productFeatureId]"/-->
            <if condition="quantity == null &amp;&amp; (addToQuantity || !updateExisting)"><set field="quantity" from="1.0"/></if>
            <!-- handle explicit zero quantity -->
            <if condition="(quantity == null || quantity &lt;= 0) &amp;&amp; updateExisting">
                <!-- do nothing if add -->
                <if condition="addToQuantity || !orderId"><return/></if>
                <!-- in set mode remove the item -->
                <entity-find entity-name="mantle.order.OrderItem" list="orderItemList">
                    <econdition-object field="[orderId:orderId, orderPartSeqId:orderPartSeqId, productId:productId,
                        productConfigSavedId:null, forAssetId:null, selectedAmount:null]"/>
                </entity-find>
                <if condition="orderItemList">
                    <service-call name="mantle.order.OrderServices.delete#OrderItem"
                                  in-map="[orderId:orderId, orderItemSeqId:orderItemList[0].orderItemSeqId]"/>
                </if>
                <return/>
            </if>
            <!-- lookup orderPartSeqId if not passed in -->
            <if condition="!orderPartSeqId &amp;&amp; orderId">
                <entity-find entity-name="mantle.order.OrderPart" list="orderPartList">
                    <econdition field-name="orderId"/><order-by field-name="orderPartSeqId"/></entity-find>
                <set field="orderPartSeqId" from="orderPartList?.first?.orderPartSeqId"/>
            </if>

            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/>
            <entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart" for-update="true"/>

            <set field="productStoreId" from="productStoreId ?: orderHeader?.productStoreId"/>

            <entity-find-one entity-name="mantle.product.store.ProductStore" value-field="productStore"/>
            <set field="vendorPartyId" from="orderPart?.vendorPartyId ?: productStore?.organizationPartyId"/>
            <set field="currencyUomId" from="currencyUomId ?: productStore?.defaultCurrencyUomId"/>
            <set field="salesChannelEnumId" from="salesChannelEnumId ?: productStore?.defaultSalesChannelEnumId"/>

            <!-- have customerPartyId default to current user's partyId -->
            <set field="customerPartyId" from="(customerPartyId ?: orderPart?.customerPartyId) ?: ec.user.userAccount?.partyId"/>

            <if condition="!orderId">
                <if condition="customerPartyId">
                    <entity-find entity-name="mantle.order.OrderHeaderAndPart" list="existingOrderList">
                        <econdition field-name="statusId" value="OrderOpen"/>
                        <econdition field-name="customerPartyId"/>
                        <econdition field-name="productStoreId" ignore-if-empty="true"/>
                        <select-field field-name="orderId"/><select-field field-name="orderPartSeqId"/>
                        <order-by field-name="-entryDate"/><!-- get most recent open order -->
                    </entity-find>
                    <if condition="existingOrderList">
                        <set field="orderId" from="existingOrderList[0].orderId"/>
                        <set field="orderPartSeqId" from="existingOrderList[0].orderPartSeqId"/>
                    </if>
                </if>
                <!-- no existing open (cart) order found? create one -->
                <if condition="!orderId">
                    <service-call name="mantle.order.OrderServices.create#Order" out-map="createOrderOut"
                                  in-map="[currencyUomId:currencyUomId, productStoreId:productStoreId, salesChannelEnumId:salesChannelEnumId,
                                vendorPartyId:vendorPartyId, customerPartyId:customerPartyId, carrierPartyId:carrierPartyId,
                                shipmentMethodEnumId:shipmentMethodEnumId]"/>
                    <set field="orderId" from="createOrderOut.orderId"/>
                    <set field="orderPartSeqId" from="createOrderOut.orderPartSeqId"/>
                </if>
            </if>

            <!-- calculate the price based on quantity, etc, -->
            <if condition="unitAmount == null"><then>
                <service-call name="mantle.product.PriceServices.get#ProductPrice" out-map="priceMap"
                              in-map="[productId:productId, quantity:quantity, priceUomId:currencyUomId,
                         productStoreId:productStoreId, customerPartyId:customerPartyId, vendorPartyId:vendorPartyId]"/>

                <set field="unitAmount" from="priceMap.price"/>
                <set field="unitListPrice" from="priceMap.listPrice"/>
                <set field="isModifiedPrice" value="N"/>
            </then><else>
                <set field="isModifiedPrice" value="Y"/>
            </else></if>

            <!-- look up otherPartyProductId if not specified -->
            <if condition="!otherPartyProductId &amp;&amp; productId">
                <entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart" for-update="true"/>
                <entity-find-one entity-name="mantle.party.PartyRole" value-field="vendorOrgRole">
                    <field-map field-name="partyId" from="orderPart.vendorPartyId"/>
                    <field-map field-name="roleTypeId" value="OrgInternal"/>
                </entity-find-one>
                <if condition="vendorOrgRole != null &amp;&amp; orderPart.customerPartyId"><then>
                    <entity-find entity-name="mantle.product.ProductPrice" list="otherPartyItemIdList">
                        <date-filter/><econdition field-name="productId"/>
                        <econdition field-name="customerPartyId" from="orderPart.customerPartyId"/>
                        <econdition field-name="otherPartyItemId" operator="is-not-null"/>
                    </entity-find>
                    <if condition="otherPartyItemIdList">
                        <set field="otherPartyProductId" from="otherPartyItemIdList[0].otherPartyItemId"/></if>
                </then><else-if condition="vendorOrgRole != null &amp;&amp; orderPart.vendorPartyId">
                    <entity-find entity-name="mantle.product.ProductPrice" list="otherPartyItemIdList">
                        <date-filter/><econdition field-name="productId"/>
                        <econdition field-name="vendorPartyId" from="orderPart.vendorPartyId"/>
                        <econdition field-name="otherPartyItemId" operator="is-not-null"/>
                    </entity-find>
                    <if condition="otherPartyItemIdList">
                        <set field="otherPartyProductId" from="otherPartyItemIdList[0].otherPartyItemId"/></if>
                </else-if></if>
            </if>

            <!-- find an OrderItem for the productId and increment quantity if found, otherwise create OrderItem with quantity -->
            <entity-find entity-name="mantle.order.OrderItem" list="orderItemList">
                <econdition-object field="[orderId:orderId, orderPartSeqId:orderPartSeqId, productId:productId, productFeatureId:productFeatureId,
                        productConfigSavedId:null, forAssetId:null, selectedAmount:null]"/>
            </entity-find>

            <if condition="orderItemList &amp;&amp; updateExisting"><then>
                <set field="orderItem" from="orderItemList.first"/>
                <set field="orderItemSeqId" from="orderItem.orderItemSeqId"/>
                <set field="orderPartSeqId" from="orderItem.orderPartSeqId" set-if-empty="false"/>
                <set field="unitAmount" from="unitAmount != null ? unitAmount : orderItem.unitAmount"/>
                <set field="standardCost" from="standardCost != null ? standardCost : orderItem.standardCost"/>
                <set field="quantity" from="addToQuantity ? quantity + orderItem.quantity : quantity"/>
                <!-- if requiredByDate on orderItem is less than that passed in, make sure to use it instead of the new later one -->
                <if condition="orderItem.requiredByDate &amp;&amp; requiredByDate &amp;&amp; orderItem.requiredByDate &lt; requiredByDate">
                    <set field="requiredByDate" from="orderItem.requiredByDate"/></if>
                <service-call name="mantle.order.OrderServices.update#OrderItem" in-map="context"/>
            </then><else>
                <service-call name="mantle.order.OrderServices.create#OrderItem" in-map="context" out-map="createOrderItemOut"/>
                <set field="orderItemSeqId" from="createOrderItemOut.orderItemSeqId"/>
            </else></if>
        </actions>
    </service>
    <service verb="update" noun="OrderProductQuantity" authenticate="anonymous-all">
        <!-- TODO had transaction="cache" but causing issues with updating single Payment amount and sometimes part/header total when there are multiple promotions active (ie New Customer and BOGO) -->
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="orderItemSeqId" required="true"/>
            <parameter name="quantity" type="BigDecimal" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/>
            <if condition="quantity &lt;= 0">
                <service-call name="mantle.order.OrderServices.delete#OrderItem"
                              in-map="[orderId:orderId, orderItemSeqId:orderItemSeqId]"/>
                <return/>
            </if>

            <service-call name="mantle.order.OrderServices.update#OrderItem"
                          in-map="[orderId:orderId, orderItemSeqId:orderItemSeqId, quantity:quantity]"/>
        </actions>
    </service>
    <service verb="merge" noun="OrderItems">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="fromOrderId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find entity-name="mantle.order.OrderItem" list="orderItemList">
                <econdition field-name="orderId" from="fromOrderId"/></entity-find>
            <entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true">
                <econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find>
            <set field="productItemTypes" from="productItemTypeEgms*.enumId"/>
            <iterate list="orderItemList" entry="orderItem">
                <if condition="!orderItem.productId || !(orderItem.itemTypeEnumId in productItemTypes)"><continue/></if>
                <service-call name="mantle.order.OrderServices.add#OrderProductQuantity"
                              in-map="[orderId:orderId, productId:orderItem.productId, quantity:orderItem.quantity]"/>
            </iterate>
        </actions>
    </service>

</services>