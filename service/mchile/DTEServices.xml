<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a 
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <service verb="genera" noun="Factura" type="script" location="component://MoquiChile/service/mchile/DTEServices/generaFactura.groovy">
        <description>
            Generación de DTE de acuerdo a plantilla
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="rutReceptor" required="true"/>
            <parameter name="receiverPartyId" required="true"/>
            <parameter name="rznSocReceptor" required="true"/>
            <parameter name="giroReceptor" required="true"/>
            <parameter name="contactoReceptor" required="true"/>
            <parameter name="dirReceptor" required="true"/>
            <parameter name="cmnaReceptor" required="true"/>
            <parameter name="ciudadReceptor" default-value="${cmnaReceptor}"/>
            <parameter name="detailList" type="List"/>
            <parameter name="invoiceId"/>
            <parameter name="shipmentId"/>
            <parameter name="medioPago"/>
            <parameter name="formaPago"/>
            <parameter name="referenciaList" type="List"/>
            <parameter name="globalDiscount"/>
            <parameter name="glosaDr"/>
            <parameter name="glosaPagos"/>
            <parameter name="indTraslado" type="Integer"/>
            <parameter name="tipoDespacho" type="Integer"/>
            <parameter name="settlementTermId"/>
            <parameter name="invoiceMessage"/>
            <parameter name="fechaVencimiento" type="Date"/>
            <parameter name="tipoDespacho"/>
            <parameter name="codigosActividadEconomica"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
    </service>

    <service verb="generaEnvio" noun="Documentos" type="script" location="component://MoquiChile/service/mchile/DTEServices/generaEnvio.groovy">
        <description>Generación de envio documento a partir de facturas ya generadas.</description>
        <in-parameters>
            <parameter name="rutReceptor" default-value="60803000-K"><description>El receptor del envio es el SII</description></parameter>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="documentIdList" required="true" type="List"/>
            <parameter name="saveSinFirma" type="Boolean" default="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="xmlContentLocation"/>
        </out-parameters>
    </service>

    <service verb="generaEnvio" noun="Boletas" type="script" location="component://MoquiChile/service/mchile/DTEServices/generaEnvioBoletas.groovy">
        <description>
            Generación de envio documento a partir de facturas ya generadas.
        </description>
        <in-parameters>
            <parameter name="recepS"/>
            <parameter name="enviadorS" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="documentIdList" required="true" type="List"/>
            <parameter name="saveSinFirma" type="Boolean" default="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="archivoEnvio"/>
        </out-parameters>
    </service>

    <service verb="enviaSII" noun="Documento"  type="script" location="component://MoquiChile/service/mchile/DTEServices/enviaSiiDocumento.groovy">
        <description>
            Envio documento a partir de documento envio ya generado
            rutOrganizacion: rut de compañía que envía
            rutEnviador: rut de persona que envía
            documentoS: nombre de documento a enviar (que puede contener varios)
        </description>
        <in-parameters>
            <parameter name="rutOrganizacion" required="true"/>
            <parameter name="documentLocation" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="trackId"/>
        </out-parameters>
    </service>

    <service verb="enviarDirecto" noun="SII">
        <description>
            Servicio para enviar boleta de forma directa al SII, sin armar un envio nuevo
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="trackId"/>
        </out-parameters>
        <actions>
            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>

            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="contentEv">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId" value="Ftdct-Xml"/>
                <select-field field-name="contentLocation"/>
            </entity-find-one>

            <set field="contentLocation" from="contentEv.contentLocation"/>

            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId" from="organizationPartyId"/>
                <econdition field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find>

            <if condition="!partyIdentificationList.idValue[0]">
                <return error="true" message="Organización $organizationPartyId no tiene RUT definido"/>
            </if>
            <set field="rutEmisor" from="partyIdentificationList.idValue[0]"/>

            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>

            <service-call name="mchile.DTEServices.enviaSII#Boleta" in-map="[compaS:rutEmisor, enviadorS:rutEnvia, documentoS:contentLocation, organizationPartyId:organizationPartyId]" out-map="context"/>
            <!-- TODO: Eliminar archivo temporal -->
            <!-- Marcar boleta como enviada -->
            <!-- Se marca DTE como enviada -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="dteEv" for-update="true">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>
            <set field="dteEv.fiscalTaxDocumentSentStatusEnumId" value="Ftdt-Sent"/>
            <set field="dteEv.trackId" from="trackId"/>
            <entity-update value-field="dteEv"/>
        </actions>
    </service>

    <service verb="enviaSII" noun="Boleta">
        <description>
            Envio boleta a partir de documento envio ya generado
            compaS: rut de compañía que envía
            enviadorS: rut de persona que envía
            documentoS: nombre de documento a enviar (que puede contener varios)
        </description>
        <in-parameters>
            <parameter name="compaS" required="true"/>
            <parameter name="enviadorS" required="true"/>
            <parameter name="documentContentLocation" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="trackId"/>
        </out-parameters>
        <actions>
            <!-- Validación rut -->
            <service-call name="mchile.GeneralServices.verify#Rut" in-map="[rut:enviadorS]"/>

            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>
            <set field="certData" from="certData"/>
            <set field="passS" from="passCert"/>

            <set field="trackId" value=""/>
            <script>
                import java.io.File
                import java.io.FileInputStream
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import cl.nic.dte.net.ConexionSiiBoleta
                import cl.nic.dte.util.Utilities
                import org.json.simple.JSONObject
                import org.moqui.resource.ResourceReference

                ConexionSiiBoleta con = new ConexionSiiBoleta()
                // leo certificado y llave privada del archivo pkcs12
                KeyStore ks = KeyStore.getInstance("PKCS12")
                ks.load(new ByteArrayInputStream(certData.decodeBase64()), passS.toCharArray())
                String alias = ks.aliases().nextElement()
                //logger.warn("Usando certificado " + alias + " del archivo PKCS12: " + certS)

                X509Certificate x509 = (X509Certificate) ks.getCertificate(alias)
                PrivateKey pKey = (PrivateKey) ks.getKey(alias, passS.toCharArray())

                String token = con.getToken(pKey, x509)

                String enviadorS = Utilities.getRutFromCertificate(x509)

                ResourceReference documentoRr = ec.resource.getLocationReference(documentContentLocation)
                JSONObject recp
                if (dteSystemIsProduction)
                    recp = con.uploadEnvioProduccion(enviadorS, compaS, documentoRr.openStream(), token)
                else
                    recp = con.uploadEnvioCertificacion(enviadorS, compaS, documentoRr.openStream(), token)

                String estado = (String) recp.get("estado")
                trackId = String.valueOf(recp.get("trackid"))

                if (estado.equals("REC")) {
                    logger.warn("Boleta rechazada: " + recp.toString())
                } else if (estado.equals("RPR")) {
                    logger.warn("Boleta aceptada con reparos")
                } else if (estado.equals(RFR)) {
                    logger.warn("Boleta con error en firma")
                } else {
                    logger.warn("Boleta recibida con trackid" + trackId)
                }

            </script>
            <if condition="estado.equals('REC')">
                <then>
                    <return message="Error al enviar al SII"/>
                </then>
                <else-if condition="estado.equals('RFR')">
                    <return message="Error en Firma"/>
                </else-if>
                <else>
                    <return message="Recibo con exito"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="marcarEnviados" noun="Documentos">
        <description>
            Marca lista de documentos como enviados, usando el trackid devuelto por el SII
        </description>
        <in-parameters>
            <parameter name="trackId"/>
            <parameter name="documentIdList" required="true" type="List"/>
        </in-parameters>
        <actions>
            <iterate list="documentIdList" entry="documentId">
                <!-- Se marca DTE como enviada -->
                <set field="idDte" from="documentId"/>
                <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="dteEv" for-update="true">
                    <field-map field-name="fiscalTaxDocumentId" from="idDte"/>
                </entity-find-one>
                <set field="dteEv.fiscalTaxDocumentSentStatusEnumId" value="Ftdt-Sent"/>
                <set field="dteEv.trackId" from="trackId"/>
                <entity-update value-field="dteEv"/>
            </iterate>
        </actions>
    </service>

    <service verb="load" noun="DTEConfig">
        <description>
            Carga parametros desde archivo resources
        </description>
        <in-parameters>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <auto-parameters entity-name="mchile.dte.PartyDteParams"/>
            <parameter name="rutEmisor"/>
            <parameter name="rutEnvia"/>
            <parameter name="transformParameters"/>
            <parameter name="dteSystemIsProduction" type="Boolean"/>
            <parameter name="certificate" type="java.security.cert.X509Certificate"/>
            <parameter name="pkey" type="java.security.PrivateKey"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.PartyDteParams" value-field="dteParams">
                <field-map field-name="partyId" from="partyId"/>
            </entity-find-one>

            <if condition="!dteParams">
                <message error="true">Organización no tiene datos para generar DTE</message>
            </if>

            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="context" out-map="context"/>
            <set field="rutEmisor" from="rutSinFormato"/>
            <if condition="rut == null"><message error="true">No se encuentra RUT para emisor (partyId ${partyId})</message></if>

            <check-errors/>

            <set field="certData" from="dteParams.certData"/>
            <set field="passCert" from="dteParams.passCert"/>
            <script><![CDATA[
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import cl.nic.dte.util.Utilities

                if (certData && passCert) {
                    KeyStore ks = KeyStore.getInstance("PKCS12")
                    ks.load(new ByteArrayInputStream(certData.decodeBase64()), passCert.toCharArray())
                    String alias = ks.aliases().nextElement()
                    certificate = (X509Certificate) ks.getCertificate(alias)
                    rutEnvia = Utilities.getRutFromCertificate(certificate)
                    ec.service.sync().name("mchile.GeneralServices.verify#Rut").parameter("rut", rutEnvia).call()
                    pkey = (PrivateKey) ks.getKey(alias, ((String)passCert).toCharArray())
                }
            ]]></script>

            <set field="pdfTemplate" from="dteParams.pdfTemplate"/>
            <if condition="!pdfTemplate">
                <set field="pdfTemplate" from="ec.resource.getLocationReference('component://MoquiChile/DTE/TEMPLATES/plantilla_general.xsl').text"/>
            </if>
            <set field="pdfTemplateBoleta" from="dteParams.pdfTemplateBoleta"/>
            <set field="pdfTemplateBoletaContinua" from="dteParams.pdfTemplateBoletaContinua"/>
            <set field="logo" from="dteParams.logo ?: ''"/>
            <set field="fchResol" from="dteParams.fchResol ?: ''"/>
            <set field="nroResol" from="dteParams.nroResol ?: ''"/>
            <set field="rznSocEmisor" from="dteParams.rznSocEmisor"/>
            <set field="cdgSIISucur" from="dteParams.cdgSIISucur"/>
            <set field="dirOrigen" from="dteParams.dirOrigen"/>
            <set field="cmnaOrigen" from="dteParams.cmnaOrigen"/>
            <set field="ciudadOrigen" from="dteParams.ciudadOrigen"/>
            <set field="nmbContacto" from="dteParams.nmbContacto"/>
            <set field="mailContacto" from="dteParams.mailContacto ?: ''"/>
            <set field="fonoContacto" from="dteParams.fonoContacto ?: ''"/>
            <set field="oficinaSII" from="dteParams.oficinaSII ?: ''"/>
            <set field="showItemNumber" from="dteParams.showItemNumber ?: 'Y'"/>
            <set field="commentAfterDetalle" from="dteParams.commentAfterDetalle ?: ''"/>
            <set field="cuentaBancariaMail" from="dteParams.cuentaBancariaMail ?: ''"/>
            <set field="cuentaBancariaText" from="dteParams.cuentaBancariaText ?: ''"/>
            <set field="codigosActividadEconomica" from="dteParams.codigosActividadEconomica ?: ''"/>
            <set field="detailHeaderBgColor" from="dteParams.detailHeaderBgColor ?: '&#35;eaeaea'"/>
            <set field="detailHeaderFgColor" from="dteParams.detailHeaderFgColor ?: 'black'"/>
            <set field="detailHeaderSepColor" from="dteParams.detailHeaderSepColor ?: 'white'"/>
            <set field="tableBorderColor" from="dteParams.tableBorderColor ?: '&#35;eaeaea'"/>
            <set field="vendorNameColor" from="dteParams.vendorNameColor ?: 'black'"/>

            <set field="transformParameters" from="[fonoContacto:fonoContacto, mailContacto:mailContacto, oficinaSII:oficinaSII, logo:logo, nroResol:nroResol, fchResol:fchResol, maxItems:'14',
                                                    showItemNumber:'N', commentAfterDetalle:commentAfterDetalle, cuentaBancariaMail:cuentaBancariaMail, cuentaBancariaText:cuentaBancariaText,
                                                    detailHeaderBgColor:detailHeaderBgColor, detailHeaderFgColor:detailHeaderFgColor, detailHeaderSepColor:detailHeaderSepColor, tableBorderColor:tableBorderColor,
                                                    vendorNameColor:vendorNameColor]"/>

            <service-call name="mchile.DTEServices.check#ProductionEnvironment" out-map="context"/>
            <set field="dteSystemIsProduction" from="isProduction"/>
        </actions>
    </service>

    <service verb="genera" noun="PDF">
        <description>
            Genera archivo PDF de Factura/Boleta (envio).
        </description>
        <in-parameters>
            <parameter name="dte" type="Object" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="boleta"/>
            <parameter name="continua"/>
            <parameter name="invoiceMessage"/>
        </in-parameters>
        <out-parameters>
            <parameter name="pdfBytes" type="byte[]"/>
            <parameter name="pdfCedibleBytes" type="byte[]"/>
        </out-parameters>
        <actions>
            <!-- Recuperacion de parametros de la organizacion -->
            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:issuerPartyId]" out-map="context"/>
            <set field="passS" from="passCert"/>
            <set field="template" from="pdfTemplate"/>
            <set field="giro" from="giroEmisor"/>
            <set field="pdfTemplateBoleta" from="pdfTemplateBoleta"/>
            <set field="pdfTemplateBoletaContinua" from="pdfTemplateBoletaContinua"/>

            <if condition="boleta">
                <set field="template" from="pdfTemplateBoleta"/>
                <if condition="continua">
                    <set field="template" from="pdfTemplateBoletaContinua"/>
                </if>
            </if>

            <if condition="!pdfTemplate">
                <return error="true" message="Organización emisora no tiene definida plantilla para generar PDF"/>
            </if>

            <script>
                import java.io.File
                import java.io.FileInputStream
                import javax.sql.rowset.serial.SerialBlob
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate

                import cl.nic.dte.net.ConexionSii
                import cl.nic.dte.util.Utilities
                import cl.sii.siiDte.RECEPCIONDTEDocument
                import javax.xml.transform.stream.StreamSource

                if (invoiceMessage != null) {
                    if (commentAfterDetalle == null) {
                        commentAfterDetalle = invoiceMessage
                        transformParameters.commentAfterDetalle = invoiceMessage
                    } else {
                        commentAfterDetalle = "${commentAfterDetalle}\n${invoiceMessage}"
                        transformParameters.commentAfterDetalle = commentAfterDetalle
                    }
                }

                ByteArrayOutputStream pdf = new ByteArrayOutputStream()

                pages = ec.resource.xslFoTransform(new StreamSource(new ByteArrayInputStream(dte)), new StreamSource(new ByteArrayInputStream(template.getBytes("UTF-8"))), pdf, "application/pdf", transformParameters + [cedible:'false'])
                pdf.close()
                if (pages == null || pages == 0) ec.message.addError("Error generando PDF: páginas generadas: ${pages}")
                pdfBytes = pdf.toByteArray()
            </script>
            <if condition="!boleta">
                <script>
                    pdf = new ByteArrayOutputStream()
                    pages = ec.resource.xslFoTransform(new StreamSource(new ByteArrayInputStream(dte)), new StreamSource(new ByteArrayInputStream(template.getBytes("UTF-8"))), pdf, "application/pdf", transformParameters + [cedible:'true'])
                    pdf.close()
                    if (pages == null || pages == 0) ec.message.addError("Error generando PDF: páginas generadas: ${pages}")
                    pdfCedibleBytes = pdf.toByteArray()
                </script>
            </if>
        </actions>
    </service>

    <service verb="load" noun="Caf">
        <in-parameters>
            <parameter name="filename" type="org.apache.commons.fileupload.FileItem"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <actions>
            <set field="archivo" from="filename.getName()"/>
            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>
            <set field="contentLocation" value="dbresource://moit/erp/dte/caf/${organizationPartyId}/${archivo}"/>

            <set field="docRr" from="ec.resource.getLocationReference(contentLocation)"/>
            <script>
                fileStream = filename.getInputStream()
                try { docRr.putStream(fileStream) } finally { fileStream.close() }
            </script>

            <service-call name="mchile.DTEServices.load#CafInternal" in-map="context+[organizationPartyId:organizationPartyId]" out-map="context"/>
        </actions>
    </service>

    <service verb="load" noun="CafInternal">
        <description>
            Carga CAF en Sistema
        </description>
        <in-parameters>
            <parameter name="contentLocation" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="activateCaf" type="Boolean" default="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="cafId"/>
        </out-parameters>
        <actions>
            <!-- Carga de RUT de empresa -->
            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId" from="organizationPartyId"/>
                <econdition field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find>

            <if condition="!partyIdentificationList.idValue[0]">
                <return error="true" message="Organización $organizationPartyId no tiene RUT definido"/>
            </if>
            <set field="rut" from="partyIdentificationList.idValue[0]"/>


            <!-- Validación rut -->
            <service-call name="mchile.GeneralServices.verify#Rut" in-map="[rut:rut]" out-map="salidaRut"/>
            <set field="rutNoDv" from="salidaRut.rut"/>

            <set field="desde" value=""/>
            <set field="hasta" value=""/>
            <set field="fechaAutorizacion" value=""/>
            <set field="fiscalTaxDocumentTypeEnumId" value=""/>
            <set field="rutCaf" value=""/>

            <script>
                import java.io.ByteArrayOutputStream
                import java.io.File
                import java.io.FileInputStream
                import java.math.BigDecimal
                import java.math.BigInteger
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import java.util.Calendar
                import java.util.Date
                import java.util.HashMap
                import java.text.ParseException
                import java.text.SimpleDateFormat
                import java.util.Date

                import org.apache.xmlbeans.XmlOptions
                import org.w3c.dom.Document

                import cl.nic.dte.util.Signer
                import cl.nic.dte.util.Utilities
                import cl.nic.dte.util.XMLUtil
                import cl.sii.siiDte.AUTORIZACIONDocument
                import cl.sii.siiDte.AutorizacionType
                import cl.sii.siiDte.DTEDefType.Documento.Detalle
                import cl.sii.siiDte.DTEDefType.Documento.Encabezado.IdDoc
                import cl.sii.siiDte.DTEDefType.Documento.Encabezado.Receptor
                import cl.sii.siiDte.DTEDefType.Documento.Encabezado.Totales
                import cl.sii.siiDte.DTEDefType.Documento.Referencia
                import cl.sii.siiDte.DTEDocument
                import cl.sii.siiDte.FechaHoraType
                import cl.sii.siiDte.FechaType
                import cl.sii.siiDte.MedioPagoType

                // Debo meter el namespace porque SII no lo genera
                HashMap&lt;String, String&gt; namespaces = new HashMap&lt;String, String&gt;()
                namespaces.put("", "http://www.sii.cl/SiiDte")
                namespaces.put("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance")
                XmlOptions opts = new XmlOptions()
                opts.setLoadSubstituteNamespaces(namespaces)

                AutorizacionType caf
                docRr = ec.resource.getLocationReference(contentLocation)
                caf = AUTORIZACIONDocument.Factory.parse(docRr.openStream(), opts).getAUTORIZACION()
                desde = caf.getCAF().getDA().getRNG().getD().toString()
                hasta = caf.getCAF().getDA().getRNG().getH().toString()
                fechaAutorizacion = caf.getCAF().getDA().getFA().toString()
                fiscalTaxDocumentTypeEnumId = "Ftdt-${caf.getCAF().getDA().getTD().toString()}"
                rutCaf = caf.getCAF().getDA().getRE()
                logger.warn("===>" + caf.toString())

            </script>

            <if condition="!rutCaf.equals(rut.trim())">
                <return error="true" message="RUT de archivo CAF no corresponde al registrado en el sistema como emisor: $rutCaf :: $rut"/>
            </if>

            <set field="updateMap"
                 from="[filename:docRr.fileName,desde:desde, hasta:hasta, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, fechaAutorizacion:fechaAutorizacion,rut:rut, ultimoFolio:desde, issuerPartyId:organizationPartyId, cafData:docRr.getText()]"/>
            <service-call name="create#mchile.dte.Caf" out-map="context" in-map="updateMap"/>

            <!-- Creación de registros para reservar folios -->
            <script><![CDATA[
                int inicio = Integer.parseInt(desde)
                int fin = Integer.parseInt(hasta)
                for (int folio = inicio; folio <= fin; folio++) {
                    fiscalTaxDocumentId = "$fiscalTaxDocumentTypeEnumId$folio$rutNoDv"
                    createMap = [fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, fiscalTaxDocumentNumber:folio, issuerPartyId:organizationPartyId,
                        issuerPartyIdTypeEnumId:'PtidNationalTaxId', fiscalTaxDocumentStatusEnumId:'Ftdt-NotIssued', fiscalTaxDocumentSentStatusEnumId:'Ftdt-NotSent']
                    context.putAll(ec.service.sync().name("create#mchile.dte.FiscalTaxDocument").parameters(createMap).call())
                }
            ]]></script>
            <if condition="activateCaf"><service-call name="mchile.DTEServices.activar#Caf" in-map="context"/></if>

        </actions>
    </service>

    <service verb="get" noun="Folio">
        <description>
            Obtiene folio para el tipo de DTE especificado.
            Busca el folio más bajo disponible
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="folio" type="Integer"/>
            <parameter name="caf"/>
            <parameter name="cafData"/>
        </out-parameters>
        <actions>


            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId"/>
                <econdition field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find>

            <if condition="!partyIdentificationList.idValue[0]">
                <return error="true" message="Organización $partyId no tiene RUT definido"/>
            </if>
            <set field="rutEmisor" from="partyIdentificationList.idValue[0]"/>

            <!-- Se filtra por CAF activo (PK) para el tipo de DTE -->
            <set field="activo" value="true"/>
            <entity-find-one entity-name="mchile.dte.Caf" value-field="cafEntry" for-update="true">
                <field-map field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <field-map field-name="issuerPartyId" from="partyId"/>
                <field-map field-name="activo" value="true"/>
            </entity-find-one>

            <if condition="!cafEntry">
                <return error="true" message="No existe CAF activo para DTE tipo ${fiscalTaxDocumentTypeEnumId}"/>
            </if>

            <entity-find entity-name="mchile.dte.FiscalTaxDocument" list="reservedList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" value="${fiscalTaxDocumentTypeEnumId}"/>
                <econdition field-name="issuerPartyId" from="partyId"/>
                <econdition field-name="fiscalTaxDocumentNumber" operator="greater-equals" from="cafEntry.desde"/>
                <econdition field-name="fiscalTaxDocumentNumber" operator="less-equals" from="cafEntry.hasta"/>
                <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-NotIssued"/>
                <select-field field-name="fiscalTaxDocumentNumber"/>
                <order-by field-name="fiscalTaxDocumentNumber"/>
            </entity-find>
            <if condition="!reservedList">
                <return error="true" message="No hay folios disponibles para DTE tipo ${fiscalTaxDocumentTypeEnumId} ${cafEntry.desde}-${cafEntry.hasta} - ${cafEntry.filename}"/>
            </if>

            <set field="folio" from="reservedList.first().fiscalTaxDocumentNumber"/>

            <set field="caf" from="cafEntry.filename"/>
            <set field="cafData" from="cafEntry.cafData"/>

        </actions>
    </service>

    <service verb="facturar" noun="Invoice">
        <description>
            Obtiene datos para llamar a método generar#Factura
        </description>
        <in-parameters>
            <parameter name="invoiceId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <!-- Obtención de descuento global, si es > 0 se aplica -->
            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoiceEv">
                <field-map field-name="invoiceId"/>
            </entity-find-one>
            <set field="issuerPartyId" from="invoiceEv.fromPartyId"/>
            <set field="globalDiscount" from="invoiceEv.globalDiscount"/>
            <set field="glosaDr" from="invoiceEv.glosaDr"/>
            <set field="fechaVencimiento" from="invoiceEv.dueDate"/>

            <service-call name="mantle.account.InvoiceServices.get#InvoiceDisplayInfo" in-map="[invoiceId:invoiceId]" out-map="context"/>

            <set field="paymentId" from="paymentApplicationList.paymentId[0]"/>

            <if condition="paymentId">
                <entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment"/>
                <!-- Ajuste de forma de pago -->
                <set field="medioPago" value="OT"/>
                <set field="formaPago" value="3"/>
                <if condition="payment.paymentInstrumentEnumId == 'PiCreditCard'">
                    <set field="medioPago" value="TC"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiCompanyCheck'">
                    <set field="medioPago" value="CH"/>
                    <set field="formaPago" value="1"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiPersonalCheck'">
                    <set field="medioPago" value="CH"/>
                    <set field="formaPago" value="1"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiCompanyCheckDate'">
                    <set field="medioPago" value="CF"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiPersonalCheckDate'">
                    <set field="medioPago" value="CF"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiCash'">
                    <set field="medioPago" value="EF"/>
                    <set field="formaPago" value="1"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiLetra'">
                    <set field="medioPago" value="LT"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiBillingAccount'">
                    <set field="medioPago" value="PE"/>
                    <set field="formaPago" value="1"/>
                </if>
            </if>
            <if condition="!paymentId">
                <set field="medioPago" value="PE"/>
                <set field="formaPago" value="2"/>
            </if>

            <!-- Glosa para pago a credito -->
            <if condition="invoice.settlementTermId">
                <entity-find-one entity-name="mantle.account.invoice.SettlementTerm" value-field="settlementField">
                    <field-map field-name="settlementTermId" from="invoice.settlementTermId"/>
                    <select-field field-name="description"/>
                </entity-find-one>
                <if condition="!settlementField">
                    <return error="true" message="Términos de crédito no existente"/>
                </if>
                <set field="glosaPagos" from="settlementField.description"/>
            </if>
            <if condition="!glosaPagos"><set field="glosaPagos" value=""/></if>

            <!-- Datos principales de invoice -->
            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/>
            <if condition="invoice == null">
                <return error="true" message="Invoice not found with ID ${invoiceId}"/>
            </if>
            <set field="partyId" from="invoice.toPartyId"/>
            <set field="toPartyId" from="invoice.toPartyId"/>

            <!-- Items de invoice -->
            <entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItemList">
                <econdition field-name="invoiceId"/>
                <econdition field-name="itemTypeEnumId" operator="not-in" from="['ItemSalesTax','ItemVatTax']"/>
                <order-by field-name="invoiceItemSeqId"/>
            </entity-find>

            <!-- email receptor -->
            <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:toPartyId]" out-map="context"/>

            <if condition="!emailAddress">
                <if condition="fiscalTaxDocumentTypeEnumId != 'Ftdt-39' &amp;&amp; fiscalTaxDocumentTypeEnumId != 'Ftdt-41'">
                    <return error="true" message="Receptor no tiene dirección de correo, sólo se puede emitir boleta"/>
                </if>
            </if>
            <set field="username" from="emailAddress"/>
            <!-- rut receptor -->
            <set field="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            <entity-find-one entity-name="mantle.party.PartyIdentification" value-field="partyIdentificationEv"/>

            <if condition="!partyIdentificationEv">
                <return error="true" message="Receptor no tiene RUT"/>
            </if>

            <set field="rutReceptor" from="partyIdentificationEv.idValue"/>

            <!-- Datos para encontrar contacto -->
            <entity-find entity-name="mantle.party.contact.PartyContactMech" list="postalPcmList">
                <date-filter/>
                <econdition field-name="partyId"/>
                <econdition field-name="contactMechPurposeId" value="PostalTax"/>
                <order-by field-name="-fromDate"/>
            </entity-find>

            <if condition="!postalPcmList">
                <return error="true" message="Receptor ${partyId} no tiene dirección postal tributaria"/>
            </if>
            <set field="contactMechId" from="postalPcmList[0].contactMechId"/>

            <!-- Datos de contacto -->
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="contactPostalAddressField"/>
            <if condition="!contactPostalAddressField">
                <return message="Receptor ${partyId} no tiene dirección postal para impuestos" error="true"/>
            </if>
            <set field="dirReceptor" value="${contactPostalAddressField.address1?:''}${contactPostalAddressField.unitNumber? (' ' + contactPostalAddressField.unitNumber) : ''}"/>
            <!-- Comuna -->
            <entity-find-one entity-name="moqui.basic.Geo" value-field="geoField">
                <field-map field-name="geoId" from="contactPostalAddressField.stateProvinceGeoId"/>
            </entity-find-one>

            <set field="cmnaReceptor" from="geoField.geoName"/>

            <set field="ciudadReceptor" from="contactPostalAddressField.city?:''"/>
            <!-- ID Contacto receptor -->
            <set field="receptorContactId" from="contactPostalAddressField.telecomContactMechId"/>

            <entity-find-one entity-name="mantle.party.Party" value-field="partyEv"/>
            <set field="partyTypeEnumId" from="partyEv.partyTypeEnumId"/>
            <set field="rznSocReceptor" value=""/>
            <set field="giroReceptor" value="Sin Giro"/>
            <if condition="partyTypeEnumId == 'PtyOrganization'">
                <!-- email -->
                <entity-find entity-name="mantle.party.contact.PartyContactMech" list="contactMechList">
                    <econdition field-name="partyId" from="partyId"/>
                    <econdition field-name="contactMechPurposeId" value="PostalTax"/>
                    <econdition field-name="fromDate" operator="less-equals" from="ec.user.nowTimestamp"/>
                    <econdition field-name="thruDate" from="null"/>
                </entity-find>

                <if condition="!contactMechList">
                    <return error="true" message="Receptor no tiene dirección para impuestos"/>
                </if>
                <set field="contactMechId" from="contactMechList.contactMechId.first()"/>

                <!-- Organizacion -->
                <entity-find-one entity-name="mantle.party.Organization" value-field="organizationField"/>
                <set field="rznSocReceptor" from="organizationField.taxOrganizationName ?: organizationField.organizationName"/>

                <service-call name="mchile.DTEServices.get#GiroPrimario" in-map="[partyId:toPartyId]" out-map="giroOutMap"/>
                <set field="giroReceptor" from="giroOutMap.description"/>

                <!-- Obtención de contacto para impuestos en organización -->

                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="contactOut"
                              in-map="[partyId:partyId, postalContactMechPurposeId:'PostalTax']"/>
                <if condition="!contactOut.postalContactMechId">
                    <return error="true" message="Receptor no tiene contacto tributario asignado"/>
                </if>
                <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddressField">
                    <field-map field-name="contactMechId" from="contactOut.postalContactMechId"/>
                </entity-find-one>
                <!-- Obtención de contacto en organización -->
                <if condition="!postalAddressField">
                    <return error="true" message="Nombre receptor no encontrado"/>
                </if>

                <set field="contactoReceptor" from="postalAddressField.toName"/>

            </if>
            <if condition="partyTypeEnumId == 'PtyPerson'">
                <!-- email -->
                <!--service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:fromPartyId]" out-map="context"/>
                <set field="contactMechId" from="emailAddress"/-->

                <!-- Persona Natural -->
                <entity-find-one entity-name="mantle.party.Person" value-field="personField"/>
                <if condition="!personField">
                    <return error="true" message="No existe persona para facturar"/>
                </if>

                <set field="rznSocReceptor" from="personField.firstName"/>
                <script>
                    rznSocReceptor = rznSocReceptor + " " + personField.lastName
                </script>
                <set field="contactoReceptor" from="rznSocReceptor"/>
            </if>

            <!-- Recuperación de referencias -->
            <entity-find entity-name="mchile.dte.ReferenciaDteAndFiscalCode" list="referenciaList">
                <econdition field-name="invoiceId" from="invoiceId"/>
                <order-by field-name="fiscalTaxDocumentTypeEnumId"/>
            </entity-find>
            <if condition="(fiscalTaxDocumentTypeEnumId == 'Ftdt-39') || (fiscalTaxDocumentTypeEnumId == 'Ftdt-41')">
                <then>
                    <!-- Generacion de boletas -->
                    <service-call name="mchile.DTEServices.genera#Boleta" in-map="[fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, issuerPartyId:issuerPartyId,
                                        rutReceptor:rutReceptor, rznSocReceptor:rznSocReceptor, giroReceptor:giroReceptor, contactoReceptor:contactoReceptor,
                                        dirReceptor:dirReceptor, cmnaReceptor:cmnaReceptor, ciudadReceptor:ciudadReceptor, detailList:invoiceItemList,
                                        invoiceId:invoiceId, formaPago:formaPago, medioPago:medioPago, referenciaList:referenciaList, receiverPartyId:toPartyId]"
                                  out-map="context"/>
                </then>
                <else>
                    <!-- Generacion de factura -->
                    <service-call name="mchile.DTEServices.genera#Factura" in-map="[fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, issuerPartyId:issuerPartyId,
                                        rutReceptor:rutReceptor, rznSocReceptor:rznSocReceptor, giroReceptor:giroReceptor, contactoReceptor:contactoReceptor,
                                        dirReceptor:dirReceptor, cmnaReceptor:cmnaReceptor, ciudadReceptor:ciudadReceptor, detailList:invoiceItemList,
                                        invoiceMessage:invoice.invoiceMessage, invoiceId:invoiceId, formaPago:formaPago, medioPago:medioPago, referenciaList:referenciaList,
                                        receiverPartyId:toPartyId, globalDiscount:globalDiscount, glosaDr:glosaDr, glosaPagos:glosaPagos, settlementTermId:settlementTermId,
                                        fechaVencimiento:fechaVencimiento]" out-map="context"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="boletear" noun="Invoice">
        <description>
            Obtiene datos para llamar a método generar#Factura
        </description>
        <in-parameters>
            <parameter name="invoiceId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="items"/>
            <parameter name="continua"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <!-- Obtención de descuento global, si es > 0 se aplica -->
            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoiceEv">
                <field-map field-name="invoiceId" from="invoiceId"/>
            </entity-find-one>
            <set field="organizationPartyId" from="invoiceEv.fromPartyId"/>
            <set field="globalDiscount" from="invoiceEv.globalDiscount"/>
            <set field="glosaDr" from="invoiceEv.glosaDr"/>

            <set field="listItems" type="List"/>
            <if condition="items">
                <set field="listItems" from="items instanceof List ? items : items.split(',') as List"/>
            </if>
            <iterate list="listItems" entry="detailItem">
                <set field="listProduct" from="detailItem instanceof List ? detailItem : detailItem.split('-') as List"/>
                <log message="Leyendo: $listProduct" level="warn"/>
                <!-- Con invoiceId se busca en invoiceItem y se actualiza porcentaje de descuento -->
                <entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItemField">
                    <field-map field-name="invoiceId" from="invoiceId"/>
                    <field-map field-name="invoiceItemSeqId" value="${listProduct[0]}"/>
                </entity-find-one>
                <script>
                    long discount = Long.valueOf(listProduct[3])
                </script>
                <set field="invoiceItemField.pctDiscount" from="discount"/>
                <entity-update value-field="invoiceItemField"/>
            </iterate>

            <service-call name="mantle.account.InvoiceServices.get#InvoiceDisplayInfo" in-map="[invoiceId:invoiceId]" out-map="context"/>

            <set field="paymentId" from="paymentApplicationList.paymentId[0]"/>

            <if condition="paymentId">
                <entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment"/>
                <!-- Ajuste de forma de pago -->
                <set field="medioPago" value="OT"/>
                <set field="formaPago" value="3"/>
                <if condition="payment.paymentInstrumentEnumId == 'PiCreditCard'">
                    <set field="medioPago" value="TC"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiCompanyCheck'">
                    <set field="medioPago" value="CH"/>
                    <set field="formaPago" value="1"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiPersonalCheck'">
                    <set field="medioPago" value="CH"/>
                    <set field="formaPago" value="1"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiCompanyCheckDate'">
                    <set field="medioPago" value="CF"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiPersonalCheckDate'">
                    <set field="medioPago" value="CF"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiCash'">
                    <set field="medioPago" value="EF"/>
                    <set field="formaPago" value="1"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiLetra'">
                    <set field="medioPago" value="LT"/>
                    <set field="formaPago" value="2"/>
                </if>
                <if condition="payment.paymentInstrumentEnumId == 'PiBillingAccount'">
                    <set field="medioPago" value="PE"/>
                    <set field="formaPago" value="1"/>
                </if>
            </if>
            <if condition="!paymentId">
                <set field="medioPago" value="CH"/>
                <set field="formaPago" value="1"/>
            </if>

            <!-- Datos principales de invoice -->
            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/>
            <if condition="invoice == null">
                <return error="true" message="Invoice not found with ID ${invoiceId}"/>
            </if>
            <set field="partyId" from="invoice.toPartyId"/>
            <set field="toPartyId" from="invoice.toPartyId"/>

            <!-- Items de invoice -->
            <entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItemList">
                <econdition field-name="invoiceId"/>
                <econdition field-name="itemTypeEnumId" operator="not-in" from="['ItemSalesTax','ItemVatTax']"/>
                <order-by field-name="invoiceItemSeqId"/>
            </entity-find>

            <!-- email receptor -->
            <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:toPartyId]" out-map="context"/>

            <if condition="!emailAddress">
                <log level="warn" message="Receptor no tiene dirección de correo"/>
            </if>
            <set field="username" from="emailAddress"/>
            <!-- rut receptor -->
            <set field="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            <entity-find-one entity-name="mantle.party.PartyIdentification" value-field="partyIdentificationEv"/>

            <set field="rutReceptor" value="66666666-6"/>
            <if condition="!partyIdentificationEv">
                <then>
                    <!--return error="true" message="Receptor no tiene RUT"/-->
                    <log level="warn" message="Receptor de boleta para invoice $invoiceId sin RUT"/>
                </then>
                <else>
                    <set field="rutReceptor" from="partyIdentificationEv.idValue"/>
                </else>
            </if>

            <!-- Datos para encontrar contacto -->
            <entity-find entity-name="mantle.party.contact.PartyContactMech" list="postalPcmList">
                <date-filter/>
                <econdition field-name="partyId"/>
                <econdition field-name="contactMechPurposeId" value="PostalTax"/>
                <order-by field-name="-fromDate"/>
            </entity-find>

            <if condition="!postalPcmList">
                <return error="true" message="Receptor ${partyId} no tiene dirección postal para impuestos"/>
            </if>
            <set field="contactMechId" from="postalPcmList[0].contactMechId"/>


            <!-- Datos de contacto -->
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="contactPostalAddressField"/>
            <if condition="!contactPostalAddressField">
                <log level="warn" message="Receptor no tiene dirección postal"/>
            </if>
            <set field="dirReceptor"/>
            <if condition="contactPostalAddressField">
                <set field="dirReceptor" from="contactPostalAddressField.address1"/>
                <script>
                    dirReceptor = dirReceptor + " " + contactPostalAddressField.unitNumber
                </script>
            </if>


            <set field="cmnaReceptor"/>
            <set field="ciudadReceptor"/>
            <set field="receptorContactId"/>
            <!-- Comuna -->
            <if condition="contactPostalAddressField">
                <entity-find-one entity-name="moqui.basic.Geo" value-field="geoField">
                    <field-map field-name="geoId" from="contactPostalAddressField.stateProvinceGeoId"/>
                </entity-find-one>

                <set field="cmnaReceptor" from="geoField.geoName"/>
                <set field="ciudadReceptor" from="contactPostalAddressField.city"/>
                <set field="receptorContactId" from="contactPostalAddressField.telecomContactMechId"/>
            </if>


            <!-- Party puede ser Organization o Persona -->
            <entity-find-one entity-name="mantle.party.Party" value-field="partyEv"/>
            <set field="partyTypeEnumId" from="partyEv.partyTypeEnumId"/>

            <set field="rznSocReceptor" value=""/>
            <set field="giroReceptor" value="Sin Giro"/>

            <if condition="partyTypeEnumId == 'PtyOrganization'">
                <!-- email -->
                <entity-find entity-name="mantle.party.contact.PartyContactMech" list="contactMechList">
                    <econdition field-name="partyId" from="partyId"/>
                    <econdition field-name="contactMechPurposeId" value="PostalTax"/>
                    <econdition field-name="fromDate" operator="less-equals" from="ec.user.nowTimestamp"/>
                    <econdition field-name="thruDate" from="null"/>
                </entity-find>

                <if condition="!contactMechList">
                    <return error="true" message="Receptor no tiene dirección para impuestos"/>
                </if>
                <set field="contactMechId" from="contactMechList.contactMechId.first()"/>


                <!-- Organizacion -->
                <entity-find-one entity-name="mantle.party.Organization" value-field="organizationField"/>
                <set field="rznSocReceptor" from="organizationField.organizationName"/>
                <!-- Giro no es necesario en boleta -->
                <set field="giroReceptor" value=""/>
                <!-- Obtención de contacto para impuestos en organización -->
                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="contactOut"
                              in-map="[partyId:partyId, postalContactMechPurposeId:'PostalTax']"/>
                <if condition="!contactOut.postalContactMechId">
                    <return error="true" message="Receptor no tiene contacto tributario asignado"/>
                </if>
                <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddressField">
                    <field-map field-name="contactMechId" from="contactOut.postalContactMechId"/>
                </entity-find-one>
                <!-- Obtención de contacto en organización -->
                <if condition="!postalAddressField">
                    <return error="true" message="Nombre receptor no encontrado"/>
                </if>

                <set field="contactoReceptor" from="postalAddressField.toName"/>

            </if>
            <if condition="partyTypeEnumId == 'PtyPerson'">
                <!-- email -->
                <!--service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:fromPartyId]" out-map="context"/>
                <set field="contactMechId" from="emailAddress"/-->

                <!-- Persona Natural -->
                <entity-find-one entity-name="mantle.party.Person" value-field="personField"/>
                <if condition="!personField">
                    <return error="true" message="No existe persona para facturar"/>
                </if>

                <set field="rznSocReceptor" from="personField.firstName"/>
                <script>
                    rznSocReceptor = rznSocReceptor + " " + personField.lastName
                </script>
                <set field="contactoReceptor" from="rznSocReceptor"/>
            </if>
            <!-- Recuperación de referencias -->
            <entity-find entity-name="mchile.dte.ReferenciaDteAndFiscalCode" list="referenciaList">
                <econdition field-name="invoiceId" from="invoiceId"/>
                <order-by field-name="fiscalTaxDocumentTypeEnumId"/>
            </entity-find>

            <!-- TODO: Generación de Boletas -->
            <!-- Generacion de boletas -->
            <service-call name="mchile.DTEServices.genera#Boleta" in-map="[fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, issuerPartyId:issuerPartyId, rutReceptor:rutReceptor, rznSocReceptor:rznSocReceptor, giroReceptor:giroReceptor,
                          contactoReceptor:contactoReceptor, dirReceptor:dirReceptor, cmnaReceptor:cmnaReceptor, ciudadReceptor:ciudadReceptor, detailList:invoiceItemList,
                          invoiceId:invoiceId, formaPago:formaPago, medioPago:medioPago, referenciaList:referenciaList, receiverPartyId:toPartyId, continua:continua]" out-map="context"/>
        </actions>
    </service>

    <service verb="activar" noun="Caf">
        <description>
            Activa CAF para ser usado
        </description>
        <in-parameters>
            <parameter name="cafId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.Caf" value-field="cafField" for-update="true"/>

            <if condition="!cafField">
                <return error="true" message="No existe CAF"/>
            </if>

            <set field="cafField.activo" value="true"/>
            <entity-update value-field="cafField"/>
        </actions>
    </service>

    <service verb="desactivar" noun="Caf">
        <description>
            Desactiva CAF para no ser usado
        </description>
        <in-parameters>
            <parameter name="cafId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.Caf" value-field="cafField" for-update="true"/>

            <if condition="!cafField">
                <return error="true" message="No existe CAF"/>
            </if>

            <set field="cafField.activo" value=""/>
            <entity-update value-field="cafField"/>
        </actions>
    </service>


    <service verb="preparaEnvio" noun="Documentos">
        <description>
            Obtiene datos para llamar a servicio enviar#Documento
        </description>
        <in-parameters>
            <parameter name="documentIds" type="List" required="true"/>
            <parameter name="libro"/>
            <parameter name="boleta"/>
        </in-parameters>
        <actions>
            <if condition="documentIds.size() &lt; 1"><return error="true" message="Debe seleccionar al menos 1 DTE para enviar"/></if>
            <entity-find entity-name="mchile.dte.FiscalTaxDocument" list="dteList">
                <econdition field-name="fiscalTaxDocumentId" operator="in" from="documentIds"/>
            </entity-find>

            <iterate list="dteList" entry="dte">
                <if condition="issuerPartyId == null"><then>
                    <set field="issuerPartyId" from="dte.issuerPartyId"/>
                </then><else-if condition="dte.issuerPartyId != issuerPartyId">
                    <return error="true" message="No se pueden enviar simultáneamente DTEs de distintos emisores"/>
                </else-if></if>
            </iterate>
            <service-call name="moit.erp.GeneralServices.setup#UserInfo" out-map="context"/>
            <if condition="!(issuerPartyId in userOrgIds)"><return error="true" message="Usuario no tiene autorización para enviar DTEs a nombre de partyId ${issuerPartyId}"/></if>

            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:issuerPartyId]" out-map="context"/>

            <if condition="!libro &amp;&amp; !boleta"><then>
                <service-call name="mchile.DTEServices.generaEnvio#Documentos" in-map="[organizationPartyId:issuerPartyId, documentIdList:documentIds]" out-map="context"/>
                <log message="generaEnvio OK, now enviaSII#Documento"/>
                <service-call name="mchile.DTEServices.enviaSII#Documento" in-map="[rutOrganizacion:rutEmisor, documentLocation:xmlContentLocation, organizationPartyId:issuerPartyId]" out-map="context"/>
                <if condition="trackId">
                    <service-call name="mchile.DTEServices.marcarEnviados#Documentos" in-map="[trackId:trackId, documentIdList:documentIds]"/>
                </if>
            </then><else-if condition="boleta">
                <service-call name="mchile.DTEServices.generaEnvio#Boletas" in-map="[recepS:recepS, organizationPartyId:issuerPartyId, enviadorS:rutEnvia, documentIdList:documentIdList ]" out-map="context"/>
                <set field="documentoS" from="archivoEnvio"/>
                <service-call name="mchile.DTEServices.enviaSII#Boleta" in-map="[rutOrganizacion:rutEnvia, rutEnviador:rutEnvia , documentoS:documentoS, organizationPartyId:issuerPartyId]" out-map="context"/>
                <if condition="trackId">
                    <service-call name="mchile.DTEServices.marcarEnviados#Boletas" in-map="[trackId:trackId, documentIdList:documentIdList]"/>
                </if>
            </else-if></if>

            <if condition="libro">
                <iterate list="documentList" entry="libroEntry">
                    <set field="detailLibro" from="libroEntry instanceof List ? libroEntry : libroEntry.split('-') as List"/>
                    <set field="fiscalTaxDocumentId" from="detailLibro[0]"/>
                    <log level="warn" message="fiscalTaxDocumentId: $fiscalTaxDocumentId"/>
                    <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="libroField">
                        <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                    </entity-find-one>
                    <set field="xml" from="libroField.xml"/>

                    <service-call name="mchile.DTEServices.generaEnvio#Libro" in-map="[enviadorS:rutEnvia, organizationPartyId:issuerPartyId, idS:'ID178', xml:xml ]" out-map="context"/>
                    <set field="documentoS" from="archivoEnvio"/>

                    <service-call name="mchile.DTEServices.enviaSII#Documento" in-map="[documentoS:xml, organizationPartyId:issuerPartyId]" out-map="context"/>
                </iterate>
            </if>
        </actions>
    </service>


    <service verb="verificaEnSII" noun="Documento">
        <description>
            Verificación en el SII de DTE ya enviado
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="statusSii" required="true"/>
            <parameter name="salida" required="true"/>
        </out-parameters>
        <actions>

            <set field="statusSii" value=""/>

            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>

            <service-call name="mchile.DTEServices.get#DteContent"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml']" out-map="context"/>

            <if condition="!content">
                <return error="true" message="DTE no existe"/>
            </if>
            <set field="envio" from="content"/>

            <set field="salida" value=""/>
            <set field="statusXML" value=""/>

            <script>
                import java.io.FileInputStream
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import java.util.HashMap

                import org.apache.xmlbeans.XmlOptions

                import cl.nic.dte.net.ConexionSii
                import cl.nic.dte.util.Utilities
                import cl.sii.siiDte.DTEDocument
                import cl.sii.xmlSchema.RESPUESTADocument

                HashMap&lt;String, String&gt; namespaces = new HashMap&lt;String, String&gt;()
                namespaces.put("", "http://www.sii.cl/SiiDte")
                XmlOptions opts = new XmlOptions()
                opts.setLoadSubstituteNamespaces(namespaces)

                //DTEDocument doc = DTEDocument.Factory.parse(new FileInputStream(envio), opts)
                DTEDocument doc = DTEDocument.Factory.parse(contentRef.openStream(), opts)
                ConexionSii con = new ConexionSii()

                String token = con.getToken(pkey, certificate)

                System.out.println("Enviador: " + rutEnvia + ", token: " + token)

                RESPUESTADocument resp
                if (dteSystemIsProduction)
                    resp = con.getEstadoDTEProduccion(rutEnvia, doc.getDTE().getDocumento(), token)
                else
                    resp = con.getEstadoDTECertificacion(rutEnvia, doc.getDTE().getDocumento(), token)
                opts.setSavePrettyPrintIndent(2)
                opts.setSavePrettyPrint()
                resp.save(System.out, opts)

                logger.warn("------" + resp.toString())

                salida = resp.toString()
                statusXML = salida
                String status = "0"

                int inicio = statusXML.indexOf("&lt;SII:ESTADO&gt;")
                int fin = statusXML.indexOf("&lt;/SII:ESTADO&gt;")

                statusXML = statusXML.substring(inicio+12,fin)
                logger.warn("STATUS: " + statusXML)
                statusSii = statusXML

                inicio = salida.indexOf("&lt;SII:GLOSA_ERR&gt;")
                fin = salida.indexOf("&lt;/SII:GLOSA_ERR&gt;")
                salida = salida.substring(inicio+15, fin)

            </script>
            <set field="statusSii" from="statusXML"/>
        </actions>
    </service>

    <service verb="verificaEnSII" noun="Boleta">
        <description>
            Verificación en el SII de boleta usando rut empresa, tipo y folio
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="salida" required="true"/>
        </out-parameters>
        <actions>
            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>
            <set field="certData" from="certData"/>
            <set field="passS" from="passCert"/>

            <service-call name="mchile.DTEServices.get#DteContent"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml']" out-map="context"/>

            <if condition="!content">
                <return error="true" message="DTE no existe"/>
            </if>
            <set field="envio" from="content"/>

            <set field="salida" value=""/>
            <set field="statusXML" value=""/>

            <set field="tipo" value="39"/>
            <if condition="fiscalTaxDocumentTypeEnumId.equals('Ftdt-41')">
                <set field="tipo" value="41"/>
            </if>

            <!-- Recuperar folio -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="boletaField">
                <select-field field-name="fiscalTaxDocumentNumber"/>
                <select-field field-name="receiverPartyId"/>
                <select-field field-name="receiverPartyIdTypeEnumId"/>
            </entity-find-one>
            <set field="folio" from="boletaField.fiscalTaxDocumentNumber"/>
            <set field="receiverPartyId" from="boletaField.receiverPartyId"/>
            <set field="receiverPartyIdTypeEnumId" from="boletaField.receiverPartyIdTypeEnumId"/>
            <set field="invoiceId" from="boletaField.invoiceId"/>


            <!-- Recuperacion de rut receptor -->
            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId" from="receiverPartyId"/>
                <econdition field-name="partyIdTypeEnumId" from="receiverPartyIdTypeEnumId"/>
            </entity-find>
            <if condition="!partyIdentificationList.idValue[0]">
                <return error="true" message="No existe organización receptora definida en el sistema"/>
            </if>
            <set field="rutReceptor" from="partyIdentificationList.idValue[0]"/>

            <!-- Obtencion de monto desde invoiceId -->
            <set field="monto" value="0"/>
            <set field="fechaEmision" value="23-11-2020"/>

            <!-- Recuperacion de xml para parsear -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="contentField">
                <select-field field-name="contentLocation"/>
            </entity-find-one>
            <if condition="!contentField">
                <return error="true" message="Boleta no tiene XML generado"/>
            </if>
            <set field="xmlDataRef" from="ec.resource.getLocationReference(contentField.contentLocation)"/>
            <script>
                import javax.xml.parsers.*
                import org.w3c.dom.*
                import java.text.DateFormat
                import java.text.SimpleDateFormat
                import java.util.Date

                DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance()
                DocumentBuilder builder = null
                Document document = null

                builder = factory.newDocumentBuilder()
                document = builder.parse(xmlDataRef.openStream())
                document.getDocumentElement().normalize()
                Element root = document.getDocumentElement()

                NodeList nList = document.getElementsByTagName("MntTotal")
                monto = nList.item(0).getTextContent()

                nList = document.getElementsByTagName("FchEmis")
                fechaEmision = nList.item(0).getTextContent()

                // Formateo de fecha desde YYYY-MM-DD a DD-MM-YYYY
                SimpleDateFormat sourceFmt = new SimpleDateFormat("yyyy-MM-dd")
                SimpleDateFormat targetFmt = new SimpleDateFormat("dd-MM-yyyy")

                Date date1 = sourceFmt.parse(fechaEmision)
                fechaEmision = targetFmt.format(date1)

            </script>

            <script>
                import java.io.FileInputStream
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import java.util.HashMap
                import org.apache.xmlbeans.XmlOptions
                import cl.nic.dte.net.ConexionSiiBoleta
                import cl.nic.dte.util.Utilities
                import org.json.simple.JSONObject

                ConexionSiiBoleta con = new ConexionSiiBoleta()

                String token = con.getToken(pkey, certificate)

                System.out.println("Folio: " + folio + ", token: " + token)

                // Ejecutar GET https://apicert.sii.cl/boleta.electronica.envio/{rut}-{dv}-{trackid}
                // Se obtiene objeto JSON
                JSONObject resp
                if (dteSystemIsProduction)
                    resp = con.getEstadoBOLETAProduccion(rutEmisor, rutReceptor, monto, fechaEmision, folio, tipo, token)
                else
                    resp = con.getEstadoBOLETACertificacion(rutEmisor, rutReceptor, monto, fechaEmision, folio, tipo, token)

                //String estado = (String) recp.get("estado")

                salida = resp.toString()
                logger.warn("Salida JSON: " + salida)
            </script>
        </actions>
    </service>

    <service verb="verificaEnvioSII" noun="Boleta">
        <description>
            <!-- TODO -->
            Verificación en el SII de envio con rut y trackid
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="trackId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="salida" required="true"/>
        </out-parameters>
        <actions>
            <set field="statusSii" value=""/>

            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:organizationPartyId]" out-map="context"/>
            <set field="certData" from="certData"/>
            <set field="passS" from="passCert"/>

            <service-call name="mchile.DTEServices.get#DteContent"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml']" out-map="context"/>

            <if condition="!content">
                <return error="true" message="DTE no existe"/>
            </if>
            <set field="envio" from="content"/>

            <set field="salida" value=""/>
            <set field="statusXML" value=""/>

            <script>
                import java.io.FileInputStream
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import java.util.HashMap
                import org.apache.xmlbeans.XmlOptions
                import cl.nic.dte.net.ConexionSiiBoleta
                import cl.nic.dte.util.Utilities
                import org.json.simple.JSONObject

                ConexionSiiBoleta con = new ConexionSiiBoleta()

                String token = con.getToken(pkey, certificate)
                String enviadorS = Utilities.getRutFromCertificate(certificate)

                System.out.println("Enviador: " + rutEnvia + ", token: " + token)

                // Ejecutar GET https://apicert.sii.cl/boleta.electronica.envio/{rut}-{dv}-{trackid}
                // Se obtiene objeto JSON
                JSONObject resp
                if (dteSystemIsProduction)
                    resp = con.getEstadoEnvioBOLETAProduccion(rutEmisor, trackId, token)
                else
                    resp = con.getEstadoEnvioBOLETACertificacion(rutEmisor, trackId, token)

                //String estado = (String) recp.get("estado")
                //trackId = String.valueOf(recp.get("trackid"))

                salida = resp.toString()
                logger.warn("Salida JSON: " + salida)
            </script>
        </actions>
    </service>

    <service verb="preLoad" noun="Dte">
        <description>
            Servicio para simplificar carga de Facturas vs Boletas discriminando por los dos grandes tipos antes de parsear el XML
        </description>
        <in-parameters>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="invoiceId"/>
            <parameter name="xml" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="pdf" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="productMatch" default-value="false"/>
            <parameter name="fiscalTaxDocumentAggrEnumId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <actions>
            <if condition="fiscalTaxDocumentAggrEnumId == 'Ftdt-Boletas'">
                <then>
                    <service-call name="mchile.DTEServices.load#Boleta" in-map="[xml:xml, pdf:pdf, organizationPartyId:organizationPartyId, productMatch:productMatch, organizationPartyId:organizationPartyId]"/>
                </then>
                <else>
                    <service-call name="mchile.DTEServices.load#Dte" in-map="[xml:xml, pdf:pdf, organizationPartyId:organizationPartyId, productMatch:productMatch, organizationPartyId:organizationPartyId, invoiceId:invoiceId]"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="load" noun="Boleta" type="script" location="component://MoquiChile/service/mchile/DTEServices/loadBoleta.groovy">
        <description>
            Carga boleta en XML recibida por la organización
        </description>
        <in-parameters>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="invoiceId"/>
            <parameter name="xml" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="pdf" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="productMatch" default-value="false"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
    </service>

    <service verb="load" noun="Dte" type="script" location="component://MoquiChile/service/mchile/DTEServices/loadDte.groovy">
        <description>
            Carga DTE recibida al sistema y llama a servicio que crea orden de compra + invoice correspondiente
        </description>
        <in-parameters>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="invoiceId"/>
            <parameter name="xml" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="pdf" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="productMatch" default-value="false"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
    </service>

    <service verb="marcarNoEnviado" noun="Documento">
        <description>
            Marca una DTE como no enviada al SII
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="dteEv" for-update="true">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>

            <if condition="!dteEv">
                <return error="true" message="No existe DTE especificada"/>
            </if>

            <set field="dteEv.fiscalTaxDocumentSentStatusEnumId" value="Ftdt-NotSent"/>
            <entity-update value-field="dteEv"/>
        </actions>
    </service>

    <service verb="marcarEnviado" noun="Documento">
        <description>
            Marca una DTE como ya enviada al SII
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="dteEv" for-update="true">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>

            <if condition="!dteEv">
                <return error="true" message="No existe DTE especificada"/>
            </if>

            <set field="dteEv.fiscalTaxDocumentSentStatusEnumId" value="Ftdt-Sent"/>
            <entity-update value-field="dteEv"/>
        </actions>
    </service>

    <service verb="create" noun="DteFromUrl">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="invoiceId" required="true"/>
            <parameter name="contentLocation" required="true"/>
            <parameter name="contentDate" required="true"/>
            <parameter name="issuerPartyId"/>
            <parameter name="receiverPartyId"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fiscalTaxDocumentContentTypeEnumId" default="Ftdct-Pdf"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <log message="[create#DteFromFile] Reading tax document from ${contentLocation}"/>
            <script><![CDATA[
                        URL url = new URL(contentLocation)
                        URLConnection hc = url.openConnection()
                        hc.setRequestProperty("User-Agent", "Mozilla/5.0")
                        byte[] contentFile
                        if (hc.getResponseCode().equals(200)) {
                            contentFile = hc.getInputStream().getBytes()
                        }
                    ]]></script>

            <log message="[create#DteFromFile] orderId: ${orderId}"/>

            <set field="fiscalTaxDocumentNumber" from="orderId"/>

            <entity-find entity-name="mantle.order.OrderHeaderAndPart" list="orderList" distinct="true">
                <econdition field-name="orderId" from="orderId"/>
            </entity-find>
            <set field="order" from="orderList?.first"/>

            <set field="issuerPartyId" from="issuerPartyId ? issuerPartyId : order.vendorPartyId"/>
            <set field="receiverPartyId" from="receiverPartyId ? receiverPartyId : order.customerPartyId"/>

            <set field="createMap" from="[issuerPartyId:issuerPartyId, issuerPartyIdTypeEnumId:'PtidNationalTaxId', fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber,
                                          fiscalTaxDocumentStatusEnumId:'Ftdt-Issued', receiverPartyId:receiverPartyId, receiverPartyIdTypeEnumId:'PtidNationalTaxId', date:contentDate, invoiceId:invoiceId]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocument" out-map="context" in-map="createMap"/>
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[partyId:issuerPartyId]" out-map="issuerRut"/>
            <set field="pdfContentLocation" value="dbresource://moit/erp/dte/${issuerRut?.rutSinFormato?:issuerPartyId}/DTE-${fiscalTaxDocumentTypeEnumId}-${fiscalTaxDocumentNumber}.pdf"/>
            <set field="createMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Pdf', contentLocation:pdfContentLocation, contentDate:contentDate]"/>
            <script>ec.resource.getLocationReference(pdfContentLocation).putBytes(contentFile)</script>
            <service-call name="create#mchile.dte.FiscalTaxDocumentContent" out-map="context" in-map="createMap"/>

            <set field="updateMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, emailEmisor:emailEmisor, amount:amount,
                                                 montoNeto:montoNeto, tasaImpuesto:tasaImpuesto, tipoImpuesto:tipoImpuesto, razonSocial:razonSocial, fechaEmision:fechaEmision, documentoAnulado:documentoAnulado,
                                                 montoExento:montoExento, montoIVARecuperable:montoIVARecuperable, codigoIVANoRecuperable:codigoIVANoRecuperable, montoIVANoRecuperable:montoIVANoRecuperable,
                                                 montoIVAUsoComun:montoIVAUsoComun, codigoOtroImpuestoORetencion:codigoOtroImpuestoORetencion, tasaOtroImpuestoORetencion:tasaOtroImpuestoORetencion,
                                                 montoOtroImpuestoORetencionConCredito:montoOtroImpuestoORetencionConCredito, montoOtroImpuestoORetencionSinCredito:montoOtroImpuestoORetencionSinCredito,
                                                 montoNetoActivoFijo:montoNetoActivoFijo, montoIVAActivoFijo:montoIVAActivoFijo, montoIVANoRetenido:montoIVANoRetenido, codigoSucursal:codigoSucursal,
                                                 notasDebitoCreditoFacturasCompra:notasDebitoCreditoFacturasCompra]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocumentAttributes" out-map="context" in-map="updateMap"/>

        </actions>
    </service>

    <service verb="load" noun="Dt">
        <description>
            Carga documento tributario en papel recibido de tercero
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentNumber" required="true"/>
            <parameter name="invoiceId"/>
            <parameter name="pdf" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="amount" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="montoNeto"/>
            <parameter name="tasaImpuesto"/>
            <parameter name="tipoImpuesto"/>
            <!--parameter name="razonSocial"/-->
            <parameter name="fechaEmision" required="true"/>
            <parameter name="documentoAnulado"/>
            <parameter name="montoExento"/>
            <parameter name="montoIVARecuperable"/>
            <parameter name="codigoIVANoRecuperable"/>
            <parameter name="montoIVANoRecuperable"/>
            <parameter name="montoIVAUsoComun"/>
            <parameter name="codigoOtroImpuestoORetencion"/>
            <parameter name="tasaOtroImpuestoORetencion"/>
            <parameter name="montoOtroImpuestoORetencionConCredito"/>
            <parameter name="montoOtroImpuestoORetencionSinCredito"/>
            <parameter name="montoNetoActivoFijo"/>
            <parameter name="montoIVAActivoFijo"/>
            <parameter name="montoIVANoRetenido"/>
            <parameter name="codigoSucursal"/>
            <parameter name="notasDebitoCreditoFacturasCompra"/>
            <parameter name="receiverPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <set field="archivoPdf" from="pdf.getName()"/>
            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:receiverPartyId]" out-map="context"/>

            <script>
                import java.io.ByteArrayOutputStream
                import java.io.File
                import java.io.FileInputStream
                import java.math.BigDecimal
                import java.math.BigInteger
                import java.nio.file.Files
                import java.nio.file.Path
                import java.nio.file.Paths
                import java.security.KeyStore
                import java.security.PrivateKey
                import java.security.cert.X509Certificate
                import java.util.Calendar
                import java.util.Date
                import java.text.DateFormat
                import java.util.HashMap
                import java.text.ParseException
                import java.text.SimpleDateFormat
                import java.util.Date

                DateFormat formatter = new SimpleDateFormat("yyyy-MM-dd")
                Date date = formatter.parse(fechaEmision)
                Timestamp ts = new Timestamp(date.getTime())
            </script>

            <set field="purchaseOutMap" from="[:]"/>
            <set field="invoiceOutMap" from="[:]"/>

            <if condition="!invoiceId">
                <service-call name="mchile.PurchaseServices.create#Purchase" in-map="[vendorPartyId:issuerPartyId]" out-map="purchaseOutMap"/>
                <!-- TODO: ¿Faltan items? -->
                <service-call name="mantle.account.InvoiceServices.create#EntireOrderPartInvoice" in-map="[orderId:purchaseOutMap.orderId, orderPartSeqId:purchaseOutMap.orderPartSeqId]" out-map="invoiceOutMap"/>
                <set field="invoiceId" from="invoiceOutMap.invoiceId"/>
            </if>

            <!-- Creación de FiscalTaxDocument -->
            <set field="createMap" from="[issuerPartyId:issuerPartyId, issuerPartyIdTypeEnumId:'PtidNationalTaxId', fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber,
                        receiverPartyId:receiverPartyId, receiverPartyIdTypeEnumId:'PtidNationalTaxId', date:ts, invoiceId:invoiceId]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocument" out-map="context" in-map="createMap"/>

            <!-- Creación de contenido (Solo PDF) -->
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[partyId:issuerPartyId]" out-map="issuerRut"/>
            <entity-find-one entity-name="moqui.basic.Enumeration" value-field="dteType" auto-field-map="[enumId:fiscalTaxDocumentTypeEnumId]"/>
            <set field="pdfContentLocation" value="dbresource://moit/erp/dte/${issuerRut?.rutSinFormato?:issuerPartyId}/DT-${dteType.enumCode}-${fiscalTaxDocumentNumber}.pdf"/>
            <set field="createMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, contentDate:ts, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml', contentLocation:pdfContentLocation]"/>
            <script>ec.resource.getLocationReference(pdfContentLocation).putStream(pdf.inputStream)</script>
            <service-call name="create#mchile.dte.FiscalTaxDocumentContent" out-map="context" in-map="createMap"/>

            <!-- Entrada en atributos -->
            <set field="updateMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, emailEmisor:emailEmisor, amount:amount,
                                         montoNeto:montoNeto, tasaImpuesto:tasaImpuesto, tipoImpuesto:tipoImpuesto, razonSocial:razonSocial, fechaEmision:fechaEmision, documentoAnulado:documentoAnulado,
                                         montoExento:montoExento, montoIVARecuperable:montoIVARecuperable, codigoIVANoRecuperable:codigoIVANoRecuperable, montoIVANoRecuperable:montoIVANoRecuperable,
                                         montoIVAUsoComun:montoIVAUsoComun, codigoOtroImpuestoORetencion:codigoOtroImpuestoORetencion, tasaOtroImpuestoORetencion:tasaOtroImpuestoORetencion,
                                         montoOtroImpuestoORetencionConCredito:montoOtroImpuestoORetencionConCredito, montoOtroImpuestoORetencionSinCredito:montoOtroImpuestoORetencionSinCredito,
                                         montoNetoActivoFijo:montoNetoActivoFijo, montoIVAActivoFijo:montoIVAActivoFijo, montoIVANoRetenido:montoIVANoRetenido, codigoSucursal:codigoSucursal,
                                         notasDebitoCreditoFacturasCompra:notasDebitoCreditoFacturasCompra]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocumentAttributes" out-map="context" in-map="updateMap"/>
        </actions>
    </service>

    <service verb="eliminar" noun="DTE">
        <description>
            Elimina registro de una DTE de cualquier tipo
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <actions>

            <script>
                import java.nio.file.Path
                import java.nio.file.Paths
                import java.nio.file.Files
            </script>

            <!-- Borrado de atributos -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentAttributes" value-field="attributesToDelete">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>
            <if condition="attributesToDelete">
                <entity-delete value-field="attributesToDelete"/>
            </if>
            <!-- Borrado de XML -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="xmlContentToDelete">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId" value="Ftdct-Xml"/>
            </entity-find-one>
            <if condition="xmlContentToDelete">
                <entity-delete value-field="xmlContentToDelete"/>
            </if>
            <!-- Borrado de PDF -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="pdfContentToDelete">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId" value="Ftdct-Pdf"/>
            </entity-find-one>
            <if condition="pdfContentToDelete">
                <entity-delete value-field="pdfContentToDelete"/>
            </if>
            <!-- Borrado de PDF Cedible -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="pdfContentToDelete">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId" value="Ftdct-PdfCedible"/>
            </entity-find-one>
            <if condition="pdfContentToDelete">
                <entity-delete value-field="pdfContentToDelete"/>
            </if>
            <!-- Se verifica si la DTE es de un tercero -->

            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="dteEv" for-update="true">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>


            <set field="issuerId" from="dteEv.issuerPartyId"/>
            <if condition="issuerId == organizationPartyId">
                <then>
                    <set field="dteEv.fiscalTaxDocumentStatusEnumId" value="Ftdt-NotIssued"/>
                    <!-- TODO: Revisar que dejar receiverPartyID tal cual no afecte -->
                    <!--set field="dteEv.receiverPartyId" value=""/-->
                    <entity-update value-field="dteEv"/>
                </then>
                <else><!-- DTE de tercero -->
                    <!-- Si hay una aceptación creada debe borrarse -->
                    <entity-find entity-name="mchile.dte.AceptacionDte" list="aceptacionList" for-update="true">
                        <econdition field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                    </entity-find>
                    <iterate list="aceptacionList" entry="aceptacionEntry">
                        <entity-find-one entity-name="mchile.dte.AceptacionDte" value-field="aceptacionToDelete">
                            <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                            <field-map field-name="aceptacionDteId" from="aceptacionEntry.aceptacionDteId"/>
                        </entity-find-one>
                        <entity-delete value-field="aceptacionToDelete"/>
                    </iterate>
                    <entity-delete value-field="dteEv"/>
                </else>
            </if>

        </actions>
    </service>

    <service verb="anular" noun="DTE">
        <description>
            Marca una DTE (inicialmente boleta) como anulada
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="dteEv" for-update="true">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>

            <if condition="!dteEv">
                <return error="true" message="Boleta a anular no existe"/>
            </if>

            <set field="dteEv.fiscalTaxDocumentStatusEnumId" value="Ftdt-Cancelled"/>
            <entity-update value-field="dteEv"/>
        </actions>
    </service>

    <service verb="get" noun="InvoiceFromReturn">
        <description>
            Obtiene datos para llamar a método generar#Factura para Nota de Crédito
        </description>
        <in-parameters>
            <parameter name="returnId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="invoiceId"/>
        </out-parameters>
        <actions>
            <!-- Se busca el orderId de la devolución -->
            <entity-find entity-name="mantle.order.return.ReturnHeaderDetail" list="returnHeaderList">
                <select-field field-name="returnId,statusId,entryDate,facilityId,vendorPartyId,customerPartyId"/>
            </entity-find>

            <entity-find-one entity-name="mantle.order.return.ReturnItem" value-field="returnItemField">
                <field-map field-name="returnId" from="returnId"/>
                <select-field field-name="orderId"/>
                <select-field field-name="returnItemSeqId"/>
            </entity-find-one>

            <set field="orderId" from="returnItemField.orderId"/>
            <set field="returnItemSeqId" from="returnItemField.returnItemSeqId"/>

            <service-call name="mantle.order.OrderInfoServices.get#OrderDisplayInfo" in-map="[orderId:orderId]" out-map="invoiceList"/>

            <iterate list="invoiceList.invoiceIdSet" entry="invoiceEntry">
                <log message="Leyendo: ${invoiceEntry}" level="warn"/>
                <set field="invoiceId" from="invoiceEntry"/>
            </iterate>

        </actions>
    </service>

    <service verb="generar" noun="NotaCredito">
        <description>Obtiene datos para llamar a método generar#Factura para Nota de Crédito</description>
        <in-parameters>
            <parameter name="returnId" required="true"/>
            <parameter name="invoiceId" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="items" type="List"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <if condition="!items">
                <return error="true" message="Deben existir items a corregir en Nota de Crédito"/>
            </if>

            <set field="returnedItemList" type="NewMap" from="[]"/>

            <iterate list="items" entry="detailItem">
                <entity-find-one entity-name="mantle.order.return.ReturnItem" value-field="returnItemField">
                    <field-map field-name="returnId" from="returnId"/>
                    <field-map field-name="returnItemSeqId" from="detailItem.returnItemSeqId"/>
                </entity-find-one>
                <set field="returnItemField.pctDiscount" from="detailItem.pctDiscount"/>
                <entity-update value-field="returnItemField"/>
                <script>returnedItemList.add(detailItem.returnItemSeqId)</script>
            </iterate>

            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId" from="issuerPartyId"/>
                <econdition field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find>

            <if condition="!partyIdentificationList">
                <return error="true" message="Organización emisora no tiene RUT definido"/>
            </if>
            <set field="rutEmisor" from="partyIdentificationList.first.idValue"/>

            <!-- Datos de devolución, para armar nota de crédito -->
            <service-call name="mantle.order.ReturnServices.get#ReturnDisplayInfo" in-map="[returnId:returnId]" out-map="context"/>

            <!-- Recuperación de referencias -->
            <entity-find entity-name="mchile.dte.ReferenciaDteAndFiscalCode" list="referenciaList">
                <econdition field-name="returnId" from="returnId"/>
                <econdition field-name="referenciaTypeEnumId" value="RefDteTypeReturn"/>
                <order-by field-name="fiscalTaxDocumentTypeEnumId"/>
            </entity-find>

            <!-- Items de la devolución -->
            <entity-find entity-name="mantle.order.return.ReturnItem" list="returnItemList">
                <econdition field-name="returnId"/>
                <econdition field-name="returnItemSeqId" operator="in" from="returnedItemList"/>
                <order-by field-name="returnItemSeqId"/>
            </entity-find>

            <!-- email receptor -->
            <entity-find-one entity-name="mantle.order.return.ReturnHeader" value-field="returnField"/>

            <if condition="!returnField">
                <return error="true" message="No existe devolución"/>
            </if>
            <if condition="!returnField.customerPartyId">
                <return error="true" message="No existe tercero asociado a devolución"/>
            </if>

            <set field="partyId" from="returnField.customerPartyId"/>

            <set field="username"/>
            <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:returnField.customerPartyId]" out-map="context"/>
            <if condition="!emailAddress">
                <then>
                    <!--return error="true" message="Receptor no tiene dirección de correo"/-->
                    <log level="warn" message="Receptor no tiene dirección de correo"/>
                </then>
                <else>
                    <set field="username" from="emailAddress"/>
                </else>
            </if>

            <!-- rut receptor -->
            <set field="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            <entity-find-one entity-name="mantle.party.PartyIdentification" value-field="partyIdentificationEv"/>
            <set field="rutReceptor"/>
            <if condition="!partyIdentificationEv">
                <then>
                    <log message="Receptor no tiene RUT" level="warn"/>
                    <set field="rutReceptor" from="'66666666-6'"/>
                </then>
                <else>
                    <set field="rutReceptor" from="partyIdentificationEv.idValue"/>
                </else>
            </if>


            <!-- Datos para encontrar contacto -->

            <set field="contactMechId"/>

            <!-- Modificado para quedarse con la dirección válida a la fecha actual -->
            <!--entity-find-one entity-name="mantle.party.contact.PartyContactMech" value-field="contactMechField">
                <field-map field-name="partyId" from="partyId"/>
                <field-map field-name="contactMechPurposeId" value="PostalTax"/>
            </ientity-find-one-->

            <entity-find entity-name="mantle.party.contact.PartyContactMech" list="contactMechList">
                <econdition field-name="partyId" from="partyId"/>
                <econdition field-name="contactMechPurposeId" value="PostalTax"/>
                <econdition field-name="fromDate" operator="less-equals" from="ec.user.nowTimestamp"/>
                <econdition field-name="thruDate" from="null"/>
            </entity-find>

            <if condition="!contactMechList">
                <return error="true" message="Receptor no tiene dirección activa para impuestos"/>
            </if>

            <!--set field="contactMechId" from="contactMechField.contactMechId"/-->
            <set field="contactMechId" from="contactMechList.contactMechId.first()"/>

            <!-- Datos de contacto -->
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="contactPostalAddressField"/>
            <set field="dirReceptor" from="contactPostalAddressField.address1"/>
            <script>
                dirReceptor = dirReceptor + (contactPostalAddressField.unitNumber? (" " + contactPostalAddressField.unitNumber) : '')
            </script>

            <service-call name="mchile.GeoServices.get#ComunaFromGeoId" in-map="[stateProvinceGeoId:contactPostalAddressField.stateProvinceGeoId]" out-map="comunaOut"/>

            <set field="cmnaReceptor" from="comunaOut.comuna"/>

            <if condition="!cmnaReceptor">
                <return error="true" message="Receptor no tiene comuna/ciudad definida $contactMechId"/>
            </if>
            <!-- ID Contacto receptor -->
            <set field="receptorContactId" from="contactPostalAddressField.telecomContactMechId"/>


            <entity-find-one entity-name="mantle.party.Party" value-field="partyEv"/>
            <if condition="!partyEv">
                <return error="true" message="Receptor no existe"/>
            </if>

            <set field="partyTypeEnumId" from="partyEv.partyTypeEnumId"/>


            <set field="rznSocReceptor" value=""/>
            <set field="contactoReceptor" value=""/>
            <set field="giroReceptor" value="Sin Giro"/>


            <if condition="partyTypeEnumId == 'PtyOrganization'">
                <!-- Organizacion -->
                <entity-find-one entity-name="mantle.party.Organization" value-field="organizationField"/>
                <set field="rznSocReceptor" from="organizationField.organizationName"/>

                <service-call name="mchile.DTEServices.get#GiroPrimario" in-map="[partyId:partyId]" out-map="giroOutMap"/>
                <set field="giroReceptor" from="giroOutMap.description"/>
                <!--set field="giroReceptor" from="organizationField.giro"/-->

                <!-- Obtención de contacto para impuestos en organización -->
                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="contactOut"
                              in-map="[partyId:partyId, postalContactMechPurposeId:'PostalTax']"/>
                <if condition="!contactOut.postalContactMechId">
                    <return error="true" message="Receptor no tiene contacto tributario asignado"/>
                </if>
                <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddressField">
                    <field-map field-name="contactMechId" from="contactOut.postalContactMechId"/>
                </entity-find-one>
                <!-- Obtención de contacto en organización -->
                <if condition="!postalAddressField">
                    <return error="true" message="Nombre receptor no encontrado"/>
                </if>

                <set field="contactoReceptor" from="postalAddressField.toName"/>

            </if>
            <if condition="partyTypeEnumId == 'PtyPerson'">
                <!-- Persona Natural -->
                <entity-find-one entity-name="mantle.party.Person" value-field="personField"/>
                <if condition="!personField">
                    <return error="true" message="No existe persona para facturar"/>
                </if>

                <set field="rznSocReceptor" from="personField.firstName"/>
                <script>
                    rznSocReceptor = rznSocReceptor + " " + personField.lastName
                </script>
                <set field="contactoReceptor" from="rznSocReceptor"/>
            </if>


            <!-- Generacion de nota de crédito -->
            <service-call name="mchile.DTEServices.genera#Factura" in-map="[fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, rutEmisor:rutEmisor, rutReceptor:rutReceptor, rznSocReceptor:rznSocReceptor, giroReceptor:giroReceptor,
                          contactoReceptor:contactoReceptor, dirReceptor:dirReceptor, cmnaReceptor:cmnaReceptor, ciudadReceptor:ciudadReceptor, detailList:returnItemList,
                          invoiceId:invoiceId, returnId:returnId, formaPago:formaPago, medioPago:medioPago, referenciaList:referenciaList, issuerPartyId:issuerPartyId, receiverPartyId:partyId]" out-map="factMapOut"/>
            <set field="fiscalTaxDocumentId" from="factMapOut.fiscalTaxDocumentId"/>
        </actions>
    </service>

    <service verb="generar" noun="NotaDebito">
        <description>
            Obtiene datos para llamar a método generar#Factura para Nota de Debito
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="invoiceId" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="items" type="List"/>
            <parameter name="fiscalTaxDocumentTypeEnumId"/>
            <parameter name="codRef"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentIdNotaDebito"/>
        </out-parameters>
        <actions>
            <service-call name="mantle.account.InvoiceServices.get#InvoiceDisplayInfo" in-map="[invoiceId:invoiceId]" out-map="context"/>
            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId" from="issuerPartyId"/>
                <econdition field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find>

            <if condition="!partyIdentificationList.idValue[0]">
                <return error="true" message="Organización no tiene RUT definido"/>
            </if>
            <set field="rutEmisor" from="partyIdentificationList.idValue[0]"/>


            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="factField"/>

            <if condition="!factField">
                <return error="true" message="No se encontró folio para factura ${fiscalTaxDocumentId}"/>
            </if>
            <set field="folioFact" from="factField.fiscalTaxDocumentNumber"/>

            <!-- TODO: Items a modificar a partir de lista de parámetros en referenciaList -->
            <!--<if condition="items.length() != 0">
                <set field="itemList" from="items instanceof List ? items : items.split(',') as List" default-value="null"/>
            </if>-->
            <set field="itemList" from="items"/>

            <!-- email receptor -->
            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoiceEv"/>

            <if condition="!invoiceEv">
                <return error="true" message="No existe invoice original"/>
            </if>
            <if condition="!invoiceEv.toPartyId">
                <return error="true" message="No existe tercero asociado a invoice"/>
            </if>

            <set field="partyId" from="invoiceEv.toPartyId"/>

            <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:partyId]" out-map="context"/>
            <if condition="!emailAddress">
                <return error="true" message="Receptor no tiene dirección de correo party: $partyId"/>
            </if>
            <set field="username" from="emailAddress"/>

            <!-- rut receptor -->
            <set field="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            <entity-find-one entity-name="mantle.party.PartyIdentification" value-field="partyIdentificationEv"/>

            <if condition="!partyIdentificationEv">
                <return error="true" message="Receptor no tiene RUT"/>
            </if>

            <set field="rutReceptor" from="partyIdentificationEv.idValue"/>

            <service-call name="mantle.party.ContactServices.get#PartyContactInfoList" out-map="contactOut"
                          in-map="[partyId:partyId, getAll:true]"/>
            <set field="contactMechId"/>
            <iterate list="contactOut.postalAddressList" entry="postalAddList">
                <if condition="postalAddList.postalContactMechPurposeId == 'PostalTax'">
                    <set field="contactMechId" from="postalAddList.postalContactMechId"/>
                    <log message="Obteniendo dirección postal para impuestos: $contactMechId"/>
                </if>
            </iterate>

            <if condition="!contactMechId">
                <return error="true" message="Receptor no tiene dirección para impuestos"/>
            </if>

            <!-- Datos de contacto -->
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="contactPostalAddressField"/>
            <set field="dirReceptor" from="contactPostalAddressField.address1"/>
            <script>
                dirReceptor = dirReceptor + (contactPostalAddressField.unitNumber? (" " + contactPostalAddressField.unitNumber) : '')
            </script>
            <!-- Comuna -->
            <entity-find-one entity-name="moqui.basic.Geo" value-field="geoField">
                <field-map field-name="geoId" from="contactPostalAddressField.stateProvinceGeoId"/>
            </entity-find-one>

            <if condition="!geoField">
                <return error="true" message="No existe comuna"/>
            </if>

            <set field="cmnaReceptor" from="geoField.geoName"/>
            <!-- Ciudad -->
            <set field="ciudadReceptor" from="contactPostalAddressField.city"/>
            <!-- ID Contacto receptor -->
            <set field="receptorContactId" from="contactPostalAddressField.telecomContactMechId"/>


            <entity-find-one entity-name="mantle.party.Party" value-field="partyEv"/>
            <if condition="!partyEv">
                <return error="true" message="Receptor no existe"/>
            </if>

            <set field="partyTypeEnumId" from="partyEv.partyTypeEnumId"/>

            <set field="rznSocReceptor" value=""/>
            <set field="giroReceptor" value="Sin Giro"/>

            <if condition="partyTypeEnumId == 'PtyOrganization'">
                <!-- Organizacion -->
                <entity-find-one entity-name="mantle.party.Organization" value-field="organizationField"/>
                <set field="rznSocReceptor" from="organizationField.organizationName"/>
                <!--if condition="!organizationField.giro">
                    <return error="true" message="Receptor no tiene giro"/>
                </if-->
                <!--set field="giroReceptor" from="organizationField.giro"/-->
                <service-call name="mchile.DTEServices.get#GiroPrimario" in-map="[partyId:partyId]" out-map="giroOutMap"/>
                <set field="giroReceptor" from="giroOutMap.description"/>
                <!-- Obtención de contacto para impuestos en organización -->
                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="contactOut"
                              in-map="[partyId:partyId, postalContactMechPurposeId:'PostalTax']"/>
                <if condition="!contactOut.postalContactMechId">
                    <return error="true" message="Receptor no tiene contacto tributario asignado"/>
                </if>
                <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddressField">
                    <field-map field-name="contactMechId" from="contactOut.postalContactMechId"/>
                </entity-find-one>
                <!-- Obtención de contacto en organización -->
                <if condition="!postalAddressField">
                    <return error="true" message="Nombre receptor no encontrado"/>
                </if>

                <set field="contactoReceptor" from="postalAddressField.toName"/>


            </if>
            <if condition="partyTypeEnumId == 'PtyPerson'">
                <!-- Persona Natural -->
                <entity-find-one entity-name="mantle.party.Person" value-field="personField"/>
                <if condition="!personField">
                    <return error="true" message="No existe persona para facturar"/>
                </if>

                <set field="rznSocReceptor" from="personField.firstName"/>
                <script>
                    rznSocReceptor = rznSocReceptor + " " + personField.lastName
                </script>
                <set field="contactoReceptor" from="rznSocReceptor"/>
            </if>

            <!-- Recuperación de referencias para obtener folio -->
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="fiscalTaxField">
                <field-map field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
            </entity-find-one>

            <entity-find entity-name="mchile.dte.ReferenciaDte" list="referenciaListOld">
                <econdition field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <econdition field-name="referenciaTypeEnumId" value="RefDteTypeNotaDebito"/>
                <order-by field-name="fiscalTaxDocumentTypeEnumId"/>
            </entity-find>

            <set field="referenciaList" type="NewMap" from="[]"/>
            <script>referenciaList.add(referenciaListOld)</script>

            <!-- Generacion de nota de débito -->
            <service-call name="mchile.DTEServices.genera#Factura" in-map="[fiscalTaxDocumentTypeEnumId:'Ftdt-56', rutEmisor:rutEmisor, rutReceptor:rutReceptor, rznSocReceptor:rznSocReceptor, giroReceptor:giroReceptor,
                          contactoReceptor:contactoReceptor, dirReceptor:dirReceptor, cmnaReceptor:cmnaReceptor, ciudadReceptor:ciudadReceptor, detailList:itemList,
                          invoiceId:invoiceId, formaPago:formaPago, medioPago:medioPago, referenciaList:referenciaListOld, issuerPartyId:issuerPartyId, receiverPartyId:partyId]" out-map="factMapOut"/>

            <set field="fiscalTaxDocumentIdNotaDebito" from="factMapOut.fiscalTaxDocumentId"/>

            <!-- TODO: Crear invoice para nuevo cargo o escribir en asiento contable? -->
            <!--auto-parameters entity-name="mantle.account.invoice.Invoice" include="nonpk"

                description
                currencyUomId
                acctgTransResultEnumId (AtrSuccess)
                invoiceTotal
                appliedPayment (debería ser 0)
                unpaidTotal
                productStoreId (WEB001)
                <service verb="create" noun="InvoiceItem">
        <in-parameters>
            <parameter name="invoiceId" required="true"/>
            <auto-parameters entity-name="mantle.account.invoice.InvoiceItem" include="nonpk">
                <exclude field-name="invoiceItemSeqId"/></auto-parameters>
        </in-parameters>
        <out-parameters><parameter name="invoiceItemSeqId"/></out-parameters>
        <actions>

                o usar adjust#Invoice?

            -->

            <!--service-call name="mantle.account.invoice.InvoiceServices.create#Invoice" in-map="context + [fromPartyId:fromPartyId, toPartyId:partyId]" out-map="context"/-->

        </actions>
    </service>

    <service verb="agregar" noun="Referencia">
        <description>
            Agrega una referencia para DTE (excepto Nota de Débito)
        </description>
        <in-parameters>
            <parameter name="returnId"/>
            <parameter name="invoiceId"/>
            <parameter name="shipmentId"/>
            <parameter name="folio" required="true"/>
            <parameter name="rutOtroContribuyente" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="idAdicional"/>
            <parameter name="fecha" required="true"/>
            <parameter name="codigoReferenciaEnumId" required="true"/>
            <parameter name="razonReferencia"/>
            <parameter name="esFactura" default-value="false"/>
        </in-parameters>
        <actions>
            <!-- Verificación de RUT -->
            <service-call name="mchile.GeneralServices.verify#Rut" in-map="[rut:rutOtroContribuyente]"/>

            <!-- Inserción en tabla referenceReturn -->
            <if condition="esFactura == 'false'">
                <set field="createMap" from="[fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, codigoReferenciaEnumId:codigoReferenciaEnumId, fecha:fecha, rut:rutOtroContribuyente, idAdicional:idAdicional,
                                          folio:folio, returnId:returnId, razonReferencia:razonReferencia, referenciaTypeEnumId:'RefDteTypeReturn']"/>
                <service-call name="create#mchile.dte.ReferenciaDte" out-map="context" in-map="createMap"/>
            </if>
            <if condition="esFactura == 'true'">
                <set field="createMap" from="[fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, codigoReferenciaEnumId:codigoReferenciaEnumId, fecha:fecha, rut:rutOtroContribuyente, idAdicional:idAdicional,
                                          folio:folio, invoiceId:invoiceId, razonReferencia:razonReferencia, referenciaTypeEnumId:'RefDteTypeInvoice']"/>
                <service-call name="create#mchile.dte.ReferenciaDte" out-map="context" in-map="createMap"/>
            </if>
        </actions>
    </service>

    <service verb="agregar" noun="RefNotaDebito">
        <description>Agrega una referencia para asociar DTE con nota de débito</description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId"/>
            <parameter name="folio" required="true"/>
            <parameter name="rutOtroContribuyente" required="true"/>
            <parameter name="idAdicional"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fecha" required="true"/>
            <parameter name="codigoReferenciaEnumId" required="true"/>
            <parameter name="razonReferencia"/>
        </in-parameters>
        <actions>
            <!-- Verificación de RUT -->
            <service-call name="mchile.GeneralServices.verify#Rut" in-map="[rut:rutOtroContribuyente]"/>

            <!-- Inserción en tabla referenciaFactura -->
            <set field="createMap" from="[codigoReferenciaEnumId:codigoReferenciaEnumId, fecha:fecha, rut:rutOtroContribuyente, idAdicional:idAdicional,
                                          folio:folio, fiscalTaxDocumentId:fiscalTaxDocumentId, razonReferencia:razonReferencia, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId,
                                          referenciaTypeEnumId:'RefDteTypeNotaDebito']"/>
            <service-call name="create#mchile.dte.ReferenciaDte" out-map="context" in-map="createMap"/>
        </actions>
    </service>

    <service verb="agregar" noun="RefShipment">
        <description>
            Agrega una referencia para asociar DTE shipment/guía de despacho
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId"/>
            <parameter name="folio" required="true"/>
            <parameter name="rutOtroContribuyente" required="true"/>
            <parameter name="idAdicional"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fecha" required="true"/>
            <parameter name="codigoReferenciaEnumId" required="true"/>
            <parameter name="razonReferencia"/>
            <parameter name="shipmentId" required="true"/>
        </in-parameters>
        <actions>
            <!-- Verificación de RUT -->
            <service-call name="mchile.GeneralServices.verify#Rut" in-map="[rut:rutOtroContribuyente]"/>

            <!-- Inserción en tabla referenciaShipment -->
            <set field="createMap" from="[shipmentId:shipmentId, codigoReferenciaEnumId:codigoReferenciaEnumId, fecha:fecha, rut:rutOtroContribuyente, idAdicional:idAdicional,
                                          folio:folio, fiscalTaxDocumentId:fiscalTaxDocumentId, razonReferencia:razonReferencia, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId,
                                          referenciaTypeEnumId:'RefDteTypeShipment']"/>
            <service-call name="create#mchile.dte.ReferenciaDte" out-map="context" in-map="createMap"/>
        </actions>
    </service>

    <service verb="eliminar" noun="Referencia">
        <description>Eliminar referencia de una DTE</description>
        <in-parameters>
            <parameter name="referenciaId"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.ReferenciaDte" value-field="referenciaField" for-update="true"/>
            <entity-delete value-field="referenciaField"/>
        </actions>
    </service>

    <service verb="enviar" noun="Aceptacion" type="script" location="component://MoquiChile/service/mchile/DTEServices/enviarAceptacion.groovy">
        <description>
            Envío de respuesta a emisor DTE.

            Esta implementación inicialmente responde a un solo envío
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fiscalTaxDocumentNumber" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
    </service>

    <service verb="recibir" noun="Mercaderia" type="script" location="component://MoquiChile/service/mchile/DTEServices/recibirMercaderia.groovy">
        <description>
            Envío de recepción mercaderia DTE.

            Esta implementación inicialmente responde a un solo envío
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fiscalTaxDocumentNumber" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
    </service>

    <service verb="enviar" noun="ResultadoAprobacionComercial" type="script" location="component://MoquiChile/service/mchile/DTEServices/enviarResultadoAceptacionComercial.groovy">
        <description>
            Envío de respuesta a emisor DTE.

            Esta implementación inicialmente responde a un solo envío

            En un paso posterior se puede enviar Aceptación o Rechazo (no implementado)
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fiscalTaxDocumentNumber" required="true"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
    </service>

    <service verb="get" noun="DteContent">
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentContentTypeEnumId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="content"/>
            <parameter name="contentRef"/>
        </out-parameters>
        <actions>
            <set field="content" from="null"/>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="contentField"/>
            <if condition="contentField">
                <set field="content" from="contentField.contentLocation"/>
                <script>
                    docRr = ec.resource.getLocationReference(contentField.contentLocation)
                </script>
                <set field="contentRef" from="docRr"/>
            </if>
        </actions>
    </service>

    <service verb="get" noun="SIICode">
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="enumTypeId" default-value="FiscalTaxDocumentType"/>
        </in-parameters>
        <out-parameters>
            <parameter name="siiCode" type="Integer"/>
        </out-parameters>
        <actions>
            <set field="siiCode" from="null"/>
            <entity-find-one entity-name="moqui.basic.Enumeration" value-field="enumField">
                <field-map field-name="enumId" from="fiscalTaxDocumentTypeEnumId"/>
                <field-map field-name="enumTypeId"/>
            </entity-find-one>
            <set field="siiCode" from="enumField.enumCode" type="Integer"/>
        </actions>
    </service>

    <service verb="get" noun="MoquiSIICode">
        <in-parameters>
            <parameter name="siiCode" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId"/>
        </out-parameters>
        <actions>
            <set field="fiscalTaxDocumentTypeEnumId" from="null"/>
            <entity-find-one entity-name="moqui.basic.Enumeration" value-field="enumField">
                <field-map field-name="enumCode" from="siiCode"/>
                <field-map field-name="enumTypeId" value="FiscalTaxDocumentType"/>
            </entity-find-one>
            <set field="fiscalTaxDocumentTypeEnumId" from="enumField.enumId"/>
        </actions>
    </service>

    <service verb="check" noun="Afecto">
        <in-parameters>
            <parameter name="productId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="afecto"/>
        </out-parameters>
        <actions>
            <set field="afecto" value="true"/>
            <entity-find entity-name="mantle.product.category.ProductCategoryMember" list="categoryMemberList">
                <econdition field-name="productId" from="productId"/>
                <econdition field-name="productCategoryId" value="ClVatTaxExento"/>
                <date-filter/>
            </entity-find>
            <if condition="categoryMemberList"><set field="afecto" value="false"/></if>
        </actions>
    </service>

    <service verb="genera" noun="Boleta" type="script" location="component://MoquiChile/service/mchile/DTEServices/generaBoleta.groovy">
        <description>
            Generación de Boleta acuerdo a plantilla
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="rutReceptor"/>
            <parameter name="receiverPartyId" required="true"/>
            <parameter name="rznSocReceptor"/>
            <parameter name="giroReceptor"/>
            <parameter name="contactoReceptor"/>
            <parameter name="dirReceptor"/>
            <parameter name="cmnaReceptor"/>
            <parameter name="ciudadReceptor" default-value="${cmnaReceptor}"/>
            <parameter name="detailList" type="List"/>
            <parameter name="invoiceId" required="true"/>
            <parameter name="medioPago"/>
            <parameter name="formaPago"/>
            <parameter name="referenciaList" type="List"/>
            <parameter name="continua"/>
            <parameter name="saveSinFirma" type="Boolean" default="false"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
    </service>

    <service verb="genera" noun="RCOF" type="script" location="component://MoquiChile/service/mchile/DTEServices/generaRCOF.groovy">
        <description>Generación de Registro de Consumo de Folios</description>
        <in-parameters>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="fechaInicio"/>
            <parameter name="fechaFin"/>
            <parameter name="saveSinFirma" type="Boolean" default="false"/>
        </in-parameters>
    </service>

    <service verb="update" noun="InvoiceGlobalDiscount">
        <in-parameters>
            <parameter name="invoiceId" required="true"/>
            <parameter name="globalDiscount" type="Integer" default-value="0"/>
            <parameter name="glosaDr"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoiceEv">
                <field-map field-name="invoiceId" from="invoiceId"/>
            </entity-find-one>
            <set field="invoiceEv.globalDiscount" from="globalDiscount"/>
            <set field="invoiceEv.glosaDr" from="glosaDr"/>
            <entity-update value-field="invoiceEv"/>
        </actions>
    </service>

    <service verb="update" noun="ShipmentIndTraslado">
        <in-parameters>
            <parameter name="shipmentId" required="true"/>
            <parameter name="indTrasladoEnumId" required="true"/>
            <parameter name="tipoDespachoEnumId"/>
            <parameter name="priceInclude"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipmentEv">
                <field-map field-name="shipmentId" from="shipmentId"/>
            </entity-find-one>
            <set field="shipmentEv.indTrasladoEnumId" from="indTrasladoEnumId"/>
            <if condition="tipoDespachoEnumId">
                <set field="shipmentEv.tipoDespachoEnumId" from="tipoDespachoEnumId"/>
            </if>
            <set field="shipmentEv.priceInclude" from="priceInclude"/>
            <entity-update value-field="shipmentEv"/>
        </actions>
    </service>

    <service verb="generar" noun="GuiaDespacho" no-tx-cache="true">
        <description>
            Obtiene datos para generar Guía de Despacho a partir de un shipment
        </description>
        <in-parameters>
            <parameter name="shipmentId" required="true"/>
            <parameter name="indTrasladoEnumId" required="true"/>
            <parameter name="tipoDespachoEnumId"/>
            <parameter name="settlementTermId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <set field="glosaPagos"/>
            <if condition="settlementTermId">
                <entity-find-one entity-name="mantle.account.invoice.SettlementTerm" value-field="settlementField">
                    <field-map field-name="settlementTermId" from="settlementTermId"/>
                    <select-field field-name="description"/>
                </entity-find-one>
                <if condition="!settlementTermId">
                    <return error="true" message="Términos de crédito no existentes"/>
                </if>
                <set field="glosaPagos" from="settlementField.description"/>
            </if>
            <if condition="!glosaPagos"><set field="glosaPagos" value=""/></if>

            <entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/>
            <entity-find entity-name="mantle.shipment.ShipmentItemDetail" list="shipmentItemDetailList">
                <econdition field-name="shipmentId"/>
                <order-by field-name="productId"/>
            </entity-find>

            <set field="issuerPartyId" from="shipment.fromPartyId"/>
            <entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList">
                <econdition field-name="partyId" from="issuerPartyId"/>
                <econdition field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find>

            <if condition="!partyIdentificationList.idValue[0]">
                <return error="true" message="Organización no tiene RUT definido"/>
            </if>
            <set field="rutEmisor" from="partyIdentificationList.idValue[0]"/>

            <!-- Recuperación de referencias -->
            <entity-find entity-name="mchile.dte.ReferenciaDte" list="referenciaList">
                <econdition field-name="shipmentId" from="shipmentId"/>
                <econdition field-name="referenciaTypeEnumId" value="RefDteTypeShipment"/>
            </entity-find>

            <entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipmentEv"/>

            <if condition="!shipmentEv">
                <return error="true" message="No existe despacho"/>
            </if>
            <if condition="!shipmentEv.toPartyId">
                <return error="true" message="No existe tercero asociado a despacho"/>
            </if>
            <set field="partyId" from="shipmentEv.toPartyId"/>
            <set field="indTrasladoEnumId" from="shipmentEv.indTrasladoEnumId"/>
            <set field="tipoDespachoEnumId" from="shipmentEv.tipoDespachoEnumId"/>

            <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:shipmentEv.toPartyId]" out-map="context"/>
            <if condition="!emailAddress">
                <return error="true" message="Receptor no tiene dirección de correo"/>
            </if>
            <set field="username" from="emailAddress"/>

            <!-- rut receptor -->
            <set field="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            <entity-find-one entity-name="mantle.party.PartyIdentification" value-field="partyIdentificationEv"/>

            <if condition="!partyIdentificationEv">
                <return error="true" message="Receptor no tiene RUT"/>
            </if>

            <set field="rutReceptor" from="partyIdentificationEv.idValue"/>

            <!-- Datos para encontrar contacto -->
            <entity-find entity-name="mantle.party.contact.PartyContactMech" list="contactMechList">
                <econdition field-name="partyId" from="partyId"/>
                <econdition field-name="contactMechPurposeId" value="PostalTax"/>
                <econdition field-name="fromDate" operator="less-equals" from="ec.user.nowTimestamp"/>
                <econdition field-name="thruDate" from="null"/>
            </entity-find>

            <if condition="!contactMechList">
                <return error="true" message="Receptor no tiene dirección para impuestos"/>
            </if>
            <set field="contactMechId" from="contactMechList.contactMechId.first()"/>

            <!-- Datos de contacto -->
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="contactPostalAddressField"/>

            <if condition="!contactPostalAddressField">
                <return error="true" message="Receptor no tiene dirección postal"/>
            </if>

            <set field="dirReceptor" from="contactPostalAddressField.address1"/>
            <script>
                dirReceptor = dirReceptor + (contactPostalAddressField.unitNumber? (" " + contactPostalAddressField.unitNumber) : '')
            </script>
            <set field="cmnaReceptor" from="contactPostalAddressField.city"/>

            <!-- Obtención de contacto para impuestos en organización -->
            <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="contactOut"
                          in-map="[partyId:partyId, postalContactMechPurposeId:'PostalTax']"/>
            <if condition="!contactOut.postalContactMechId">
            </if>
            <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddressField">
                <field-map field-name="contactMechId" from="contactOut.postalContactMechId"/>
            </entity-find-one>

            <set field="cmnaReceptor" from="postalAddressField.stateProvinceGeoId"/>

            <service-call name="mchile.GeoServices.get#ComunaFromGeoId" in-map="[stateProvinceGeoId:postalAddressField.stateProvinceGeoId]" out-map="comunaOut"/>

            <set field="cmnaReceptor" from="comunaOut.comuna"/>
            <!-- ID Contacto receptor -->
            <set field="receptorContactId" from="contactPostalAddressField.telecomContactMechId"/>

            <entity-find-one entity-name="mantle.party.Party" value-field="partyEv"/>
            <if condition="!partyEv">
                <return error="true" message="Receptor no existe"/>
            </if>

            <set field="partyTypeEnumId" from="partyEv.partyTypeEnumId"/>
            <set field="rznSocReceptor" value=""/>
            <set field="contactoReceptor" value=""/>
            <set field="giroReceptor" value="Sin Giro"/>

            <if condition="partyTypeEnumId == 'PtyOrganization'">
                <!-- Organizacion -->
                <entity-find-one entity-name="mantle.party.Organization" value-field="organizationField"/>
                <set field="rznSocReceptor" from="organizationField.organizationName"/>
                <!--set field="giroReceptor" from="organizationField.giro"/!>
                <if condition="!giroReceptor">
                    <return error="true" message="Organización no tiene giro ingresado"/>
                </if-->
                <service-call name="mchile.DTEServices.get#GiroPrimario" in-map="[partyId:partyId]" out-map="giroOutMap"/>
                <set field="giroReceptor" from="giroOutMap.description"/>
                <!-- Obtención de contacto para impuestos en organización -->
                <service-call name="mantle.party.ContactServices.get#PartyContactInfo" out-map="contactOut"
                              in-map="[partyId:partyId, postalContactMechPurposeId:'PostalTax']"/>
                <if condition="!contactOut.postalContactMechId">
                    <return error="true" message="Receptor no tiene contacto tributario asignado"/>
                </if>
                <entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddressField">
                    <field-map field-name="contactMechId" from="contactOut.postalContactMechId"/>
                </entity-find-one>
                <!-- Obtención de contacto en organización -->
                <if condition="!postalAddressField">
                    <return error="true" message="Nombre receptor no encontrado"/>
                </if>

                <set field="contactoReceptor" from="postalAddressField.toName"/>
            </if>

            <if condition="partyTypeEnumId == 'PtyPerson'">
                <!-- Persona Natural -->
                <entity-find-one entity-name="mantle.party.Person" value-field="personField"/>
                <if condition="!personField">
                    <return error="true" message="No existe persona para facturar"/>
                </if>

                <set field="rznSocReceptor" from="personField.firstName"/>
                <script>
                    rznSocReceptor = rznSocReceptor + " " + personField.lastName
                </script>
                <set field="contactoReceptor" from="rznSocReceptor"/>
            </if>

            <service-call name="mchile.DTEServices.get#SIICode" in-map="[fiscalTaxDocumentTypeEnumId:indTrasladoEnumId, enumTypeId:'IndTraslado']" out-map="codeOut"/>
            <set field="indTraslado" from="codeOut.siiCode"/>

            <if condition="tipoDespachoEnumId">
                <service-call name="mchile.DTEServices.get#SIICode" in-map="[fiscalTaxDocumentTypeEnumId:tipoDespachoEnumId, enumTypeId:'TipoDespacho']" out-map="codeOut"/>
                <set field="tipoDespacho" from="codeOut.siiCode"/>
            </if>

            <set field="medioPago" value="PE"/>
            <set field="formaPago" value="2"/>

            <!-- Generacion de guía de despacho -->
            <service-call name="mchile.DTEServices.genera#Factura" in-map="[fiscalTaxDocumentTypeEnumId:'Ftdt-52', rutEmisor:rutEmisor, rutReceptor:rutReceptor, rznSocReceptor:rznSocReceptor, giroReceptor:giroReceptor,
                          contactoReceptor:contactoReceptor, dirReceptor:dirReceptor, cmnaReceptor:cmnaReceptor, ciudadReceptor:ciudadReceptor, detailList:shipmentItemDetailList,
                          invoiceId:invoiceId, returnId:returnId, formaPago:formaPago, medioPago:medioPago, referenciaList:referenciaList, issuerPartyId:issuerPartyId, receiverPartyId:partyId,
                          indTraslado:indTraslado, tipoDespacho:tipoDespacho, shipmentId:shipmentId, glosaPagos:glosaPagos, settlementTermId:settlementTermId]" out-map="factMapOut"/>
            <set field="fiscalTaxDocumentId" from="factMapOut.fiscalTaxDocumentId"/>
        </actions>
    </service>

    <service verb="get" noun="GiroPrimario">
        <in-parameters>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="giroId"/>
            <parameter name="description"/>
        </out-parameters>
        <actions>

            <entity-find-one entity-name="mchile.dte.PartyGiro" value-field="giroField">
                <field-map field-name="partyId" from="partyId"/>
                <field-map field-name="isPrimary" value="Primario"/>
            </entity-find-one>
            <if condition="giroField == null">
                <then>

                    <entity-find-one entity-name="mchile.dte.PartyGiro" value-field="giroField">
                        <field-map field-name="partyId" from="partyId"/>
                    </entity-find-one>
                    <if condition="!giroField">
                        <return error="true" message="Empresa de ID ${partyId} no tiene giro primario o giro registrado"/>
                    </if>
                </then>
            </if>
            <set field="giroId" from="giroField.giroId"/>
            <set field="description" from="giroField.description"/>
        </actions>
    </service>

    <service verb="validar" noun="DTE" authenticate="anonymous-all">
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="rutEmisor" required="true"/>
            <parameter name="folio" required="true" type="Integer"/>
            <parameter name="fechaEmision" required="true"/>
            <parameter name="monto" required="true" type="Integer"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <!-- Se busca partyId de acuerdo a emisor -->
            <entity-find-one entity-name="mantle.party.PartyIdentification" value-field="partyIdentificationEv">
                <field-map field-name="idValue" from="rutEmisor"/>
                <field-map field-name="partyIdTypeEnumId" value="PtidNationalTaxId"/>
            </entity-find-one>
            <if condition="!partyIdentificationEv">
                <message>No se encontró documento con los parámetros ingresados</message>
                <set field="fiscalTaxDocumentId"/>
                <return/>
            </if>
            <set field="issuerPartyId" from="partyIdentificationEv.partyId"/>

            <!-- Se verifica en tabla principal -->
            <entity-find entity-name="mchile.dte.FiscalTaxDocument" list="ftdtList">
                <econdition field-name="fiscalTaxDocumentNumber" from="folio"/>
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/>
                <econdition field-name="issuerPartyId" from="issuerPartyId"/>
            </entity-find>
            <set field="ftdtField" from="ftdtList.first"/>
            <if condition="!ftdtField">
                <message>No se encontró documento con los parámetros ingresados</message>
                <set field="fiscalTaxDocumentId"/>
                <return/>
            </if>

            <set field="fiscalTaxDocumentId" from="ftdtField.fiscalTaxDocumentId"/>
            <log level="warn" message="DTE Encontrada: $fiscalTaxDocumentId"/>
            <!-- Se buscan atributos en mchile.dte.FiscalTaxDocumentAttributes -->
            <entity-find entity-name="mchile.dte.FiscalTaxDocumentAttributes" list="ftdtAttList">
                <econdition field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <econdition field-name="amount" from="monto"/>
                <econdition field-name="fechaEmision" from="fechaEmision"/>
            </entity-find>

            <if condition="!ftdtAttList">
                <message>No se encontró documento con los parámetros ingresados</message>
                <set field="fiscalTaxDocumentId"/>
                <return/>
            </if>

        </actions>
    </service>

    <service verb="get" noun="ResumenRcof">
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fechaInicio" required="true" type="Timestamp"/>
            <parameter name="fechaFin" required="true" type="Timestamp"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="totalMontoNeto" type="BigDecimal"/>
            <parameter name="totalMontoIva" type="BigDecimal"/><!-- Se toma monto IVA Recuperable -->
            <parameter name="tasaIva"/>
            <parameter name="totalMontoExento"/>
            <parameter name="totalMontoTotal"/>
            <parameter name="cantDocEmitidos"/>
            <parameter name="cantFoliosAnulados"/>
            <parameter name="cantDocUtilizados"/>
            <parameter name="rangosFoliosUtilizados" type="List"/>
            <parameter name="rangosFoliosAnulados" type="List"/>
        </out-parameters>
        <actions>
            <set field="totalMontoNeto" from="0"/>
            <set field="totalMontoIva" from="0"/>
            <set field="totalMontoExento" from="0"/>
            <set field="totalMontoTotal" from="0"/>
            <set field="cantDocEmitidos" from="0"/>
            <set field="cantFoliosAnulados" from="0"/>
            <set field="cantDocUtilizados" from="0"/>
            <set field="tasaIva" from="19"/>
            <set field="rangosFoliosUtilizados" type="List"/>
            <set field="rangosFoliosAnulados" type="List"/>
            <script>
                Calendar cal = Calendar.getInstance()
                cal.setTimeInMillis(fechaFin.getTime())
                // add x hours
                cal.add(Calendar.HOUR, 24)
                fechaFin = new Timestamp(cal.getTime().getTime())
            </script>

            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="dteList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <!--econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/-->
                <econditions combine="or">
                    <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/>
                    <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Cancelled"/>
                </econditions>
                <econdition field-name="issuerPartyId" from="organizationPartyId"/>
                <econdition field-name="date" operator="greater-equals" from="fechaInicio"/>
                <econdition field-name="date" operator="less-equals" from="fechaFin"/>
                <order-by field-name="fiscalTaxDocumentId"/>
            </entity-find>


            <iterate list="dteList" entry="dteEv">
                <!--log level="warn" message="Atributos encontrados: $dteEv.fiscalTaxDocumentId, Monto Neto: $dteEv.montoNeto, monto IVA: $dteEv.montoIVARecuperable, tipo: $dteEv.fiscalTaxDocumentStatusEnumId"/-->
                <if condition="!dteEv.fiscalTaxDocumentStatusEnumId.equals('Ftdt-Cancelled')">
                    <then>
                        <script>
                            if (dteEv.montoNeto != null) {
                                long montoNeto = (long) dteEv.montoNeto
                                totalMontoNeto = totalMontoNeto + montoNeto
                            }
                            if (dteEv.montoIVARecuperable != null) {
                                long montoIva = (long) dteEv.montoIVARecuperable
                                totalMontoIva = totalMontoIva + montoIva
                            }
                            if (dteEv.montoExento != null) {
                                long montoExento = (long) dteEv.montoExento
                                totalMontoExento = totalMontoExento + montoExento
                            }
                            cantDocEmitidos = cantDocEmitidos + 1
                        </script>
                    </then>
                    <else><!-- Documento cancelado -->
                        <!--log message="DTE Cancelada" level="warn"/-->
                        <script>
                            cantFoliosAnulados = cantFoliosAnulados + 1
                        </script>
                    </else>
                </if>
            </iterate>
            <set field="cantDocUtilizados" from="cantFoliosAnulados + cantDocEmitidos"/>
            <set field="totalMontoTotal" from="totalMontoNeto + totalMontoExento + totalMontoIva"/>


            <!-- TODO: Consulta para ver todos los folios usados -->
            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="dteList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/>
                <econdition field-name="issuerPartyId" from="organizationPartyId"/>
                <econdition field-name="date" operator="greater-equals" from="fechaInicio"/>
                <econdition field-name="date" operator="less-equals" from="fechaFin"/>
                <order-by field-name="fiscalTaxDocumentId"/>
            </entity-find>
            <script>
                List&lt;Integer&gt; list
                List&lt;List&lt;Integer&gt;&gt; lList = new ArrayList&lt;List&lt;Integer&gt;&gt;()
                int i = 0
                int start = 0
                List&lt;Integer&gt; sList = new ArrayList&lt;Integer&gt;(2)
                int listSize = 0

                for (i = 1; i &lt; dteList.size(); i++) {
                    if (dteList.get(i-1).fiscalTaxDocumentNumber + 1 != dteList.get(i).fiscalTaxDocumentNumber) {
                        sList.add(dteList.get(start).fiscalTaxDocumentNumber)
                        sList.add(dteList.get(i-1).fiscalTaxDocumentNumber)
                        lList.add(sList)
                        sList = new ArrayList&lt;Integer&gt;(2)
                        start = i
                    }
                }
                if (dteList.size() &gt; 0) {
                    sList.add(dteList.get(start).fiscalTaxDocumentNumber)
                    sList.add(dteList.get(dteList.size()-1).fiscalTaxDocumentNumber)
                    lList.add(sList)
                }
                logger.warn("Lista de rangos emitidos: " + lList)

            </script>

            <!-- TODO: Consulta para ver todos los folios anulados -->
            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="dteList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Cancelled"/>
                <econdition field-name="issuerPartyId" from="organizationPartyId"/>
                <econdition field-name="date" operator="greater-equals" from="fechaInicio"/>
                <econdition field-name="date" operator="less-equals" from="fechaFin"/>
                <order-by field-name="fiscalTaxDocumentId"/>
            </entity-find>


            <script>
                List&lt;Integer&gt; listc
                List&lt;List&lt;Integer&gt;&gt; lListc = new ArrayList&lt;List&lt;Integer&gt;&gt;()
                i = 0
                start = 0
                List&lt;Integer&gt; sListc = new ArrayList&lt;Integer&gt;(2)
                for (i = 1; i &lt; dteList.size(); i++) {
                    if (dteList.get(i-1).fiscalTaxDocumentNumber + 1 != dteList.get(i).fiscalTaxDocumentNumber) {
                        sListc.add(dteList.get(start).fiscalTaxDocumentNumber)
                        sListc.add(dteList.get(i-1).fiscalTaxDocumentNumber)
                        lListc.add(sList)
                        sListc = new ArrayList&lt;Integer&gt;(2)
                        start = i
                    }
                }
                if (dteList.size() &gt; 0) {
                    sListc.add(dteList.get(start).fiscalTaxDocumentNumber)
                    sListc.add(dteList.get(dteList.size()-1).fiscalTaxDocumentNumber)
                    lListc.add(sListc)
                }
                logger.warn("Lista de rangos anulados: " + lListc)
            </script>
            <set field="rangosFoliosUtilizados" from="lList"/>
            <set field="rangosFoliosAnulados" from="lListc"/>
        </actions>
    </service>

    <service verb="get" noun="ResumenRcofNC">
        <description>
            Servicio que devuelve resumen de NC emitidas que refieren a boletas (39, 41)
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fechaInicio" required="true" type="Timestamp"/>
            <parameter name="fechaFin" required="true" type="Timestamp"/>
            <parameter name="organizationPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="totalMontoNeto" type="BigDecimal"/>
            <parameter name="totalMontoIva" type="BigDecimal"/><!-- Se toma monto IVA Recuperable -->
            <parameter name="tasaIva"/>
            <parameter name="totalMontoExento"/>
            <parameter name="totalMontoTotal"/>
            <parameter name="cantDocEmitidos"/>
            <parameter name="cantFoliosAnulados"/>
            <parameter name="cantDocUtilizados"/>
            <parameter name="rangosFoliosUtilizados" type="List"/>
            <parameter name="rangosFoliosAnulados" type="List"/>
        </out-parameters>
        <actions>
            <set field="totalMontoNeto" from="0"/>
            <set field="totalMontoIva" from="0"/>
            <set field="totalMontoExento" from="0"/>
            <set field="totalMontoTotal" from="0"/>
            <set field="cantDocEmitidos" from="0"/>
            <set field="cantFoliosAnulados" from="0"/>
            <set field="cantDocUtilizados" from="0"/>
            <set field="tasaIva" from="19"/>
            <set field="rangosFoliosUtilizados" type="List"/>
            <set field="rangosFoliosAnulados" type="List"/>
            <script>
                Calendar cal = Calendar.getInstance()
                cal.setTimeInMillis(fechaFin.getTime())
                // add x hours
                cal.add(Calendar.HOUR, 24)
                fechaFin = new Timestamp(cal.getTime().getTime())
            </script>

            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="dteList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <!--econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/-->
                <econditions combine="or">
                    <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/>
                    <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Cancelled"/>
                </econditions>
                <econdition field-name="issuerPartyId" from="organizationPartyId"/>
                <econdition field-name="date" operator="greater-equals" from="fechaInicio"/>
                <econdition field-name="date" operator="less-equals" from="fechaFin"/>
                <order-by field-name="fiscalTaxDocumentId"/>
            </entity-find>


            <iterate list="dteList" entry="dteEv">
                <!--log level="warn" message="Atributos encontrados: $dteEv.fiscalTaxDocumentId, Monto Neto: $dteEv.montoNeto, monto IVA: $dteEv.montoIVARecuperable, tipo: $dteEv.fiscalTaxDocumentStatusEnumId"/-->
                <if condition="!dteEv.fiscalTaxDocumentStatusEnumId.equals('Ftdt-Cancelled')">
                    <then>
                        <script>
                            if (dteEv.montoNeto != null) {
                                long montoNeto = (long) dteEv.montoNeto
                                totalMontoNeto = totalMontoNeto + montoNeto
                            }
                            if (dteEv.montoIVARecuperable != null) {
                                long montoIva = (long) dteEv.montoIVARecuperable
                                totalMontoIva = totalMontoIva + montoIva
                            }
                            if (dteEv.montoExento != null) {
                                long montoExento = (long) dteEv.montoExento
                                totalMontoExento = totalMontoExento + montoExento
                            }
                            cantDocEmitidos = cantDocEmitidos + 1
                        </script>
                    </then>
                    <else><!-- Documento cancelado -->
                        <!--log message="DTE Cancelada" level="warn"/-->
                        <script>
                            cantFoliosAnulados = cantFoliosAnulados + 1
                        </script>
                    </else>
                </if>
            </iterate>
            <set field="cantDocUtilizados" from="cantFoliosAnulados + cantDocEmitidos"/>
            <set field="totalMontoTotal" from="totalMontoNeto + totalMontoExento + totalMontoIva"/>
            <!--return error="true" message="NC: $cantDocUtilizados - $totalMontoTotal"/-->

            <!-- TODO: Consulta para ver todos los folios usados -->
            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="dteList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Issued"/>
                <econdition field-name="issuerPartyId" from="organizationPartyId"/>
                <econdition field-name="date" operator="greater-equals" from="fechaInicio"/>
                <econdition field-name="date" operator="less-equals" from="fechaFin"/>
                <order-by field-name="fiscalTaxDocumentId"/>
            </entity-find>
            <script>
                List&lt;Integer&gt; list
                List&lt;List&lt;Integer&gt;&gt; lList = new ArrayList&lt;List&lt;Integer&gt;&gt;()
                int i = 0
                int start = 0
                List&lt;Integer&gt; sList = new ArrayList&lt;Integer&gt;(2)
                int listSize = 0

                for (i = 1; i &lt; dteList.size(); i++) {
                    if (dteList.get(i-1).fiscalTaxDocumentNumber + 1 != dteList.get(i).fiscalTaxDocumentNumber) {
                        sList.add(dteList.get(start).fiscalTaxDocumentNumber)
                        sList.add(dteList.get(i-1).fiscalTaxDocumentNumber)
                        lList.add(sList)
                        sList = new ArrayList&lt;Integer&gt;(2)
                        start = i
                    }
                }
                if (dteList.size() &gt; 0) {
                    sList.add(dteList.get(start).fiscalTaxDocumentNumber)
                    sList.add(dteList.get(dteList.size()-1).fiscalTaxDocumentNumber)
                    lList.add(sList)
                }
                logger.warn("Lista de rangos emitidos: " + lList)

            </script>

            <!-- TODO: Consulta para ver todos los folios anulados -->
            <entity-find entity-name="mchile.dte.FtdtAttributesView" list="dteList">
                <econdition field-name="fiscalTaxDocumentTypeEnumId" from="fiscalTaxDocumentTypeEnumId"/>
                <econdition field-name="fiscalTaxDocumentStatusEnumId" value="Ftdt-Cancelled"/>
                <econdition field-name="issuerPartyId" from="organizationPartyId"/>
                <econdition field-name="date" operator="greater-equals" from="fechaInicio"/>
                <econdition field-name="date" operator="less-equals" from="fechaFin"/>
                <order-by field-name="fiscalTaxDocumentId"/>
            </entity-find>


            <script>
                List&lt;Integer&gt; listc
                List&lt;List&lt;Integer&gt;&gt; lListc = new ArrayList&lt;List&lt;Integer&gt;&gt;()
                i = 0
                start = 0
                List&lt;Integer&gt; sListc = new ArrayList&lt;Integer&gt;(2)
                for (i = 1; i &lt; dteList.size(); i++) {
                    if (dteList.get(i-1).fiscalTaxDocumentNumber + 1 != dteList.get(i).fiscalTaxDocumentNumber) {
                        sListc.add(dteList.get(start).fiscalTaxDocumentNumber)
                        sListc.add(dteList.get(i-1).fiscalTaxDocumentNumber)
                        lListc.add(sList)
                        sListc = new ArrayList&lt;Integer&gt;(2)
                        start = i
                    }
                }
                if (dteList.size() &gt; 0) {
                    sListc.add(dteList.get(start).fiscalTaxDocumentNumber)
                    sListc.add(dteList.get(dteList.size()-1).fiscalTaxDocumentNumber)
                    lListc.add(sListc)
                }
                logger.warn("Lista de rangos anulados: " + lListc)
            </script>
            <set field="rangosFoliosUtilizados" from="lList"/>
            <set field="rangosFoliosAnulados" from="lListc"/>
        </actions>
    </service>

    <service verb="load" noun="DteContent">
        <description>
            Carga XML/PDF/PDF Cedible directo en la BD
        </description>
        <in-parameters>
            <parameter name="filename" type="org.apache.commons.fileupload.FileItem"/>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentContentTypeEnumId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find entity-name="mchile.dte.FiscalTaxDocumentContent" list="ftdtList">
                <econdition field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <econdition field-name="fiscalTaxDocumentContentTypeEnumId" from="fiscalTaxDocumentContentTypeEnumId"/>
            </entity-find>

            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="fiscalTaxDocument"/>
            <set field="tipoFactura" from="fiscalTaxDocument.FiscalTaxDocumentType.sequenceNum"/>
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[rut:fiscalTaxDocument.issuerPartyId]" out-map="rut"/>
            <set field="rutEmisor" from="rut.rutSinFormato"/>

            <iterate list="ftdtList" entry="ftdtEntry">
                <set field="ftdtEntry.contentLocation" value="dbresource://moit/erp/dte/${rutEmisor}/DTE-${tipoFactura}-${folio}.xml"/>
                <script>
                    docRr = ec.resource.locationReference(ftdtEntry.contentLocation)
                    docRr.putStream(filename.getInputStream())
                </script>
                <entity-update value-field="ftdtEntry"/>
            </iterate>
        </actions>
    </service>

    <service verb="update" noun="PartyDteParameters">
        <in-parameters>
            <auto-parameters entity-name="mchile.dte.PartyDteParams"/>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find entity-name="mchile.dte.PartyDteParams" list="paramsList">
                <econdition field-name="partyId"/>
            </entity-find>

            <if condition="paramsList"><then>
                <service-call name="update#mchile.dte.PartyDteParams" in-map="context"/>
            </then><else>
                <service-call name="create#mchile.dte.PartyDteParams" in-map="[partyId:partyId, templatePdf:templatePdf, templatePdfBoleta:templatePdfBoleta,
                                  templatePdfBoletaContinua:templatePdfBoletaContinua, logo:logo, fchResol:fechResol, nroResol:nroResol, rutEmisor:rutEmisor,
                                  rutEnvia:rutEnvia, rznSocEmisor:rznSocEmisor, cdgSIISucur:cdgSIISucur, dirOrigen:dirOrigen, cmnaOrigen:cmnaOrigen, ciudadOrigen:ciudadOrigen,
                                  passCert:passCert, nmbContacto:nmbContacto, mailContacto:mailContacto, fonoContacto:fonoContacto]"/>
            </else></if>
        </actions>
    </service>

    <service verb="load" noun="Certificate">
        <description>Carga Certificado Digital para firmar DTE</description>
        <in-parameters>
            <parameter name="certificateFile" type="org.apache.commons.fileupload.FileItem"/>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="encoding" default-value="UTF-8"/>
            <parameter name="passCert" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.PartyDteParams" value-field="dteParams" for-update="true">
                <field-map field-name="partyId" from="organizationPartyId"/>
            </entity-find-one>
            <if condition="!dteParams">
                <return error="true" message="Primero complete parametros de organizacion"/>
            </if>
            <set field="dteParams.certData" from="certificateFile.get().encodeBase64()" type="String"/>
            <set field="dteParams.passCert" from="passCert"/>
        </actions>
    </service>

    <service verb="load" noun="PDFTemplate">
        <description>Carga Plantilla para generar PDF</description>
        <in-parameters>
            <parameter name="templateFile" type="org.apache.commons.fileupload.FileItem"/>
            <parameter name="organizationPartyId" required="true"/>
            <parameter name="type" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.PartyDteParams" value-field="dteParams" for-update="true">
                <field-map field-name="partyId" from="organizationPartyId"/>
            </entity-find-one>


            <if condition="type == 'DTE'">
                <set field="dteParams.pdfTemplate" from="templateFile.getString(encoding)"/>
            </if>

            <if condition="type == 'Boleta'">
                <set field="dteParams.pdfTemplateBoleta" from="templateFile.getString(encoding)"/>
            </if>

            <if condition="type == 'BoletaContinua'">
                <set field="dteParams.pdfTemplateBoletaContinua" from="templateFile.getString(encoding)"/>
            </if>

            <set field="logFile" from="templateFile.getName()"/>
            <log level="error" message="Subiendo plantilla PDF $logFile"/>

            <entity-update value-field="dteParams"/>
        </actions>
    </service>

    <service verb="add" noun="ReferenceToInvoice">
        <in-parameters>
            <parameter name="invoiceId" required="true"/>
            <parameter name="referenceText" default-value=" - "/>
            <parameter name="folioRef"/>
            <parameter name="tipoDocRef"/>
            <parameter name="fecha" type="Date"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.ReferenciaDte" value-field="refEv" for-update="true">
                <field-map field-name="invoiceId" from="invoiceId"/>
                <field-map field-name="fiscalTaxDocumentTypeEnumId" from="tipoDocRef"/>
                <field-map field-name="folio" from="folioRef"/>
                <field-map field-name="referenciaTypeEnumId" value="RefDteTypeInvoice"/>
            </entity-find-one>

            <if condition="!refEv">
                <then>
                    <!-- Hay que crear entrada para referencia de invoiceId -->
                    <set field="createMap" from="[fiscalTaxDocumentTypeEnumId:tipoDocRef, codigoReferenciaEnumId:codigoReferenciaEnumId, fecha:fecha, folio:folioRef, invoiceId:invoiceId, razonReferencia:referenceText, referenciaTypeEnumId:'RefDteTypeInvoice']"/>
                    <service-call name="create#mchile.dte.ReferenciaDte" out-map="context" in-map="createMap"/>
                </then>
                <else>
                    <!-- Ya existe una referencia -->
                    <set field="refEv.folio" from="folioRef"/>
                    <set field="refEv.fiscalTaxDocumentTypeEnumId" from="tipoDocRef"/>
                    <set field="refEv.fecha" from="fecha"/>
                    <set field="refEv.razonReferencia" from="referenceText"/>
                    <entity-update value-field="refEv"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="add" noun="ReferenceToShipment">
        <in-parameters>
            <parameter name="shipmentId" required="true"/>
            <parameter name="referenceText" default-value=" - "/>
            <parameter name="folioRef"/>
            <parameter name="tipoDocRef"/>
            <parameter name="fecha" type="Date"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.ReferenciaDte" value-field="refEv" for-update="true">
                <field-map field-name="shipmentId" from="shipmentId"/>
                <field-map field-name="fiscalTaxDocumentTypeEnumId" from="tipoDocRef"/>
                <field-map field-name="folio" from="folioRef"/>
                <field-map field-name="referenciaTypeEnumId" value="RefDteTypeShipment"/>
            </entity-find-one>
            <if condition="!refEv">
                <then>
                    <!-- Hay que crear entrada para referencia de invoiceId -->
                    <set field="createMap" from="[fiscalTaxDocumentTypeEnumId:tipoDocRef, codigoReferenciaEnumId:codigoReferenciaEnumId, fecha:fecha, folio:folioRef, shipmentId:shipmentId, razonReferencia:referenceText, referenciaTypeEnumId:'RefDteTypeShipment']"/>
                    <service-call name="create#mchile.dte.ReferenciaDte" out-map="context" in-map="createMap"/>
                </then>
                <else>
                    <!-- Ya existe la referencia -->
                    <set field="refEv.folio" from="folioRef"/>
                    <set field="refEv.fiscalTaxDocumentTypeEnumId" from="tipoDocRef"/>
                    <set field="refEv.fecha" from="fecha"/>
                    <set field="refEv.razonReferencia" from="referenceText"/>
                    <entity-update value-field="refEv"/>
                </else>
            </if>
        </actions>
    </service>

    <service verb="download" noun="Document">
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentContentTypeEnumId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="document" cache="false">
                <field-map field-name="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId"/>
            </entity-find-one>
            <script>
                docRr = ec.resource.getLocationReference(document.contentLocation)
                if (docRr?.exists)
                    ec.web.sendResourceResponse(document.contentLocation)
                else
                    ec.message.addError(ec.resource.expand('No se encontró archivo en [${fiscalTaxDocumentId}]',''))
            </script>
        </actions>
    </service>

    <service verb="check" noun="ProductionEnvironment">
        <out-parameters>
            <parameter name="isProduction" type="Boolean"/>
        </out-parameters>
        <actions>
            <script>isProduction = org.moqui.util.SystemBinding.getPropOrEnv("moquichile.dte.systemIsProduction") == 'true'</script>
        </actions>
    </service>

    <service verb="obtain" noun="NewCAF">
        <in-parameters>
            <parameter name="partyId" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="folioAmount" default-value="10"/>
        </in-parameters>
        <actions>
            <service-call name="mchile.DTEServices.check#ProductionEnvironment" out-map="context"/>
            <set field="hostName" from="isProduction ? 'palena.sii.cl' : 'maullin.sii.cl'"/>
            <set field="requestPath" value="/cvc_cgi/dte/of_solicita_folios_dcto"/>
            <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[partyId:partyId]" out-map="context"/>
            <entity-find-one entity-name="moqui.basic.Enumeration" value-field="fiscalTaxDocumentType" auto-field-map="[enumId:fiscalTaxDocumentTypeEnumId]"/>
            <if condition="fiscalTaxDocumentType == null"><message error="true">No se encuentra fiscalTaxDocumentType con Id ${fiscalTaxDocumentTypeEnumId}</message></if>
            <set field="rutEmp" from="rutEmisor.substring(0,rutEmisor.length()-2)"/>
            <set field="dvEmp" from="rutEmisor.substring(rutEmisor.length()-1, rutEmisor.length())"/>
            <set field="codDocto" from="fiscalTaxDocumentType.enumCode"/>
            <set field="ACEPTAR" value="Solicitar Numeración"/>
            <script><![CDATA[
                import org.moqui.util.RestClient
                import cl.moit.net.ClientAuthRequestFactory
                import org.eclipse.jetty.client.HttpClient

                ClientAuthRequestFactory requestFactory = new ClientAuthRequestFactory(certData, passCert)

                RestClient restClient = new RestClient().uri("https://${hostName}/cvc_cgi/dte/of_solicita_folios").method("GET").acceptContentType("text/html")
                        .contentType("application/x-www-form-urlencoded").withRequestFactory(requestFactory).encoding("iso-8859-1")
                java.net.CookieStore cookieStore = requestFactory.getHttpClient().cookieStore
                response = restClient.call() // Primer llamado lleva a selección de Continuar o representar.
                // Servidor del SII no especifica encoding pero sabemos que es iso-8859-1 y el default de RestClient es UTF-8
                responseText = new String(response.bytes(), "iso-8859-1")
                if (responseText =~ /Debido a que usted ha sido autorizado por otros contribuyentes\s+para que los represente electrónicamente en el sitio web del SII, esta página le permitirá decidir\s+si en esta oportunidad desea realizar trámites propios o representar electrónicamente a otro\s+contribuyente/) {
                    response = restClient.call() // Segundo llamado lleva a selección de Continuar o representar.
                    responseText = new String(response.bytes(), "iso-8859-1")
                }
                if (! responseText =~ /Para continuar debe digitar el Rut del Contribuyente que solicita timbrar\s+documentos electrónicos:/) {
                    ec.message.addError("Se esperaba recibir texto solicitando Rut del Contribuyente para solicitar timrar documentos electrónicos")
                    ec.logger.error("Texto recibido: ${responseText}")
                }
                restClient.method("POST").addBodyParameters([RUT_EMP:rutEmp, EV_EMP:dvEmp, ACEPTAR:'Continuar']).uri("https://${hostName}/cvc_cgi/dte/of_solicita_folios_dcto")
                //response = restClient.call() // Primer llamado lleva a selección de Continuar o representar.
                //responseText = new String(response.bytes(), "iso-8859-1")

                // FOLIO_INICIAL
                // FACTOR: si es < 1 y > 0, tiene situaciones pendientes.
                // AFECTO_IVA: si el contribuyente tiene giros afectos
                // MAX_AUTOR: cantidad máxima de folios a solicitar
                // CANT_TIMBRAJES: cantidad de CAF activos, si es > 6 no autoriza a solicitar más
                // CON_AJUSTE: "ajuste asignado", no se puede pedir más que esa cantidad
                fieldValues = [:]
                ['FOLIO_INICIAL', 'AFECTO_IVA', 'CON_CREDITO', 'CON_AJUSTE', 'FACTOR', 'MAX_AUTOR'].each { fieldName ->
                    matcher = responseText =~ /<input\s+name="${fieldName}"[^>]+/
                    fields = matcher.findAll()
                    if (fields) {
                        field = fields[0]
                        ec.logger.info("field: ${field}")
                    }
                }

                /*
                response.headers().each {
                    ec.logger.info("Header: ${it}")
                }
                ec.logger.info("cookies after: ")
                cookieStore.cookies.each { it -> ec.logger.info("\t${it.toString()}") }
                */
                restClient.method("POST").addBodyParameters([RUT_EMP:rutEmp, EV_EMP:dvEmp, COD_DOCTO:codDocto, CANT_DOCTOS:'', FOLIO_INICIAL:'0'])
                        .uri("https://${hostName}/cvc_cgi/dte/of_solicita_folios_dcto")
                //response = restClient.call() // Primer llamado lleva a selección de Continuar o representar.
                //responseText = new String(response.bytes(), "iso-8859-1")
                ec.logger.info("got reponse status code ${response?.statusCode}: ${responseText}")
            ]]></script>
        </actions>
    </service>

</services>