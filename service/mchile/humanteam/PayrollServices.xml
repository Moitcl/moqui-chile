<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <service verb="create" noun="PayrollPeriods">
        <in-parameters>
            <parameter name="date" type="Date"/>
            <parameter name="timePeriodTypeId"/>
            <parameter name="partyId" type="List"/>
        </in-parameters>
        <out-parameters>
            <parameter name="timePeriodIdList" type="List"/>
        </out-parameters>
        <actions>
            <set field="orgIdList" from="partyId"/>
            <service-call name="mantle.party.PartyServices.setup#UserOrganizationInfo" out-map="userOrgInfo"/>
            <entity-find entity-name="mantle.party.PartyRole" list="internalOrgList">
                <econdition field-name="roleTypeId" value="OrgInternal"/>
                <econdition field-name="partyId" operator="in" from="orgIdList" ignore-if-empty="true"/>
                <econditions combine="or">
                    <econdition field-name="partyId" from="ec.user.userAccount.partyId"/>
                    <econdition field-name="partyId" operator="in" from="userOrgInfo.userOrgIds"/>
                </econditions>
            </entity-find>
            <set field="timePeriodIdList" from="[]"/>
            <set field="date" from="date ? new java.sql.Timestamp(date.time) : ec.user.nowTimestamp"/>
            <iterate entry="internalOrg" list="internalOrgList">
                <service-call name="mchile.humanteam.PayrollServices.create#PayrollPeriod" in-map="[date:date, partyId:internalOrg.partyId]" out-map="out"/>
                <script>timePeriodIdList.add(out.timePeriodId)</script>
            </iterate>
            <script>ec.message.addMessage("Created timePeriods ${timePeriodIdList}")</script>
        </actions>
    </service>

    <service verb="create" noun="PayrollPeriod">
        <in-parameters>
            <parameter name="timePeriodTypeId" default-value="PayrollMonth"/>
            <parameter name="date" type="Timestamp"/>
            <parameter name="partyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="timePeriodId"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriodType" value-field="timePeriodType"/>
            <if condition="timePeriodType == null"><return error="true" message="Could not find time period type ${timePeriodTypeId}"/></if>
            <!-- find existing time period -->
            <entity-find entity-name="mantle.party.time.TimePeriod" list="existingList">
                <econdition field-name="timePeriodTypeId" from="timePeriodTypeId"/>
                <econdition field-name="partyId"/>
                <date-filter valid-date="date"/>
            </entity-find>
            <if condition="existingList">
                <return error="true" message="Error creating Payroll Period of type ${timePeriodTypeId}, existing period for same date (${date}): ${existingList.first.timePeriodId}"/>
            </if>
            <!-- find from and thru dates -->
            <script>
                Calendar cal = Calendar.instance
                cal.setTimeInMillis(date.time)
                cal.set(Calendar.MILLISECOND, 0)
                cal.set(Calendar.SECOND, 0)
                cal.set(Calendar.MINUTE, 0)
                cal.set(Calendar.HOUR, 0)
                if (timePeriodType.lengthUomId == 'TF_mon') {
                    cal.set(Calendar.DAY_OF_MONTH, 1)
                } else {
                    ec.message.addError("Unhandled Uom: ${timePeriodType.lengthUomId}")
                }
                fromDate = new java.sql.Timestamp(cal.time.time)
                cal.add(Calendar.MILLISECOND, -1)
                previousThruDate = new java.sql.Timestamp(cal.time.time)
                if (timePeriodType.lengthUomId == 'TF_mon') {
                    cal.add(Calendar.MONTH, 1)
                }
                thruDate = cal.time
            </script>
            <!-- find previous by dates -->
            <entity-find entity-name="mantle.party.time.TimePeriod" list="previousList">
                <econdition field-name="timePeriodTypeId" from="timePeriodTypeId"/>
                <econdition field-name="partyId"/>
                <date-filter valid-date="previousThruDate"/>
            </entity-find>
            <if condition="previousList"><then>
                <service-call name="mantle.party.TimeServices.create#TimePeriod" in-map="[previousPeriodId:previousList.first.timePeriodId]"/>
            </then><else>
                <service-call name="mantle.party.TimeServices.create#TimePeriod" in-map="[partyId:partyId, timePeriodTypeId:timePeriodTypeId, fromDate:fromDate]" out-map="context"/>
            </else></if>
            <service-call name="mchile.humanteam.PayrollServices.get#PayrollPeriodTaxRate" in-map="[timePeriodId:timePeriodId]"/>
        </actions>
    </service>

    <service verb="get" noun="TimePeriod">
        <in-parameters>
            <parameter name="activeOrgId"/>
            <parameter name="timePeriodId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="timePeriodId"/>
            <parameter name="timePeriod"/>
            <parameter name="timePeriodOrgId"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.party.time.TimePeriod" list="periods" limit="1">
                <econdition field-name="timePeriodId" ignore-if-empty="true"/>
                <econdition field-name="timePeriodTypeId" value="PayrollMonth"/>
                <econdition field-name="partyId" from="activeOrgId" ignore-if-empty="true"/>
                <order-by field-name="-fromDate"/>
            </entity-find>
            <set field="timePeriod" from="periods.first"/>
            <set field="timePeriodId" from="timePeriod?.timePeriodId"/>
            <set field="timePeriodOrgId" from="timePeriod?.partyId"/>
        </actions>
    </service>

    <service verb="get" noun="ParameterValue">
        <in-parameters>
            <parameter name="parameterTypeList" required="true" type="List"/>
            <parameter name="validDate" type="Timestamp"/>
            <parameter name="type" default-value="Number"/>
        </in-parameters>
        <out-parameters>
            <parameter name="valueMap" type="Map"/>
        </out-parameters>
        <actions>
            <set field="locale" from="new Locale('en','US')"/>
            <set field="valueMap" from="[:]"/>
            <iterate entry="parameterType" list="parameterTypeList">
                <script>outName = parameterType.toLowerCase()[0] + parameterType.substring(1)</script>
                <entity-find entity-name="mchile.humanteam.payroll.PayrollParameter" list="parameterList">
                    <econdition field-name="payrollParameterTypeEnumId" from="parameterType"/>
                    <date-filter valid-date="validDate?:ec.user.nowTimestamp"/>
                </entity-find>
                <set field="found" from="false"/>
                <if condition="parameterList">
                    <set field="pv" from="parameterList.first"/>
                    <if condition="pv.details">
                        <set field="found" from="true"/>
                        <set field="ev" from="pv.details.first"/>
                        <set field="value" from="ev.rate"/>
                        <if condition="value == null"><set field="value" from="ev.flatAmount"/></if>
                        <if condition="value == null"><set field="value" from="ev.periodMin"/></if>
                        <if condition="value == null"><set field="value" from="ev.periodMax"/></if>
                        <if condition="value == null"><return error="true" message="No value found for parameter ${key}"/></if>
                        <script>valueMap.put(outName, new BigDecimal(value))</script>
                    </if>
                </if>
                <if condition="!found">
                    <return error="true" message="Could not find parameter ${parameterName} at date ${validDate?:ec.user.nowTimestamp}"/>
                </if>
            </iterate>
        </actions>
    </service>

    <service verb="get" noun="PeriodParameters">
        <in-parameters>
            <parameter name="activeOrgId"/>
            <parameter name="timePeriodId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="timePeriodOrgId"/>
            <parameter name="timePeriodId"/>
            <parameter name="periodFromDate" type="Date"/>
            <parameter name="periodThruDate" type="Date"/>
            <parameter name="periodUfValue" type="BigDecimal"/>
            <parameter name="periodUfTitle"/>
            <parameter name="previousUfValue" type="BigDecimal"/>
            <parameter name="previousUfTitle"/>
            <parameter name="periodUtmValue" type="BigDecimal"/>
            <parameter name="periodUtaValue" type="BigDecimal"/>
            <parameter name="topeImponibleAfpCLF" type="BigDecimal"/>
            <parameter name="topeImponibleAfp" type="BigDecimal"/>
            <parameter name="topeImponibleIpsCLF" type="BigDecimal"/>
            <parameter name="topeImponibleIps" type="BigDecimal"/>
            <parameter name="topeImponibleAfcCLF" type="BigDecimal"/>
            <parameter name="topeImponibleAfc" type="BigDecimal"/>
            <parameter name="rentaMinimaGeneralCLP" type="BigDecimal"/>
            <parameter name="rentaMinimaMenoresCLP" type="BigDecimal"/>
            <parameter name="rentaMinimaCasaCLP" type="BigDecimal"/>
            <parameter name="rentaMinimaNoremCLP" type="BigDecimal"/>
            <parameter name="topeApvMensualCLF" type="BigDecimal"/>
            <parameter name="topeApvMensual" type="BigDecimal"/>
            <parameter name="topeApvAnualCLF" type="BigDecimal"/>
            <parameter name="topeApvAnual" type="BigDecimal"/>
            <parameter name="topeDepositoConvenidoAnualCLF" type="BigDecimal"/>
            <parameter name="topeDepositoConvenidoAnual" type="BigDecimal"/>
            <parameter name="tasaAfcContratoIndefinidoEmpleador" type="BigDecimal"/>
            <parameter name="tasaAfcContratoIndefinidoTrabajador" type="BigDecimal"/>
            <parameter name="tasaAfcContratoFijoEmpleador" type="BigDecimal"/>
            <parameter name="tasaAfcContratoFijoTrabajador" type="BigDecimal"/>
            <parameter name="tasaAfcContrato11AnosEmpleador" type="BigDecimal"/>
            <parameter name="tasaAfcContrato11AnosTrabajador" type="BigDecimal"/>
            <parameter name="tasaSis" type="BigDecimal"/>
            <parameter name="tasaTrabajoPesadoEmpleador" type="BigDecimal"/>
            <parameter name="tasaTrabajoPesadoTrabajador" type="BigDecimal"/>
            <parameter name="tasaTrabajoMenosPesadoEmpleador" type="BigDecimal"/>
            <parameter name="tasaTrabajoMenosPesadoTrabajador" type="BigDecimal"/>
            <parameter name="tasaSeguroAccidentesOrdinaria" type="BigDecimal"/>
            <parameter name="tasaSeguroAccidentesExtraordinaria" type="BigDecimal"/>
            <parameter name="tasaSanna" type="BigDecimal"/>
            <parameter name="afpRateList" type="List"/>
            <parameter name="asignacionFamiliarList" type="List"/>
            <parameter name="taxRateListMap" type="List">
                <parameter name="taxRateList" type="Map"/>
            </parameter>
        </out-parameters>
        <actions>
            <set field="locale" from="new Locale('en','US')"/>
            <service-call name="mchile.humanteam.PayrollServices.get#TimePeriod" in-map="context" out-map="context"/>
            <if condition="!timePeriod">
                <return error="true" message="Did not find Payroll Time Period"/>
            </if>
            <set field="periodFromDate" from="new java.sql.Timestamp(timePeriod.fromDate.time)"/>
            <script>
                Calendar cal = Calendar.instance
                cal.setTimeInMillis(timePeriod.thruDate.time)
                cal.add(Calendar.DAY_OF_MONTH, 1)
                cal.add(Calendar.MILLISECOND, -1)
                periodThruDate = new java.sql.Timestamp(cal.time.time)
            </script>
            <service-call name="mchile.CurrencyServices.get#ExchangeRate" in-map="[fromCurrencyUomId:'CLF', date:timePeriod.thruDate]" out-map="periodUf"/>
            <set field="periodUfValue" from="periodUf.value"/>
            <set field="periodUfTitle" from="ec.l10n.format(periodThruDate, '\'al\' dd \'de\' MMMM yyyy')"/>
            <service-call name="mchile.CurrencyServices.get#ExchangeRate" in-map="[fromCurrencyUomId:'CL_UTM', date:timePeriod.thruDate]" out-map="periodUtm"/>
            <set field="periodUtmValue" from="periodUtm.value"/>
            <set field="periodUtaValue" from="periodUtmValue*12"/>
            <set field="previousThruDate" from="new java.sql.Timestamp(timePeriod.fromDate.time-10)"/>
            <service-call name="mchile.CurrencyServices.get#ExchangeRate" in-map="[fromCurrencyUomId:'CLF', date:previousThruDate]" out-map="previousUf"/>
            <set field="previousUfValue" from="previousUf.value"/>
            <set field="previousUfTitle" from="ec.l10n.format(previousThruDate, '\'al\' dd \'de\' MMMM yyyy')"/>

            <service-call name="mchile.humanteam.PayrollServices.get#ParameterValue" in-map="[parameterTypeList:['TopeImponibleAfpCLF', 'TopeImponibleIpsCLF',
                          'TopeImponibleAfcCLF', 'RentaMinimaGeneralCLP', 'RentaMinimaMenoresCLP', 'RentaMinimaCasaCLP', 'RentaMinimaNoremCLP',
                          'TopeApvMensualCLF', 'TopeApvAnualCLF', 'TopeDepositoConvenidoAnualCLF', 'TasaAfcContratoIndefinidoEmpleador',
                          'TasaAfcContratoIndefinidoTrabajador', 'TasaAfcContratoFijoEmpleador', 'TasaAfcContratoFijoTrabajador',
                          'TasaAfcContrato11AnosEmpleador', 'TasaAfcContrato11AnosTrabajador',  'TasaSis', 'TasaTrabajoPesadoEmpleador',
                          'TasaTrabajoPesadoTrabajador', 'TasaTrabajoMenosPesadoEmpleador', 'TasaTrabajoMenosPesadoTrabajador', 'TasaSeguroAccidentesOrdinaria',
                          'TasaSeguroAccidentesExtraordinaria', 'TasaSanna'],
                          validDate:periodFromDate]" out-map="pv"/>
            <script>context.putAll(pv.valueMap)</script>

            <if condition="topeImponibleAfpCLF"><set field="topeImponibleAfp" from="ec.l10n.roundCurrency(topeImponibleAfpCLF*periodUfValue, 'CLP')"/></if>
            <!-- Valor para IPS se calcula con UF del último día del mes anterior -->
            <if condition="topeImponibleIpsCLF"><set field="topeImponibleIps" from="ec.l10n.roundCurrency(topeImponibleIpsCLF*previousUfValue, 'CLP')"/></if>
            <if condition="topeImponibleAfcCLF"><set field="topeImponibleAfc" from="ec.l10n.roundCurrency(topeImponibleAfcCLF*periodUfValue, 'CLP')"/></if>
            <if condition="topeApvMensualCLF"><set field="topeApvMensual" from="ec.l10n.roundCurrency(topeApvMensualCLF*periodUfValue, 'CLP')"/></if>
            <if condition="topeApvAnualCLF"><set field="topeApvAnual" from="ec.l10n.roundCurrency(topeApvAnualCLF*periodUfValue, 'CLP')"/></if>
            <if condition="topeDepositoConvenidoAnualCLF"><set field="topeDepositoConvenidoAnual" from="ec.l10n.roundCurrency(topeDepositoConvenidoAnualCLF*periodUfValue, 'CLP')"/></if>

            <!-- Cobro AFP -->
            <entity-find entity-name="mchile.humanteam.payroll.AfpRate" list="afpRateListEV">
                <date-filter valid-date="periodFromDate"/>
                <order-by field-name="afpPartyId"/>
            </entity-find>
            <set field="afpRateList" from="[]"/>
            <iterate entry="afpRate" list="afpRateListEV">
                <entity-find-one entity-name="mantle.party.Organization" value-field="afpOrganization" auto-field-map="[partyId:afpRate.afpPartyId]"/>
                <script>afpRateList.add([partyId:afpRate.afpPartyId, rate:afpRate.rate, organizationName:afpOrganization.organizationName])</script>
            </iterate>

            <!-- Asignación Familiar -->
            <entity-find entity-name="mantle.humanres.employment.PayrollAdjustmentAndDetail" list="asignacionFamiliarListEV">
                <econdition field-name="payrollAdjustmentId" value="ClAsignacionFamiliar"/>
                <date-filter valid-date="periodFromDate"/>
            </entity-find>
            <set field="asignacionFamiliarList" from="[]"/>
            <iterate list="asignacionFamiliarListEV" entry="af">
                <set field="requisitoRenta" from="(af.periodMin == 0? '': (ec.l10n.formatCurrency(af.periodMin, 'CLP') + ' &lt;= ')) + 'Renta' + (af.periodMax? (' &lt;= ' + ec.l10n.formatCurrency(af.periodMax-1, 'CLP')): '')"/>
                <script>asignacionFamiliarList.add([tramo:af.detailSeqId, monto:af.flatAmount, requisitoRenta:requisitoRenta])</script>
            </iterate>

            <service-call name="mchile.humanteam.PayrollServices.get#PayrollPeriodTaxRate" in-map="[timePeriodId:timePeriodId]" out-map="context"/>
            <set field="taxRateListMap" from="taxRateListMap"/>

        </actions>
    </service>

    <service verb="get" noun="PayrollPeriodTaxRate">
        <in-parameters><parameter name="timePeriodId" required="true"/></in-parameters>
        <out-parameters><parameter name="taxRateListMap"/></out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/>
            <if condition="!timePeriod">
                <return error="true" message="Could not find time period with Id ${timePeriodId}"/>
            </if>
            <entity-find entity-name="mantle.humanres.employment.PayrollAdjustmentAndDetail" list="taxRateListEV">
                <econdition field-name="itemTypeEnumId" value="ItemTaxClImpuestoSegundaCatClp"/>
                <date-filter valid-date="new java.sql.Timestamp(timePeriod.fromDate.time)"/>
            </entity-find>
            <if condition="!taxRateListEV">
                <if condition="timePeriod.timePeriodTypeId != 'PayrollMonth'">
                    <return error="true" message="Unsupported timePeriodTypeId ${timePeriod.timePeriodTypeId}"/>
                </if>
                <set field="fromDate" from="new java.sql.Timestamp(timePeriod.fromDate.time)"/>
                <entity-find entity-name="mchile.humanteam.payroll.PayrollParameter" list="taxRateParameterUtm">
                    <econdition field-name="payrollParameterTypeEnumId" value="ImpuestoSegundaCatUtm"/>
                    <date-filter valid-date="fromDate"/>
                </entity-find>
                <if condition="!taxRateParameterUtm">
                    <return error="true" message="Could not find taxrate for type ImpuestoSegundaCatUtm"/>
                </if>
                <entity-find entity-name="mchile.humanteam.payroll.PayrollParameterDetail" list="taxRateListUtm">
                    <econdition field-name="payrollParameterId" from="taxRateParameterUtm.first.payrollParameterId"/>
                    <order-by field-name="periodMin"/>
                </entity-find>
                <service-call name="mchile.CurrencyServices.get#ExchangeRate" in-map="[fromCurrencyUomId:'CL_UTM', date:fromDate]" out-map="utmMap"/>
                <set field="utmValue" from="utmMap.value"/>
                <set field="cumulatedAccruedAmount" from="0" type="BigDecimal"/>
                <set field="clpPayrollAdjustmentId" value="ClImpSegCatClp${ec.l10n.format(timePeriod.fromDate, 'yyyyMM')}"/>
                <iterate list="taxRateListUtm" entry="taxRateUtm">
                    <set field="periodMin" from="taxRateUtm.periodMin*utmValue"/>
                    <set field="periodMax" from="taxRateUtm.periodMax?(taxRateUtm.periodMax*utmValue):null"/>
                    <set field="flatAmount" from="(periodMin*taxRateUtm.rate)-cumulatedAccruedAmount"/>
                    <if condition="periodMax">
                        <script>cumulatedAccruedAmount += (periodMax-periodMin)*taxRateUtm.rate</script>
                    </if>
                    <set field="taxRateClp" from="taxRateUtm.getMap()+[payrollAdjustmentId:clpPayrollAdjustmentId, periodMin:periodMin, periodMax:periodMax,
                                                   fromDate:timePeriod.fromDate, thruDate:timePeriod.thruDate, flatAmount:-flatAmount,
                                                   itemTypeEnumId:'ItemTaxClImpuestoSegundaCatClp',
                                                   payrollPhaseEnumId:'PrphTax', description:'Impuesto de Segunda Categoría']"/>
                    <service-call name="store#mantle.humanres.employment.PayrollAdjustment" in-map="taxRateClp"/>
                    <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="taxRateClp"/>
                </iterate>
                <entity-find entity-name="mantle.humanres.employment.PayrollAdjustmentAndDetail" list="taxRateListEV">
                    <econdition field-name="payrollAdjustmentId" value="ClImpSegCatClClp"/>
                    <date-filter valid-date="new java.sql.Timestamp(timePeriod.fromDate.time)"/>
                </entity-find>
            </if>
            <set field="monthRateList" from="[]"/>
            <set field="biweekRateList" from="[]"/>
            <set field="weekRateList" from="[]"/>
            <set field="dayRateList" from="[]"/>
            <iterate entry="tr" list="taxRateListEV">
                <script>
                    monthRateList.add([rate:tr.rate, periodMin:tr.periodMin, periodMax:tr.periodMax, flatAmount:tr.flatAmount])
                    biweekRateList.add([rate:tr.rate, periodMin:(tr.periodMin?:0)/2, periodMax:(tr.periodMax?:0)/2, flatAmount:(tr.flatAmount?:0)/2])
                    weekRateList.add([rate:tr.rate, periodMin:(tr.periodMin?:0)/30*7, periodMax:(tr.periodMax?:0)/30*7, flatAmount:(tr.flatAmount?:0)/30*7])
                    dayRateList.add([rate:tr.rate, periodMin:(tr.periodMin?:0)/30, periodMax:(tr.periodMax?:0)/30, flatAmount:(tr.flatAmount?:0)/30])
                </script>
            </iterate>
            <set field="taxRateListMap" from="[PayrollMonth:monthRateList, PayrollBiweek:biweekRateList, PayrollWeek:weekRateList, PayrollDay:dayRateList]"/>
        </actions>
    </service>

    <service verb="get" noun="PayrollPeriodTypes">
        <out-parameters>
            <parameter name="payrollPeriodTypes"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.party.time.TimePeriodType" list="timePeriodTypeList">
                <econdition field-name="periodPurposeEnumId" value="Payroll"/>
            </entity-find>
            <set field="payrollPeriodTypes" from="timePeriodTypeList.timePeriodTypeId"/>
        </actions>
    </service>

    <service verb="prepare" noun="PensionFundAdjustments">
        <in-parameters>
            <parameter name="timePeriodId"/>
            <parameter name="topeImponibleAfp" required="true" type="BigDecimal"/>
            <parameter name="topeImponibleAfc" required="true" type="BigDecimal"/>
            <parameter name="tasaSis" required="true" type="BigDecimal"/>
            <parameter name="periodFromDate" required="true" type="Timestamp"/>
            <parameter name="periodThruDate" required="true" type="Timestamp"/>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="timePeriodTypeId" required="true"/>
            <parameter name="tasaAfcContratoIndefinidoEmpleador" required="true" type="BigDecimal"/>
            <parameter name="tasaAfcContratoIndefinidoTrabajador" required="true" type="BigDecimal"/>
            <parameter name="tasaAfcContratoFijoEmpleador" required="true" type="BigDecimal"/>
            <parameter name="tasaAfcContratoFijoTrabajador" required="true" type="BigDecimal"/>
            <parameter name="tasaAfcContrato11AnosEmpleador" required="true" type="BigDecimal"/>
            <parameter name="tasaAfcContrato11AnosTrabajador" required="true" type="BigDecimal"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.PartyRelationship" value-field="partyRelationship"/>
            <entity-find-one entity-name="mantle.humanres.employment.Employment" value-field="employment"/>

            <set field="affiliationTypeEnumId" value="MchCeaPensionFund"/>
            <set field="employeePartyId" from="partyRelationship.fromPartyId"/>
            <entity-find entity-name="mchile.humanteam.employment.EmployeeAffiliation" list="emplAffList">
                <econdition field-name="fromDate" operator="less-equals" from="periodThruDate"/>
                <econdition field-name="thruDate" operator="greater-equals" from="periodFromDate" or-null="true"/>
                <econdition field-name="affiliationTypeEnumId"/>
                <econdition field-name="employeePartyId"/>
                <order-by field-name="-fromDate"/>
            </entity-find>
            <set field="emplAff" from="emplAffList.first"/>
            <if condition="emplAff == null"><return error="true" message="Found no definition of Isapre for employee ${employeePartyId}"/></if>
            <set field="afpPartyId" from="emplAff.organizationPartyId"/>
            <entity-find-one entity-name="mantle.party.Organization" value-field="afpOrg"><field-map field-name="partyId" from="afpPartyId"/></entity-find-one>
            <set field="afpName" from="afpOrg.organizationName"/>
            <set field="baseMap" from="[fromDate:periodFromDate, thruDate:periodThruDate, partyRelationshipId:partyRelationshipId,
                                        timePeriodTypeId:timePeriodTypeId, isAutoGenerated:'Y', isTax:'N', isTaxable:'N', isSocialTax:'N',
                                        isSocialTaxable:'N', isMedicalTax:'N', isMedicalTaxable:'N', rateBasisEnumId:'PrbsIncome', payeeDueDays:13,
                                        itemTypeEnumId:'ItemClAfp', payeePartyId:afpPartyId]"/>

            <entity-find entity-name="mchile.humanteam.payroll.AfpRate" list="afpRateList">
                <econdition field-name="afpPartyId" from="emplAff.organizationPartyId"/>
                <date-filter valid-date="periodFromDate"/>
                <order-by field-name="-fromDate"/>
            </entity-find>
            <if condition="!afpRateList"><return error="true" message="No AfpRate found for Afp ${emplAff.organizationPartyId} at ${timePeriod.fromDate}"/></if>
            <set field="afpRate" from="afpRateList.first"/>
            <set field="maxAfpAmount" from="(topeImponibleAfp * afpRate.rate /100).setScale(0, BigDecimal.ROUND_HALF_UP)"/>

            <set field="description" value="Cotización Previsional (AFP ${afpName})"/>

            <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[isEmployerPaid:'N', description:description]" out-map="adj"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-afpRate.rate/100, periodMax:topeImponibleAfp]"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'02', flatAmount:-maxAfpAmount, periodMin:topeImponibleAfp]"/>

            <!-- Sis -->
            <set field="maxSisAmount" from="(tasaSis/100 * topeImponibleAfp).setScale(0, BigDecimal.ROUND_HALF_UP)"/>
            <set field="description" value="Seguro de Invalidez y Sobrevivencia"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[isEmployerPaid:'Y', description:description]" out-map="adj"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-tasaSis/100, periodMax:topeImponibleAfp]"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'02', flatAmount:-maxSisAmount, periodMin:topeImponibleAfp]"/>

            <!-- Afc -->
            <set field="afcRateEmpleador" from="null"/>
            <set field="afcRateTrabajador" from="null"/>
            <if condition="employment.employmentDurationTypeEnumId == 'MchedtPlazoIndefinido'"><then>
                <set field="afcRateEmpleador" from="tasaAfcContratoIndefinidoEmpleador"/>
                <set field="afcRateTrabajador" from="tasaAfcContratoIndefinidoTrabajador"/>
            </then><else-if condition="employment.employmentDurationTypeEnumId == 'MchedtPlazoFijo'">
                <set field="afcRateEmpleador" from="tasaAfcContratoFijoEmpleador"/>
                <set field="afcRateTrabajador" from="tasaAfcContratoFijoTrabajador"/>
            </else-if><else-if condition="employment.employmentDurationTypeEnumId == 'MchedtPlazoIndefinido11Anos'">
                <set field="afcRateEmpleador" from="tasaAfcContrato11AnosEmpleador"/>
                <set field="afcRateTrabajador" from="tasaAfcContrato11AnosTrabajador"/>
            </else-if><else>
                <return error="true" message="Unknown employmentDurationType ${employment.employmentDurationTypeEnumId}"/>
            </else></if>
            <set field="maxAfcAmountEmpleador" from="(topeImponibleAfc * afcRateEmpleador /100).setScale(0, BigDecimal.ROUND_HALF_UP)"/>
            <set field="maxAfcAmountTrabajador" from="(topeImponibleAfc * afcRateTrabajador /100).setScale(0, BigDecimal.ROUND_HALF_UP)"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[isEmployerPaid:'Y', description:'Seguro de Cesantía de cargo del empleador (AFC)']" out-map="adj"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-afcRateEmpleador/100, periodMax:topeImponibleAfc]"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'02', flatAmount:-maxAfcAmountEmpleador, periodMin:topeImponibleAfc]"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[isEmployerPaid:'N', description:'Seguro de Cesantía de cargo del trabajador (AFC)']" out-map="adj"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-afcRateTrabajador/100, periodMax:topeImponibleAfc]"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'02', flatAmount:-maxAfcAmountTrabajador, periodMin:topeImponibleAfc]"/>
        </actions>
    </service>

    <service verb="prepare" noun="HealthAdjustments">
        <in-parameters>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="timePeriodId" required="true"/>
            <parameter name="employment" required="true"/>
            <parameter name="topeImponibleAfp" required="true" type="BigDecimal"/>
            <parameter name="periodFromDate" required="true" type="Timestamp"/>
            <parameter name="periodThruDate" required="true" type="Timestamp"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/>
            <entity-find-one entity-name="mantle.party.PartyRelationship" value-field="employment"/>
            <service-call name="mchile.humanteam.PayrollServices.get#DaysWorked" in-map="[partyRelationshipId:partyRelationshipId, timePeriodId:timePeriodId]" out-map="context"/>
            <set field="workedProportion" from="(30-daysMissedIllness)/30"/>

            <set field="employeePartyId" from="employment.fromPartyId"/>
            <set field="affiliationTypeEnumId" value="MchCeaHealth"/>
            <entity-find entity-name="mchile.humanteam.employment.EmployeeAffiliation" list="emplAffList">
                <econdition field-name="fromDate" operator="less-equals" from="timePeriod.thruDate"/>
                <econdition field-name="thruDate" operator="greater-equals" from="timePeriod.fromDate" or-null="true"/>
                <econdition field-name="affiliationTypeEnumId"/>
                <econdition field-name="employeePartyId"/>
                <order-by field-name="-fromDate"/>
            </entity-find>

            <set field="legalAmount" from="(topeImponibleAfp * 7 / 100).setScale(0, BigDecimal.ROUND_HALF_UP)"/>
            <set field="baseMap" from="[fromDate:periodFromDate, thruDate:periodThruDate, partyRelationshipId:partyRelationshipId,
                                        timePeriodTypeId:timePeriodTypeId, isAutoGenerated:'Y', isTax:'N', isTaxable:'N', isSocialTax:'N',
                                        isSocialTaxable:'N', isMedicalTax:'N', isMedicalTaxable:'N', rateBasisEnumId:'PrbsIncome', payeeDueDays:13,
                                        itemTypeEnumId:'ItemClIsapre', payeePartyId:afpPartyId, isEmployerPaid:'N',
                                        timePeriodTypeId:timePeriod.timePeriodTypeId]"/>
            <set field="emplAff" from="emplAffList.first"/>
            <if condition="emplAff == null"><then>
                <set field="baseMap.payeePartyId" value="CHLSSAL-FONASA"/>
                <set field="compulsoryDescription" value="Cotización Salud obligatoria (Fonasa)"/>
                <set field="compulsoryAmount" from="-legalAmount*workedProportion"/>
                <set field="voluntaryAmount" from="0"/>
            </then><else>
                <entity-find-one entity-name="mantle.party.Organization" value-field="isapreOrg"><field-map field-name="partyId" from="emplAff.organizationPartyId"/></entity-find-one>
                <if condition="isapreOrg == null"><return error="true" message="Could not find organization for Affiliation ${emplAff}"/></if>
                <set field="isapreName" from="isapreOrg.organizationName"/>
                <set field="baseMap.payeePartyId" from="emplAff.organizationPartyId"/>
                <set field="compulsoryDescription" value="Cotización Salud obligatoria (Isapre ${isapreName})"/>
                <set field="voluntaryDescription" value="Cotización Salud adicional (Isapre ${isapreName})"/>
                <if condition="emplAff.currencyUomId == 'CLF'"><then>
                    <service-call name="mchile.humanteam.PayrollServices.get#PeriodParameters" in-map="[timePeriodId:timePeriodId]" out-map="pp"/>
                    <set field="totalAmount" from="(pp.periodUfValue*emplAff.amount*workedProportion).setScale(0, BigDecimal.ROUND_HALF_UP)"/>
                </then><else-if condition="emplAff.currencyUomId == 'CLP'">
                    <set field="totalAmount" from="(emplAff.amount*workedProportion).setScale(0, BigDecimal.ROUND_HALF_UP)"/>
                </else-if><else>
                    <return error="true" message="Unsupported currency while processing EmployeeAffiliation ${emplAff}"/>
                </else></if>
                <if condition="totalAmount > legalAmount"><then>
                    <!-- Se agrega un adicional -->
                    <set field="compulsoryAmount" from="-legalAmount"/>
                    <set field="voluntaryAmount" from="legalAmount-totalAmount"/>
                </then><else>
                    <set field="compulsoryAmount" from="-legalAmount"/>
                    <set field="voluntaryAmount" from="0"/>
                </else></if>
            </else></if>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[description:compulsoryDescription]" out-map="adj"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-0.07, periodMax:topeImponibleAfp]"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'02', flatAmount:compulsoryAmount, periodMin:topeImponibleAfp]"/>
            <if condition="voluntaryAmount">
                <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[description:voluntaryDescription]" out-map="adj"/>
                <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', flatAmount:voluntaryAmount]"/>
            </if>
        </actions>
    </service>

    <service verb="prepare" noun="MutualAdjustments">
        <in-parameters>
            <parameter name="timePeriodId" required="true"/>
            <parameter name="tasaSeguroAccidentesOrdinaria" required="true" type="BigDecimal"/>
            <parameter name="tasaSeguroAccidentesExtraordinaria" required="true" type="BigDecimal"/>
            <parameter name="tasaSanna" required="true" type="BigDecimal"/>
            <parameter name="periodFromDate" type="Timestamp"/>
            <parameter name="periodThruDate" type="Timestamp"/>
        </in-parameters>
        <out-parameters>
            <parameter name="adjustmentList" type="List"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/>
            <set field="partyId" from="timePeriod.partyId"/>
            <entity-find entity-name="mchile.humanteam.employment.EmployerAffiliation" list="employerMutualList">
                <econdition field-name="employerPartyId" from="partyId"/>
                <econdition field-name="affiliationTypeEnumId" value="MchCeaMutual"/>
                <date-filter/>
                <order-by field-name="-fromDate"/>
            </entity-find>
            <set field="payeePartyId" from="(employerMutualList.first?.organizationPartyId) ?: 'CL_IPS'"/>
            <set field="additionalRate" from="(employerMutualList.first?.additionalRate) ?: 0"/>
            <set field="baseMap" from="[fromDate:timePeriod.fromDate, thruDate:thruDate, organizationPartyId:timePeriod.partyId, isEmployerPaid:'Y',
                                        isTax:'N', isTaxable:'N', isSocialTax:'N', timePeriodTypeId:timePeriod.timePeriodTypeId,
                                        isSocialTaxable:'N', isMedicalTax:'N', isMedicalTaxable:'N', rateBasisEnumId:'PrbsMedical', payeeDueDays:13,
                                        itemTypeEnumId:'ItemClMutual', payeePartyId:payeePartyId, isAutoGenerated:'Y', itemTypeEnumId:'ItemClMutual',
                                        description:'Seguro de Accidentes del Trabajo y Sanna']"/>

            <set field="rate" from="tasaSeguroAccidentesOrdinaria + tasaSeguroAccidentesExtraordinaria + tasaSanna + additionalRate" type="BigDecimal"/>

            <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap" out-map="adj"/>
            <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:rate/100]"/>
        </actions>
    </service>

    <service verb="prepare" noun="OvertimeAdjustments">
        <in-parameters>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="timePeriodId" required="true"/>
            <parameter name="employment" required="true"/>
        </in-parameters>
        <actions>
        </actions>
    </service>

    <service verb="get" noun="DaysWorked">
        <in-parameters>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="timePeriodId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="daysWorked" type="BigDecimal"/>
            <parameter name="daysMissedIllness" type="BigDecimal"/>
            <parameter name="daysMissedLeave" type="BigDecimal"/>
            <parameter name="daysMissedEmployment" type="BigDecimal"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriodAndType" value-field="timePeriod"/>
            <entity-find-one entity-name="mantle.humanres.employment.EmploymentAndRelationship" value-field="employment"/>
            <!-- Find days worked -->
            <entity-find entity-name="mchile.humanteam.employment.LeaveDetail" list="leaveList">
                <econdition field-name="partyRelationshipId"/>
                <econdition field-name="fromDate" operator="less-equals" from="timePeriod.thruDate"/>
                <econdition field-name="thruDate" operator="greater-equals" from="timePeriod.fromDate"/>
                <econdition field-name="changeReasonEnumId" operator="in" from="['PcrLeave', 'PcrIllness']"/>
            </entity-find>
            <set field="daysMissed" from="0" type="BigDecimal"/>
            <set field="daysMissedLeave" from="0" type="BigDecimal"/>
            <set field="daysMissedIllness" from="0" type="BigDecimal"/>
            <iterate entry="leave" list="leaveList">
                <set field="fromDate" from="leave.fromDate.before(timePeriod.fromDate)? timePeriod.fromDate: leave.fromDate"/>
                <set field="thruDate" from="leave.thruDate.after(timePeriod.thruDate)? timePeriod.thruDate: leave.thruDate"/>
                <set field="diffAmount" from="(leave.diffAmount*(thruDate.time-fromDate.time)/(leave.thruDate.time-leave.fromDate.time)).setScale(1, BigDecimal.ROUND_HALF_UP)"/>
                <script>
                    daysMissed -= diffAmount
                    if (leave.changeReasonEnumId == 'PcrLeave') daysMissedLeave -= diffAmount
                    else if (leave.changeReasonEnumId == 'PcrIllness') daysMissedIllness -= diffAmount
                    else ec.message.addError("Unknown changeReasonEnumId: ${leave.changeReasonEnumId}")
                </script>
            </iterate>
            <set field="daysMissedEmployment" from="0" type="BigDecimal"/>
            <if condition="employment.fromDate &gt; timePeriod.fromDate || (employment.thruDate &amp;&amp; employment.thruDate &lt; timePeriod.thruDate)">
                <set field="effectiveFromDate" from="employment.fromDate &gt; timePeriod.fromDate? employment.fromDate: timePeriod.fromDate"/>
                <set field="effectiveThruDate" from="(employment.thruDate &amp;&amp; employment.thruDate &lt; timePeriod.thruDate)? employment.thruDate: new java.sql.Timestamp(timePeriod.thruDate.time+24*60*60*1000-1)"/>
                <set field="daysMissedEmployment" from="30 - ((effectiveThruDate.time - effectiveFromDate.time) / (24*60*60*1000)).setScale(1, BigDecimal.ROUND_HALF_UP)" type="BigDecimal"/>
                <set field="daysMissed" from="daysMissed + daysMissedEmployment"/>
            </if>
            <set field="daysWorked" from="30-daysMissed"/>
        </actions>
    </service>

    <service verb="get" noun="EmployeeReceiptDisplayInfo">
        <in-parameters>
            <parameter name="timePeriodId"/>
            <parameter name="partyIdList"/>
            <parameter name="copies" default="2" type="Integer"/>
        </in-parameters>
        <out-parameters>
            <parameter name="timePeriodTypeDescription"/>
            <parameter name="timePeriodMonth"/>
            <parameter name="timePeriodYear"/>
            <parameter name="employeeReceiptList" type="List">
                <parameter name="employee" type="Map"/>
                <parameter name="invoice" type="Map"/>
                <parameter name="employeeRut"/>
                <parameter name="employerRut"/>
                <parameter name="currencyUomId"/>
                <parameter name="haberesImponibles" type="List"/>
                <parameter name="haberesNoImponibles" type="List"/>
                <parameter name="descuentos" type="List"/>
                <parameter name="baseSalary" type="BigDecimal"/>
                <parameter name="daysWorked" type="BigDecimal"/>
                <parameter name="baseSalaryWorked" type="BigDecimal"/>
                <parameter name="totalHaberesImponibles" type="BigDecimal"/>
                <parameter name="totalHaberesNoImponibles" type="BigDecimal"/>
                <parameter name="totalDescuentos" type="BigDecimal"/>
                <parameter name="copyList"/>
            </parameter>
        </out-parameters>
        <actions>
            <set field="currentCopy" from="1"/>
            <if condition="copies &lt; 1"><return error="true" message="Copies has to be a positive Integer"/></if>
            <set field="copyList" from="[]"/>
            <while condition="currentCopy &lt;= copies">
                <script>
                    copyList.add(currentCopy)
                    currentCopy++
                </script>
            </while>
            <entity-find-one entity-name="mantle.party.time.TimePeriodAndType" value-field="timePeriod"/>
            <set field="timePeriodMonth" from="ec.l10n.format(timePeriod.fromDate, 'MMMM')"/>
            <set field="timePeriodYear" from="ec.l10n.format(timePeriod.fromDate, 'yyyy')"/>
            <entity-find entity-name="mantle.account.invoice.Invoice" list="invoiceList">
                <econdition field-name="timePeriodId"/>
                <econdition field-name="invoiceTypeEnumId" value="InvoicePayroll"/>
                <econdition field-name="fromPartyId" operator="in" ignore-if-empty="true" from="partyIdList"/>
            </entity-find>
            <set field="employeeReceiptList" from="[]"/>
            <iterate list="invoiceList" entry="invoice">
                <set field="currencyUomId" from="invoice.currencyUomId"/>
                <entity-find entity-name="mantle.humanres.employment.EmploymentSalary" list="employmentSalaryList">
                    <econdition field-name="partyRelationshipId" from="invoice.partyRelationshipId"/>
                    <econdition field-name="fromDate" operator="less-equals" from="timePeriod.thruDate"/>
                    <econdition field-name="thruDate" operator="greater-equals" from="timePeriod.fromDate" or-null="true"/>
                </entity-find>
                <if condition="employmentSalaryList.size() > 1"><return error="true" message="Unsupported salary change mid-period"/></if>
                <set field="baseSalary" from="employmentSalaryList.first.amount"/>
                <set field="employee" from="invoice.fromParty"/>
                <set field="employeeRutRaw" from="employee.identifications.findAll { it.partyIdTypeEnumId == 'PtidNationalTaxId' }.first.idValue"/>
                <service-call name="mchile.GeneralServices.format#Rut" in-map="[rut:employeeRutRaw]" out-map="formattedRut"/>
                <set field="employeeRut" from="formattedRut.rut"/>
                <set field="employerRutRaw" from="invoice.toParty.identifications.findAll { it.partyIdTypeEnumId == 'PtidNationalTaxId' }.first.idValue"/>
                <service-call name="mchile.GeneralServices.format#Rut" in-map="[rut:employerRutRaw]" out-map="formattedRut"/>
                <set field="employerRut" from="formattedRut.rut"/>
                <entity-find-one entity-name="mantle.party.PartyDetail" value-field="employeePartyDetail" auto-field-map="[partyId:employee.partyId]"/>
                <if condition="!employeeRut"><return error="true" message="No RUT for ${ec.resource.expand('PartyNameTemplate', null, employeePartyDetail)}"/></if>
                <entity-find-one entity-name="mantle.party.PartyDetail" value-field="employerPartyDetail" auto-field-map="[partyId:invoice.toPartyId]"/>
                <!-- Calculate base salary to be paid according to days worked -->
                <set field="baseSalaryWorked" from="invoice.items.findAll { it.itemTypeEnumId == 'ItemSalary'}.amount.sum()"/>
                <service-call name="mchile.humanteam.PayrollServices.get#DaysWorked" in-map="[partyRelationshipId:invoice.partyRelationshipId, timePeriodId:timePeriodId]" out-map="context"/>
                <entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItems">
                    <econdition field-name="invoiceId" from="invoice.invoiceId"/>
                    <order-by field-name="invoiceItemSeqId"/>
                </entity-find>
                <set field="haberesImponibles" from="[]"/>
                <set field="totalHaberesImponibles" from="0" type="BigDecimal"/>
                <set field="haberesNoImponibles" from="[]"/>
                <set field="totalHaberesNoImponibles" from="0" type="BigDecimal"/>
                <set field="descuentos" from="[]"/>
                <set field="totalDescuentos" from="0" type="BigDecimal"/>
                <iterate entry="item" list="invoiceItems">
                    <if condition="item.itemTypeEnumId == 'ItemSalary'"><then>
                        <set field="existingSalary" from="haberesImponibles.findAll { it.itemTypeEnumId == 'ItemSalary' }[0]"/>
                        <if condition="existingSalary"><then>
                            <set field="existingSalary.amount" from="existingSalary.amount + item.amount"/>
                        </then><else>
                            <script>haberesImponibles.add(item)</script>
                        </else></if>
                        <set field="totalHaberesImponibles" from="totalHaberesImponibles + item.quantity*item.amount"/>
                    </then><else-if condition="item.itemTypeEnumId in ['ItemAsignacionFamiliar', 'ItemPayrollNourishment', 'ItemPayrollCommuting']">
                        <script>
                            haberesNoImponibles.add(item)
                            totalHaberesNoImponibles += item.quantity*item.amount
                        </script>
                    </else-if><else-if condition="item.amount > 0">
                        <script>
                            haberesImponibles.add(item)
                            totalHaberesImponibles += item.quantity*item.amount
                        </script>
                    </else-if><else>
                        <script>
                            descuentos.add(item)
                            totalDescuentos += item.quantity*item.amount
                        </script>
                    </else></if>
                </iterate>
                <script>employeeReceiptList.add([employeeRut:employeeRut, employee:employee, employeePartyDetail:employeePartyDetail, employerPartyDetail:employerPartyDetail, employerRut:employerRut, baseSalary:baseSalary, daysWorked:daysWorked, baseSalaryWorked:baseSalaryWorked, totalHaberesImponibles:totalHaberesImponibles, totalHaberesNoImponibles:totalHaberesNoImponibles, totalDescuentos:totalDescuentos, currencyUomId:currencyUomId, haberesImponibles:haberesImponibles, haberesNoImponibles:haberesNoImponibles, descuentos:descuentos, invoice:invoice, copyList:copyList])</script>
            </iterate>
            <set field="invoiceId" from="invoiceList.first.invoiceId"/>
            <service-call name="mantle.account.InvoiceServices.get#InvoicePrintInfo" in-map="[invoiceId:invoiceId]" out-map="context"/>

            <set field="timePeriodTypeDescriptionMap" from="[PayrollMonth:'Mensual', PayrollBiWeek:'Quincenal', PayrollDay:'Diaria', PayrollWeek:'Semanal']"/>
            <set field="timePeriodTypeDescription" from="timePeriodTypeDescriptionMap[timePeriod.timePeriodTypeId]"/>
        </actions>
    </service>

    <service verb="prepare" noun="DaysWorkedAdjustments">
        <in-parameters>
            <parameter name="timePeriodId" required="true"/>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="employment" required="true"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/>
            <entity-find-one entity-name="mantle.party.PartyRelationship" value-field="employment"/>
            <set field="employeePartyId" from="employment.fromPartyId"/>
            <service-call name="mchile.humanteam.PayrollServices.get#DaysWorked" in-map="[partyRelationshipId:partyRelationshipId, timePeriodId:timePeriodId]" out-map="context"/>
            <set field="leaveReduceRate" from="daysMissedLeave/30"/>
            <set field="illnessReduceRate" from="daysMissedIllness/30"/>
            <set field="baseMap" from="[fromDate:timePeriod.fromDate, thruDate:timePeriod.thruDate, partyRelationshipId:partyRelationshipId,
                                        timePeriodTypeId:timePeriodTypeId, isAutoGenerated:'Y', isTax:'N', isTaxable:'Y', isSocialTax:'N',
                                        isMedicalTax:'N', isMedicalTaxable:'Y', rateBasisEnumId:'PrbsIncome', payeeDueDays:0,
                                        itemTypeEnumId:'ItemSalary', payrollPhaseEnumId:'PrphDeductible']"/>

            <if condition="leaveReduceRate">
                <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[isSocialTaxable:'Y', description:'Descuento por días no trabajados (Ausencias)']" out-map="adj"/>
                <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-leaveReduceRate]"/>
            </if>
            <if condition="illnessReduceRate">
                <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="baseMap+[isSocialTaxable:'N', description:'Descuento por días no trabajados (Licencias)']" out-map="adj"/>
                <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="[payrollAdjustmentId:adj.payrollAdjustmentId, detailSeqId:'01', rate:-illessReduceRate]"/>
            </if>
            <set field="totalReduceRate" from="(daysMissedLeave+daysMissedIllness+daysMissedEmployment)/30"/>
            <if condition="totalReduceRate">
                <set field="totalRate" from="1-totalReduceRate"/>
                <entity-find entity-name="mantle.humanres.employment.PayrollAdjustment" list="existingList">
                    <econdition field-name="itemTypeEnumId" operator="in" from="['ItemPayrollNourishment', 'ItemPayrollCommuting']"/>
                    <econdition field-name="partyRelationshipId"/>
                    <econdition field-name="fromDate" operator="less-equals" from="timePeriod.thruDate" or-null="true"/>
                    <econdition field-name="thruDate" operator="greater-equals" from="timePeriod.fromDate" or-null="true"/>
                    <econdition field-name="timePeriodTypeId" from="timePeriod.timePeriodTypeId"/>
                </entity-find>
                <log level="warn" message="Totalreducerate: ${totalReduceRate}"/>
                <iterate list="existingList" entry="adj">
                    <!-- Existing will not be ignored in calculation so we do not add another one -->
                    <if condition="adj.exclusiveByItemType == 'Y'"><continue/></if>
                    <log message="adj.exclusiveByItemType: ${adj.exclusiveByItemType}"/>
                    <script><![CDATA[
                        newMap = [:]
                        newMap.putAll(adj)
                        newMap.remove('payrollAdjustmentId')
                        newMap.exclusiveByItemType = 'Y'
                        newMap.isAutoGenerated = 'Y'
                    ]]></script>
                    <log message="newMap: ${newMap}"/>
                    <service-call name="create#mantle.humanres.employment.PayrollAdjustment" in-map="newMap" out-map="newAdj"/>
                    <set field="existingDetailList" from="adj.details"/>
                    <iterate list="existingDetailList" entry="detail">
                        <script><![CDATA[
                            newDetailMap = [:]
                            newDetailMap.putAll(detail)
                            newDetailMap.payrollAdjustmentId = newAdj.payrollAdjustmentId
                            if (detail.flatAmount != null) newDetailMap.flatAmount = (totalRate*detail.flatAmount).setScale(0, BigDecimal.ROUND_HALF_UP)
                            if (detail.periodMin != null) newDetailMap.periodMin = (totalRate*detail.periodMin).setScale(0, BigDecimal.ROUND_HALF_UP)
                            if (detail.periodMax != null) newDetailMap.periodMax = (totalRate*detail.periodMax).setScale(0, BigDecimal.ROUND_HALF_UP)
                        ]]></script>
                        <service-call name="create#mantle.humanres.employment.PayrollAdjustmentDetail" in-map="newDetailMap"/>
                    </iterate>
                </iterate>
            </if>
        </actions>
    </service>

    <service verb="process" noun="TimePeriodPay">
        <in-parameters>
            <parameter name="timePeriodId" required="true"/>
        </in-parameters>
        <actions>
            <service-call name="mchile.humanteam.PayrollServices.get#PeriodParameters" in-map="[timePeriodId:timePeriodId]" out-map="context"/>

            <!-- Add employer-wide mutual adjustment -->
            <service-call name="mchile.humanteam.PayrollServices.prepare#MutualAdjustments" in-map="context"/>
            <service-call name="mantle.humanres.PayrollServices.get#TimePeriodEmployments" in-map="context" out-map="context"/>
            <set field="timePeriodTypeId" from="timePeriod.timePeriodTypeId"/>
            <iterate list="employmentList" entry="employment">
                <set field="partyRelationshipId" from="employment.partyRelationshipId"/>
                <service-call name="mchile.humanteam.PayrollServices.prepare#PensionFundAdjustments" in-map="context"/>
                <service-call name="mchile.humanteam.PayrollServices.prepare#HealthAdjustments" in-map="context"/>
                <service-call name="mchile.humanteam.PayrollServices.prepare#DaysWorkedAdjustments" in-map="context"/>
                <service-call name="mchile.humanteam.PayrollServices.prepare#DaysWorkedAdjustments" in-map="context"/>
            </iterate>

            <service-call name="mantle.humanres.PayrollServices.process#TimePeriodPay" in-map="context+[validatePeriodEnded:false]" out-map="context"/>

        </actions>
    </service>

    <service verb="reopen" noun="PayrollPeriod">
        <in-parameters>
            <parameter name="timePeriodId" required="true"/>
        </in-parameters>
        <actions>
            <service-call name="mantle.humanres.PayrollServices.reopen#PayrollPeriod" in-map="context" out-map="context"/>
            <entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/>
            <entity-find entity-name="mantle.humanres.employment.EmploymentFromDetail" list="employmentList">
                <econdition field-name="toPartyId" from="timePeriod.partyId"/>
                <econdition field-name="timePeriodTypeId" from="timePeriod.timePeriodTypeId"/>
                <econdition field-name="fromDate" operator="less-equals" from="timePeriod.thruDate" or-null="true"/>
                <econdition field-name="thruDate" operator="greater-equals" from="timePeriod.fromDate" or-null="true"/>
                <order-by field-name="pseudoId"/>
            </entity-find>
            <entity-find entity-name="mantle.humanres.employment.PayrollAdjustment" list="autoAdjustmentList" for-update="true">
                <econditions combine="or">
                    <econdition field-name="organizationPartyId" from="timePeriod.partyId"/>
                    <econdition field-name="partyRelationshipId" operator="in" from="employmentList.partyRelationshipId"/>
                </econditions>
                <econdition field-name="isAutoGenerated" value="Y"/>
                <econdition field-name="fromDate" operator="less-equals" from="timePeriod.thruDate" or-null="true"/>
                <econdition field-name="thruDate" operator="greater-equals" from="timePeriod.fromDate" or-null="true"/>
                <econdition field-name="timePeriodTypeId" from="timePeriod.timePeriodTypeId" or-null="true"/>
            </entity-find>
            <iterate list="autoAdjustmentList" entry="adj">
                <set field="detailList" from="adj.details"/>
                <iterate list="detailList" entry="detail">
                    <entity-delete value-field="detail"/>
                </iterate>
                <entity-delete value-field="adj"/>
            </iterate>
        </actions>
    </service>

    <service verb="get" noun="PayrollPeriodDisplayData">
        <in-parameters>
            <parameter name="timePeriodId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="totalsByCategory" type="Map"/>
            <parameter name="periodInvoiceList" type="List"/>
            <parameter name="timePeriod" type="Map"/>
            <parameter name="employerDetail" type="Map"/>
            <parameter name="categoryDescr" type="Map"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriodAndType" value-field="timePeriod"/>
            <entity-find-one entity-name="mantle.party.PartyDetail" value-field="employerDetail" auto-field-map="[partyId:timePeriod.partyId]"/>
            <entity-find entity-name="mantle.account.invoice.Invoice" list="invoiceList">
                <econdition field-name="timePeriodId"/>
            </entity-find>
            <set field="totalsByCategory" from="[:]"/>
            <set field="amountEmployees" from="0"/>
            <set field="total" from="0" type="BigDecimal"/>
            <set field="unpaidTotal" from="0" type="BigDecimal"/>
            <iterate list="invoiceList" entry="invoice">
                <entity-find entity-name="mantle.party.PartyRole" list="partyRoleList">
                    <econdition field-name="partyId" from="invoice.fromPartyId"/>
                </entity-find>
                <set field="partyRoleIds" from="partyRoleList.roleTypeId"/>
                <if condition="invoice.invoiceTypeEnumId == 'InvoicePayroll'"><then>
                    <set field="key" value="employeePayroll"/>
                </then><else-if condition="partyRoleIds.contains('CHLAfp')">
                    <set field="key" value="AFP"/>
                </else-if><else-if condition="partyRoleIds.contains('CHLIsapre') || partyRoleList.contains('CHLFonasa')">
                    <set field="key" value="ISAPRE-FONASA"/>
                </else-if><else-if condition="partyRoleIds.contains('CHLAfc')">
                    <set field="key" value="AFC"/>
                </else-if><else>
                    <set field="key" from="invoice.fromPartyId"/>
                </else></if>
                <set field="totalsMap" from="totalsByCategory[key]"/>
                <if condition="currencyUomId &amp;&amp; currencyUomId != invoice.currencyUomId"><return error="true" message="Currency mismatch, have both ${currencyUomId} and ${invoice.currencyUomId}"/></if>
                <set field="currencyUomId" from="invoice.currencyUomId"/>
                <if condition="totalsMap == null">
                    <set field="totalsMap" from="[total:new BigDecimal(0), unpaid:new BigDecimal(0)]"/>
                    <set field="totalsByCategory[key]" from="totalsMap"/>
                </if>
                <script>
                    totalsMap['total'] = totalsMap['total'] + invoice.invoiceTotal
                    totalsMap['unpaid'] = totalsMap['unpaid'] + invoice.unpaidTotal
                    total += invoice.invoiceTotal
                    unpaidTotal += invoice.unpaidTotal
                </script>
            </iterate>
            <set field="categoryDescr" from="[employeePayroll:'Trabajadores', AFP:'AFPs', 'ISAPRE-FONASA':'Isapre/Fonasa', AFC:'AFC']"/>

            <entity-find entity-name="mantle.account.invoice.Invoice" list="periodInvoiceList">
                <search-form-inputs/>
                <econdition field-name="timePeriodId"/>
            </entity-find>
        </actions>
    </service>

    <service verb="check" noun="TimePeriod" authenticate="anonymous-view">
        <in-parameters><parameter name="timePeriodId"/></in-parameters>
        <out-parameters><parameter name="isClosed" type="Boolean"/></out-parameters>
        <actions>
            <entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/>
            <set field="isClosed" from="timePeriod.isClosed == 'Y'"/>
        </actions>
    </service>

    <service verb="add" noun="Leave">
        <in-parameters>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="leaveTypeEnumId" required="true"/>
            <parameter name="changeReasonEnumId" required="true"/>
            <parameter name="fromDate" type="Timestamp" required="true"/>
            <parameter name="thruDate" type="Timestamp" required="true"/>
            <parameter name="diffAmount" type="BigDecimal"/>
            <parameter name="amountUomId" required="true"/>
            <parameter name="description"/>
        </in-parameters>
        <out-parameters>
            <parameter name="leaveDetailId"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                Calendar cal = Calendar.instance
                cal.setTimeInMillis(thruDate.time)
                cal.set(Calendar.HOUR_OF_DAY, 23)
                cal.set(Calendar.MINUTE, 59)
                cal.set(Calendar.SECOND, 59)
                cal.set(Calendar.MILLISECOND, 999)
                thruDate = new java.sql.Timestamp(cal.time.time)
            ]]></script>
            <entity-find-one entity-name="mantle.humanres.employment.EmploymentAndRelationship" value-field="employment"/>
            <entity-find entity-name="mantle.party.time.TimePeriod" list="timePeriodList">
                <econdition field-name="partyId" from="employment.toPartyId"/>
                <econdition field-name="timePeriodTypeId" from="employment.timePeriodTypeId"/>
                <econdition field-name="fromDate" operator="less-equals" from="thruDate"/>
                <econdition field-name="thruDate" operator="greater-equals" from="fromDate"/>
                <order-by field-name="fromDate"/>
            </entity-find>
            <if condition="timePeriodList.size() &lt; 1"><return error="true" message="Could not find TimePeriod for employment ${partyRelationshipId} for dates ${fromDate} - ${thruDate}"/></if>
            <iterate entry="timePeriod" list="timePeriodList">
                <if condition="timePeriod.isClosed == 'Y'"><return error="true" message="Cannot add Leave within a closed timePeriod (${timePeriod.timePeriodId} from ${timePeriod.fromDate} - ${timePeriod.thruDate})"/></if>
            </iterate>
            <set field="registrationDate" from="ec.user.nowTimestamp"/>
            <set field="diffAmount" from="diffAmount > 0? -diffAmount: diffAmount"/>
            <service-call name="create#mchile.humanteam.employment.LeaveDetail" in-map="context" out-map="context"/>
        </actions>
    </service>

    <service verb="remove" noun="Leave">
        <in-parameters>
            <parameter name="leaveDetailId"/>
        </in-parameters>
        <actions>
            <entity-find-one entity-name="mchile.humanteam.employment.LeaveDetail" value-field="leaveDetail"/>
            <entity-find-one entity-name="mantle.party.PartyRelationship" value-field="employment" auto-field-map="leaveDetail"/>
            <entity-find entity-name="mantle.party.time.TimePeriod" list="timePeriodList">
                <econdition field-name="partyId" from="employment.toPartyId"/>
                <econdition field-name="fromDate" operator="less-equals" from="leaveDetail.thruDate"/>
                <econdition field-name="thruDate" operator="greater-equals" from="leaveDetail.fromDate"/>
                <order-by field-name="fromDate"/>
            </entity-find>
            <iterate list="timePeriodList" entry="timePeriod">
                <if condition="timePeriod.isClosed == 'Y'">
                    <message type="warning" error="true">Cannot remove leave affecting closed time period ${timePeriod.timePeriodId} from ${timePeriod.fromDate} to ${timePeriod.thruDate}</message>
                </if>
            </iterate>
            <check-errors/>
            <service-call name="delete#mchile.humanteam.employment.LeaveDetail" in-map="context"/>
        </actions>
    </service>

    <service verb="add" noun="Overtime">
        <in-parameters>
            <parameter name="partyRelationshipId" required="true"/>
            <parameter name="fromDate" type="Timestamp" required="true"/>
            <parameter name="thruDate" type="Timestamp" required="true"/>
            <parameter name="overtimeHours" type="BigDecimal" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="overtimeId"/>
        </out-parameters>
        <actions>
            <service-call name="create#mchile.humanteam.employment.Overtime" in-map="context" out-map="context"/>
        </actions>
    </service>

</services>