<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="load" noun="DteFromDom" type="script" location="component://MoquiChile/service/mchile/sii/dte/groovy/loadDteFromDom.groovy">
        <in-parameters>
            <parameter name="createUnknownIssuer" default="true" type="Boolean"/>
            <parameter name="requireIssuerInternalOrg" default="false" type="Boolean"/>
            <parameter name="createUnknownReceiver" default="false" type="Boolean"/>
            <parameter name="requireReceiverInternalOrg" default="false" type="Boolean"/>
            <parameter name="domNode" type="org.w3c.dom.Node" required="true"/>
            <parameter name="pdfBytes" type="Object"/>
            <parameter name="rutEmisorCaratula"><description>Rut de emisor cuando documento es enviado en un EnviaDTE con su respectiva carátula</description></parameter>
            <parameter name="rutReceptorCaratula"><description>Rut de receptor cuando documento es enviado en un EnviaDTE con su respectiva carátula</description></parameter>
            <parameter name="envioId"><description>Si el DTE forma parte de un EnvioDTE, el ID de envío DTE recibido en la BD para asociar el documento a crear</description></parameter>
            <parameter name="envioRespuestaId"><description>Si el DTE forma parte de un EnvioDTE, el ID de envío Respuesta en la BD para asociar el documento a crear</description></parameter>
            <parameter name="invoiceStatusId" default-value="InvoiceReceived"/>
            <parameter name="ignoreSignatureErrors" type="Boolean" default="false"/>
            <parameter name="sendResponse" type="Boolean" default="false"/>
            <parameter name="organizationPartyIdAsOwnerWhenCreating"/>
            <parameter name="sentAuthStatusId" default-value="Ftd-SentAuthAccepted"/>
        </in-parameters>
        <out-parameters>
            <parameter name="tipoDte" type="Integer" required="true"/>
            <parameter name="folioDte" type="Integer" required="true"/>
            <parameter name="fechaEmision" required="true" type="Date"/>
            <parameter name="rutEmisor" required="true"/>
            <parameter name="rutReceptor" required="true"/>
            <parameter name="montoTotal" required="true"/>
            <parameter name="estadoRecepDte" required="true"/>
            <parameter name="isDuplicated" type="Boolean"/>
            <parameter name="recepDteGlosa" required="true"/>
            <parameter name="warningMessages" type="List"/>
            <parameter name="errorMessages" type="List"/>
            <parameter name="discrepancyMessages" type="List"/>
            <parameter name="internalErrors" type="List"/>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
    </service>

    <service verb="load" noun="DteFromFile">
        <description>
            Carga DTE recibida al sistema y llama a servicio que crea orden de compra + invoice correspondiente
        </description>
        <in-parameters>
            <parameter name="createUnknownIssuer" default="true" type="Boolean"/>
            <parameter name="requireIssuerInternalOrg" default="false" type="Boolean"/>
            <parameter name="createUnknownReceiver" default="false" type="Boolean"/>
            <parameter name="requireReceiverInternalOrg" default="false" type="Boolean"/>
            <parameter name="xml" type="Object" required="true"/>
            <parameter name="pdf" type="Object"/>
            <parameter name="attemptProductMatch" default-value="false" type="Boolean"/>
            <parameter name="ignoreSignatureErrors" default-value="false" type="Boolean"/>
        </in-parameters>
        <out-parameters>
            <parameter name="amountImportedOk" type="Integer"/>
            <parameter name="amountImportedWithDiscrepancies" type="Integer"/>
            <parameter name="amountRejected" type="Integer"/>
            <parameter name="importedEnvios" type="Integer"/>
        </out-parameters>
        <actions>
            <script><![CDATA[
                import cl.moit.dte.MoquiDTEUtils
                import org.moqui.resource.ResourceReference

                import javax.xml.xpath.XPath
                import javax.xml.xpath.XPathConstants
                import javax.xml.xpath.XPathFactory
                import javax.xml.xpath.XPathExpression
                import org.moqui.context.ExecutionContext

                Integer amountImportedOk = 0
                Integer amountImportedWithDiscrepancies = 0
                Integer amountRejected = 0
                Integer importedEnvios = 0

                xmlBytes = null
                if (xml instanceof org.apache.commons.fileupload.FileItem) {
                    xmlBytes = xml.get()
                    xmlFileName = xml.name
                } else if (xml instanceof ResourceReference) {
                    xmlBytes = xml.openStream().readAllBytes()
                    xmlFileName = xml.getFileName()
                } else if (xml instanceof String) {
                    rr = ec.resource.getLocationReference(xml)
                    xmlBytes = rr.openStream().readAllBytes()
                    xmlFileName = rr.getFileName()
                } else {
                    ec.logger.error("Cannot handle xml of type ${xml?.class}")
                }
                if (pdf instanceof org.apache.commons.fileupload.FileItem) {
                    pdfBytes = pdf.get()
                    pdfFileName = pdf.name
                } else if (pdf instanceof String) {
                    if (pdf.size() > 0) {
                        rr = ec.resource.getLocationReference(pdf)
                        pdfBytes = rr.openStream().readAllBytes()
                        pdfFileName = rr.getFileName()
                    }
                }

                if (xmlBytes) {
                    org.w3c.dom.Document doc = MoquiDTEUtils.parseDocument(xmlBytes)
                    org.w3c.dom.Element docElem = doc.getDocumentElement()
                    if (docElem.getNodeName() == "DTE") {
                        outMap = ec.service.sync().name("mchile.sii.dte.DteLoadServices.load#DteFromDom").parameters(context + [domNode: docElem]).call()
                        if (outMap.estadoRecepDte == 0)
                            amountImportedOk++
                        else if (outMap.estadoRecepDte == 2)
                            amountRejected++
                        else if (outMap.estadoRecepDte == 1)
                            amountImportedWithDiscrepancies++
                        else
                            ec.message.addError("estadoRecepDte no reconocido: ${estadoRecepDte}")
                    } else if (docElem.getNodeName() == "SetDTE") {
                        XPath xpath = XPathFactory.newInstance().newXPath()
                        xpath.setNamespaceContext(new MoquiDTEUtils.DefaultNamespaceContext().addNamespace("sii", "http://www.sii.cl/SiiDte"))
                        XPathExpression expression = xpath.compile("/sii:SetDTE/sii:DTE")
                        org.w3c.dom.NodeList dteNodeList = (org.w3c.dom.NodeList) expression.evaluate(docElem, XPathConstants.NODESET)
                        if (dteNodeList.length == 0) {
                            expression = xpath.compile("/SetDTE/DTE")
                            dteNodeList = (org.w3c.dom.NodeList) expression.evaluate(docElem, XPathConstants.NODESET)
                        }
                        dteNodeList.each { org.w3c.dom.Node domNode ->
                            outMap = ec.service.sync().name("mchile.sii.dte.DteLoadServices.load#DteFromDom").parameters(context + [domNode: domNode]).requireNewTransaction(true).call()
                            if (outMap.estadoRecepDte == 0)
                                amountImportedOk++
                            else if (outMap.estadoRecepDte == 2)
                                amountRejected++
                            else if (outMap.estadoRecepDte == 1)
                                amountImportedWithDiscrepancies++
                            else
                                ec.message.addError("estadoRecepDte no reconocido: ${estadoRecepDte}")
                        }
                        ec.message.addMessage("Procesados ${dteNodeList.length} DTEs")
                    } else if (docElem.getNodeName() in ['EnvioDTE', 'RESULTADO_ENVIO', 'RespuestaDTE', 'EnvioRecibos']) {
                        if (docElem.getNodeName() == 'EnvioDTE' && !MoquiDTEUtils.verifySignature(docElem, "/sii:EnvioDTE/sii:SetDTE", "./sii:Caratula/sii:TmstFirmaEnv/text()"))
                            ec.message.addMessage("Firma del envío inválida", "danger")
                        ec.service.sync().name("mchile.sii.dte.DteEnvioServices.store#ReceivedEnvio").parameters(context + [contentBytes: xmlBytes, fileName: xmlFileName]).call()
                        importedEnvios++
                    } else {
                        ec.message.addError("Unknown document ${docElem.getNodeName()}")
                    }
                }
                ec.message.addMessage("Importados: ${amountImportedOk}, Importados con Discrepancias: ${amountImportedWithDiscrepancies}, Rechazados: ${amountRejected}, Envios: ${importedEnvios}")
            ]]></script>
        </actions>
    </service>

    <service verb="create" noun="DteFromUrl">
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="invoiceId" required="true"/>
            <parameter name="contentLocation" required="true"/>
            <parameter name="contentDate" required="true"/>
            <parameter name="issuerPartyId"/>
            <parameter name="receiverPartyId"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="fiscalTaxDocumentNumber" required="true"/>
            <parameter name="fiscalTaxDocumentContentTypeEnumId" default="Ftdct-Pdf"/>
            <parameter name="indTrasladoEnumId" default-value="IndTraslado-5"/>
            <parameter name="tipoDespachoEnumId" default-value="TpoDespacho-3"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <log message="[create#DteFromFile] Reading tax document from ${contentLocation}"/>
            <script><![CDATA[
                URL url = new URL(contentLocation)
                URLConnection hc = url.openConnection()
                hc.setRequestProperty("User-Agent", "Mozilla/5.0")
                byte[] contentFile
                if (hc.getResponseCode().equals(200)) {
                    contentFile = hc.getInputStream().getBytes()
                }
                ]]></script>

            <log message="[create#DteFromFile] orderId: ${orderId}"/>

            <entity-find entity-name="mantle.order.OrderHeaderAndPart" list="orderList" distinct="true">
                <econdition field-name="orderId" from="orderId"/>
            </entity-find>
            <set field="order" from="orderList?.first"/>

            <set field="issuerPartyId" from="issuerPartyId ? issuerPartyId : order.vendorPartyId"/>
            <set field="receiverPartyId" from="receiverPartyId ? receiverPartyId : order.customerPartyId"/>

            <if condition="fiscalTaxDocumentContentTypeEnumId == 'Ftdct-Pdf'"><then>
                <set field="sentRecStatusId" value="Ftd-NotSentRec"/>
            </then><else-if condition="fiscalTaxDocumentContentTypeEnumId == 'Ftdct-Xml'">
                <set field="sentRecStatusId" value="Ftd-SentRec"/>
            </else-if><else>
                <set field="sentRecStatusId" from="null"/>
            </else></if>
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[partyId:issuerPartyId]" out-map="issuerRut"/>
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[partyId:receiverPartyId]" out-map="receiverRut"/>
            <set field="createMap" from="[issuerPartyId:issuerPartyId, issuerPartyIdTypeEnumId:'PtidNationalTaxId', issuerPartyIdValue:issuerRut.rutSinFormato,
                                          receiverPartyId:receiverPartyId, receiverPartyIdTypeEnumId:'PtidNationalTaxId', receiverPartyIdValue:receiverRut.rutSinFormato,
                                          fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber,
                                          statusId:'Ftd-Issued', sentAuthStatusId:'Ftd-SentAuthAccepted', sentRecStatusId:sentRecStatusId, date:contentDate, invoiceId:invoiceId,
                                          indTrasladoEnumId:indTrasladoEnumId, tipoDespachoEnumId:tipoDespachoEnumId]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocument" out-map="context" in-map="createMap"/>
            <set field="pdfContentLocation" value="dbresource://moit/erp/dte/${issuerRut?.rutSinFormato?:('partyId-'+issuerPartyId)}/DTE-${fiscalTaxDocumentTypeEnumId}-${fiscalTaxDocumentNumber}.pdf"/>
            <set field="createMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Pdf', contentLocation:pdfContentLocation, contentDate:contentDate]"/>
            <script>ec.resource.getLocationReference(pdfContentLocation).putBytes(contentFile)</script>
            <service-call name="create#mchile.dte.FiscalTaxDocumentContent" out-map="context" in-map="createMap"/>

            <set field="updateMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, emailEmisor:emailEmisor, amount:amount,
                                          montoNeto:montoNeto, tasaImpuesto:tasaImpuesto, tipoImpuesto:tipoImpuesto, razonSocial:razonSocial, fechaEmision:fechaEmision,
                                          documentoAnulado:documentoAnulado, montoExento:montoExento, montoIVARecuperable:montoIVARecuperable,
                                          codigoIVANoRecuperable:codigoIVANoRecuperable, montoIVANoRecuperable:montoIVANoRecuperable, montoIVAUsoComun:montoIVAUsoComun,
                                          codigoOtroImpuestoORetencion:codigoOtroImpuestoORetencion, tasaOtroImpuestoORetencion:tasaOtroImpuestoORetencion,
                                          montoOtroImpuestoORetencionConCredito:montoOtroImpuestoORetencionConCredito,
                                          montoOtroImpuestoORetencionSinCredito:montoOtroImpuestoORetencionSinCredito, montoNetoActivoFijo:montoNetoActivoFijo,
                                          montoIVAActivoFijo:montoIVAActivoFijo, montoIVANoRetenido:montoIVANoRetenido, codigoSucursal:codigoSucursal,
                                          notasDebitoCreditoFacturasCompra:notasDebitoCreditoFacturasCompra]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocumentAttributes" out-map="context" in-map="updateMap"/>

        </actions>
    </service>

    <service verb="load" noun="Dt">
        <description>
            Carga documento tributario en papel recibido de tercero
        </description>
        <in-parameters>
            <parameter name="fiscalTaxDocumentNumber" required="true"/>
            <parameter name="invoiceId"/>
            <parameter name="pdf" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="issuerPartyId" required="true"/>
            <parameter name="amount" required="true"/>
            <parameter name="fiscalTaxDocumentTypeEnumId" required="true"/>
            <parameter name="montoNeto"/>
            <parameter name="tasaImpuesto"/>
            <parameter name="tipoImpuesto"/>
            <!--parameter name="razonSocial"/-->
            <parameter name="fechaEmision" required="true" type="Date"/>
            <parameter name="documentoAnulado"/>
            <parameter name="montoExento"/>
            <parameter name="montoIVARecuperable"/>
            <parameter name="codigoIVANoRecuperable"/>
            <parameter name="montoIVANoRecuperable"/>
            <parameter name="montoIVAUsoComun"/>
            <parameter name="codigoOtroImpuestoORetencion"/>
            <parameter name="tasaOtroImpuestoORetencion"/>
            <parameter name="montoOtroImpuestoORetencionConCredito"/>
            <parameter name="montoOtroImpuestoORetencionSinCredito"/>
            <parameter name="montoNetoActivoFijo"/>
            <parameter name="montoIVAActivoFijo"/>
            <parameter name="montoIVANoRetenido"/>
            <parameter name="codigoSucursal"/>
            <parameter name="notasDebitoCreditoFacturasCompra"/>
            <parameter name="receiverPartyId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="fiscalTaxDocumentId"/>
        </out-parameters>
        <actions>
            <set field="archivoPdf" from="pdf.getName()"/>
            <service-call name="mchile.sii.dte.DteInternalServices.load#DteConfig" in-map="[partyId:receiverPartyId]" out-map="context"/>

            <set field="ts" from="ec.l10n.parseTimestamp(fechaEmision, 'yyyy-MM-dd')"/>

            <set field="purchaseOutMap" from="[:]"/>
            <set field="invoiceOutMap" from="[:]"/>

            <if condition="!invoiceId">
                <service-call name="mchile.PurchaseServices.create#Purchase" in-map="[vendorPartyId:issuerPartyId]" out-map="purchaseOutMap"/>
                <!-- TODO: ¿Faltan items? -->
                <service-call name="mantle.account.InvoiceServices.create#EntireOrderPartInvoice" in-map="[orderId:purchaseOutMap.orderId, orderPartSeqId:purchaseOutMap.orderPartSeqId]" out-map="invoiceOutMap"/>
                <set field="invoiceId" from="invoiceOutMap.invoiceId"/>
            </if>

            <!-- Creación de FiscalTaxDocument -->
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[partyId:issuerPartyId]" out-map="issuerRut"/>
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[partyId:receiverPartyId]" out-map="receiverRut"/>
            <set field="createMap" from="[issuerPartyId:issuerPartyId, issuerPartyIdTypeEnumId:'PtidNationalTaxId', issuerPartyIdValue:issuerRut.rutSinFormato, statusId:'Ftd-Issued',
                                          fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber,
                                          receiverPartyId:receiverPartyId, receiverPartyIdTypeEnumId:'PtidNationalTaxId', receiverPartyIdValue:receiverRut.rutSinFormato,
                                          date:ts, invoiceId:invoiceId]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocument" out-map="context" in-map="createMap"/>

            <!-- Creación de contenido (Solo PDF) -->
            <entity-find-one entity-name="moqui.basic.Enumeration" value-field="dteType" auto-field-map="[enumId:fiscalTaxDocumentTypeEnumId]"/>
            <set field="pdfContentLocation" value="dbresource://moit/erp/dte/${issuerRut?.rutSinFormato?:('partyId-'+issuerPartyId)}/DT-${dteType.enumCode}-${fiscalTaxDocumentNumber}.pdf"/>
            <set field="createMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, contentDate:ts, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml', contentLocation:pdfContentLocation]"/>
            <script>ec.resource.getLocationReference(pdfContentLocation).putStream(pdf.inputStream)</script>
            <service-call name="create#mchile.dte.FiscalTaxDocumentContent" out-map="context" in-map="createMap"/>

            <!-- Entrada en atributos -->
            <set field="updateMap" from="[fiscalTaxDocumentId:fiscalTaxDocumentId, emailEmisor:emailEmisor, amount:amount,
                                         montoNeto:montoNeto, tasaImpuesto:tasaImpuesto, tipoImpuesto:tipoImpuesto, razonSocial:razonSocial, fechaEmision:fechaEmision, documentoAnulado:documentoAnulado,
                                         montoExento:montoExento, montoIVARecuperable:montoIVARecuperable, codigoIVANoRecuperable:codigoIVANoRecuperable, montoIVANoRecuperable:montoIVANoRecuperable,
                                         montoIVAUsoComun:montoIVAUsoComun, codigoOtroImpuestoORetencion:codigoOtroImpuestoORetencion, tasaOtroImpuestoORetencion:tasaOtroImpuestoORetencion,
                                         montoOtroImpuestoORetencionConCredito:montoOtroImpuestoORetencionConCredito, montoOtroImpuestoORetencionSinCredito:montoOtroImpuestoORetencionSinCredito,
                                         montoNetoActivoFijo:montoNetoActivoFijo, montoIVAActivoFijo:montoIVAActivoFijo, montoIVANoRetenido:montoIVANoRetenido, codigoSucursal:codigoSucursal,
                                         notasDebitoCreditoFacturasCompra:notasDebitoCreditoFacturasCompra]"/>
            <service-call name="create#mchile.dte.FiscalTaxDocumentAttributes" out-map="context" in-map="updateMap"/>
        </actions>
    </service>

    <service verb="load" noun="DteContent">
        <description>
            Carga XML/PDF/PDF Cedible directo en la BD
        </description>
        <in-parameters>
            <parameter name="filename" type="org.apache.commons.fileupload.FileItem"/>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="fiscalTaxDocumentContentTypeEnumId" required="true"/>
        </in-parameters>
        <actions>
            <entity-find entity-name="mchile.dte.FiscalTaxDocumentContent" list="ftdtList">
                <econdition field-name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
                <econdition field-name="fiscalTaxDocumentContentTypeEnumId" from="fiscalTaxDocumentContentTypeEnumId"/>
            </entity-find>

            <entity-find-one entity-name="mchile.dte.FiscalTaxDocument" value-field="fiscalTaxDocument"/>
            <set field="tipoFactura" from="fiscalTaxDocument.FiscalTaxDocumentType.sequenceNum"/>
            <service-call name="mchile.GeneralServices.get#RutForParty" in-map="[rut:fiscalTaxDocument.issuerPartyId]" out-map="rut"/>
            <set field="rutEmisor" from="rut.rutSinFormato"/>

            <iterate list="ftdtList" entry="ftdtEntry">
                <set field="ftdtEntry.contentLocation" value="dbresource://moit/erp/dte/${rutEmisor}/DTE-${tipoFactura}-${folio}.xml"/>
                <script>
                    docRr = ec.resource.locationReference(ftdtEntry.contentLocation)
                    docRr.putStream(filename.getInputStream())
                </script>
                <entity-update value-field="ftdtEntry"/>
            </iterate>
        </actions>
    </service>

    <service verb="check" noun="Afecto">
        <in-parameters>
            <parameter name="productId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="afecto"/>
        </out-parameters>
        <actions>
            <set field="afecto" value="true"/>
            <entity-find entity-name="mantle.product.category.ProductCategoryMember" list="categoryMemberList">
                <econdition field-name="productId" from="productId"/>
                <econdition field-name="productCategoryId" value="ClVatTaxExento"/>
                <date-filter/>
            </entity-find>
            <if condition="categoryMemberList"><set field="afecto" value="false"/></if>
        </actions>
    </service>

    <service verb="parse" noun="Dte" type="script" location="component://MoquiChile/service/mchile/sii/dte/groovy/parseDte.groovy">
        <in-parameters>
            <parameter name="dte" type="Object" required="true"/>
            <parameter name="attemptProductMatch" default-value="false" type="Boolean"/>
        </in-parameters>
        <out-parameters>
            <parameter name="validSignature" type="Boolean"/>
            <parameter name="rutEmisor"/>
            <parameter name="razonSocialEmisor"/>
            <parameter name="giroEmisor"/>
            <parameter name="sucursalSiiEmisor"/>
            <parameter name="actividadEconomica"/>
            <parameter name="correoEmisor"/>
            <parameter name="direccionOrigen"/>
            <parameter name="comunaOrigen"/>
            <parameter name="ciudadOrigen"/>
            <parameter name="indicadorServicio"/>
            <parameter name="periodoDesde" type="Date"/>
            <parameter name="periodoHasta" type="Date"/>
            <parameter name="impuestosMap" type="Map"/>
            <parameter name="rutReceptor"/>
            <parameter name="tipoDte" type="Integer"/>
            <parameter name="folioDte" type="Integer"/>
            <parameter name="tipoDteEnumId"/>
            <parameter name="fechaEmision" type="Date"/>
            <parameter name="fechaVencimiento" type="Date"/>
            <parameter name="razonSocialReceptor"/>
            <parameter name="giroReceptor"/>
            <parameter name="codigoInternoReceptor"/>
            <parameter name="direccionReceptor"/>
            <parameter name="comunaReceptor"/>
            <parameter name="ciudadReceptor"/>
            <parameter name="detalleList" type="List"/>
            <parameter name="descuentoRecargoList" type="List"/>
            <parameter name="requiresManualIntervention" type="Boolean"/>
            <parameter name="fiscalTaxDocumentNumber" type="Integer"/>
            <parameter name="iva" type="BigDecimal"/>
            <parameter name="montoTotal" type="BigDecimal"/>
            <parameter name="montoNeto" type="BigDecimal"/>
            <parameter name="montoExento" type="BigDecimal"/>
            <parameter name="saldoAnterior" type="BigDecimal"/>
            <parameter name="valorAPagar" type="BigDecimal"/>
            <parameter name="tasaIva" type="BigDecimal"/>
            <parameter name="formaPago"/>
            <parameter name="indTrasladoEnumId"/>
            <parameter name="referenciaList" type="List"/>
            <parameter name="dteBytes" type="byte[]"/>
            <parameter name="errorMessages" type="List"/>
            <parameter name="discrepancyMessages" type="List"/>
        </out-parameters>
    </service>

    <service verb="create" noun="InvoiceFromDte">
        <in-parameters>
            <parameter name="fiscalTaxDocumentId" required="true"/>
            <parameter name="parsedDteXmlMap" type="Map"/>
            <parameter name="invoiceStatusId" default-value="InvoiceReceived"/>
            <parameter name="attemptProductMatch" default="false" type="Boolean"/>
        </in-parameters>
        <out-parameters>
            <parameter name="invoiceId"/>
            <parameter name="invoiceItemCount" type="Integer"/>
            <parameter name="discrepancyMessages" type="List"/>
        </out-parameters>
        <actions>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentAndAttributes" value-field="dte"/>
            <if condition="dte == null"><return error="true" message="Could not find FiscalTaxDocument ${fiscalTaxDocumentId}"/></if>
            <set field="discrepancyMessages" from="[]"/>
            <if condition="dte.fiscalTaxDocumentTypeEnumId == 'Ftdt-61'"><then>
                <set field="invoiceCreateMap" from="[fromPartyId:dte.receiverPartyId, toPartyId:dte.issuerPartyId, invoiceTypeEnumId:'InvoiceCreditMemo']"/>
            </then><else>
                <set field="invoiceCreateMap" from="[fromPartyId:dte.issuerPartyId, toPartyId:dte.receiverPartyId, invoiceTypeEnumId:'InvoiceSales']"/>
            </else></if>
            <if condition="parsedDteXmlMap"><then>
                <set field="detalleList" from="parsedDteXmlMap.detalleList"/>
                <set field="impuestosMap" from="parsedDteXmlMap.impuestosMap"/>
                <set field="descuentoRecargoList" from="parsedDteXmlMap.descuentoRecargoList"/>
                <set field="iva" from="parsedDteXmlMap.iva"/>
                <set field="montoTotal" from="parsedDteXmlMap.montoTotal"/>
                <set field="requiresManualIntervention" from="parsedDteXmlMap.requiresManualIntervention"/>
            </then><else>
                <return error="true" message="Parsing here is not yet supported"/>
            </else></if>
            <set field="invoiceCreateMap.invoiceDate" from="new Timestamp(dte.fechaEmision.time)"/>
            <set field="invoiceCreateMap.currencyUomId" value="CLP"/>
            <set field="invoiceCreateMap.invoiceStatusId" from="invoiceStatusId"/>
            <if condition="dte.fechaVencimiento">
                <set field="invoiceCreateMap.dueDate" from="new Timestamp(dte.fechaVencimiento.time)"/>
            </if>
            <set field="invoiceItemCount" from="0" type="Integer"/>
            <if condition="dte.fiscalTaxDocumentTypeEnumId in ['Ftdt-101', 'Ftdt-102', 'Ftdt-109', 'Ftdt-110', 'Ftdt-111', 'Ftdt-112', 'Ftdt-30', 'Ftdt-32', 'Ftdt-33', 'Ftdt-34', 'Ftdt-35', 'Ftdt-38', 'Ftdt-39']"><then>
                <service-call name="mantle.account.InvoiceServices.create#Invoice" in-map="invoiceCreateMap" disable-authz="true" out-map="context"/>
                <if condition="!invoiceId"><return error="true" message="Error creating Invoice"/></if>
            </then><else>
                <return message="Not creating invoice for document type ${dte.fiscalTaxDocumentTypeEnumId}"/>
            </else></if>

            <iterate list="detalleList" entry="detalle">
                <set field="itemMap" from="null"/>
                <if condition="!attemptProductMatch"><then>
                    <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, itemTypeEnumId:'ItemSales', dteQuantity:detalle.dteQuantity, dteAmount:detalle.dteAmount,
                                                       productId: (detalle.itemExento? 'SRVCEXENTO': null), description: detalle.itemName, quantity: detalle.quantity, amount: detalle.amount]" out-map="itemMap"/>
                    <if condition="detalle.itemDescription">
                        <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, itemTypeEnumId:'ItemDetailedDescription', description: detalle.itemDescription,
                                parentItemSeqId:itemMap.invoiceItemSeqId]" out-map="descriptionItemMap"/>
                    </if>
                    <set field="invoiceItemCount" from="invoiceItemCount + 1"/>
                </then><else>
                    <log message="Buscando código item"/>
                    <set field="k" from="0"/>
                    <set field="productId" from="null"/>
                    <iterate list="detalle.codigoMap" entry="codigo" key="tipoCodigo">
                        <set field="k" from="k+1"/>
                        <log message="Leyendo código ${k}, tipo ${tipoCodigo}, valor: ${codigo}"/>
                        <if condition="issuerIsInternalOrg"><then>
                            <entity-find-one entity-name="mantle.product.Product" auto-field-map="[pseudoId:codigo]" value-field="product"/>
                            <if condition="product">
                                <set field="productId" from="product.productId"/>
                                <break/></if>
                        </then><else>
                            <entity-find entity-name="mantle.product.ProductParty" list="productPartyList">
                                <econdition field-name="partyId" from="issuerPartyId"/>
                                <econdition field-name="otherPartyItemId" from="codigo"/>
                                <econdition field-name="roleTypeId" value="Supplier"/>
                                <date-filter valid-date="dte.fechaEmision"/>
                                <order-by field-name="-fromDate"/>
                            </entity-find>
                            <set field="productId" from="productPartyList.first?.partyId"/>
                            <break/>
                        </else></if>
                    </iterate>
                    <if condition="productId"><then>
                        <entity-find entity-name="mantle.product.category.ProductCategoryMember" list="exentoList">
                            <econdition field-name="productId"/>
                            <date-filter valid-date="dte.fechaEmision"/>
                        </entity-find>
                        <set field="exentoBd" from="exentoList.size() > 0"/>
                        <if condition="exentoBd != detalle.itemExento">
                            <script>discrepancyMessages.add("Exento mismatch, XML dice ${detalle.itemExento? '' : 'no '} exento, producto en BD dice ${exentoBd? '' : 'no '} exento")</script>
                        </if>
                        <entity-find-one entity-name="mantle.product.Product" value-field="product"/>
                        <if condition="product.productName.toString().trim().toLowerCase() != detalle.itemDescription.trim().toLowerCase()">
                            <script>discrepancyMessages.add("Description mismatch, XML dice ${detalle.itemDescription}, producto en BD dice ${product.productName}")</script>
                        </if>
                        <log message="Agregando producto preexistente ${productId}, cantidad ${detalle.quantity} *************** orderId: ${orderId}"/>
                    </then><else>
                        <if condition="detalle.itemExento">
                            <set field="productId" value="SRVCEXENTO"/>
                        </if>
                        <log level="warn" message="Producto ${detalle.itemDescription} no existe en el sistema, se creará como genérico"/>
                    </else></if>
                    <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, itemTypeEnumId:'ItemSales', dteQuantity:detalle.dteQuantity, dteAmount:detalle.dteAmount,
                                productId: productId, description: detalle.itemDescription, quantity: detalle.quantity, amount: detalle.amount]" out-map="itemMap"/>
                    <set field="invoiceItemCount" from="invoiceItemCount+1"/>
                </else></if>
                <if condition="detalle.descuentoMonto">
                    <set field="parentItemSeqId" from="itemMap.invoiceItemSeqId"/>
                    <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, parentItemSeqId:parentItemSeqId, itemTypeEnumId:'ItemDiscount',
                                    description: 'Descuento', quantity: 1, amount:-detalle.descuentoMonto]"/>
                    <set field="invoiceItemCount" from="invoiceItemCount+1"/>
                </if>
                <if condition="detalle.roundingAdjustmentItemAmount != 0">
                    <set field="description" value="Ajuste redondeo DTE (precio ${detalle.dteAmount?:detalle.price}, cantidad ${detalle.dteQuantity?:detalle.quantity}, montoItem ${detalle.montoItem}"/>
                    <if condition="itemMap?.invoiceItemSeqId == null"><then>
                        <message>Need to add rounding adjustment item but did not create a parent item, itemMap ${itemMap}, invoiceId: ${invoiceId}</message>
                        <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId  : invoiceId, itemTypeEnumId: 'ItemDteRoundingAdjust',
                                                                                                                    description: description, quantity: 1, amount: detalle.roundingAdjustmentItemAmount]"/>
                    </then><else>
                        <set field="parentItemSeqId" from="itemMap.invoiceItemSeqId"/>
                        <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, parentItemSeqId:parentItemSeqId, itemTypeEnumId:'ItemDteRoundingAdjust',
                                    description: description, quantity: 1, amount:detalle.roundingAdjustmentItemAmount]"/>
                    </else></if>
                </if>
            </iterate>

            <iterate list="impuestosMap" entry="impuestoMap" key="impuestoCode">
                <entity-find entity-name="moqui.basic.Enumeration" list="impuestoEnumList">
                    <econdition field-name="parentEnumId" value="ItemTCChlDte"/>
                    <econdition field-name="enumCode" from="impuestoCode"/>
                </entity-find>
                <set field="impuestoEnum" from="impuestoEnumList.first"/>
                <if condition="impuestoEnum == null"><then>
                    <script>internalErrors.add("Did not find impuesto for code ${impuestoCode}")</script>
                </then><else>
                    <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId  : invoiceId, itemTypeEnumId: impuestoEnum.enumId,
                                description: impuestoEnum.description, quantity: 1, amount: impuestoMap.monto]"/>
                    <set field="invoiceItemCount" from="invoiceItemCount+1"/>
                </else></if>
            </iterate>

            <iterate list="descuentoRecargoList" entry="item">
                <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, itemTypeEnumId: item.itemTypeEnumId, description: item.glosa, quantity: 1,
                            amount: item.amount]"/>
                <set field="invoiceItemCount" from="invoiceItemCount+1"/>
            </iterate>

            <set field="newInvoiceStatusId" from="requiresManualIntervention ? 'InvoiceRequiresManualIntervention' : null"/>

            <if condition="iva > 0">
                <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, itemTypeEnumId:'ItemVatTax', description: 'IVA', quantity: 1, amount: iva,
                            taxAuthorityId:'CL_SII']"/>
            </if>

            <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/>
            <if condition="invoice.invoiceTotal != montoTotal">
                <set field="diff" from="invoice.invoiceTotal - montoTotal"/>

                <if condition="diff == iva &amp;&amp; totalExento == montoExento">
                    <set field="factor" from="1-(diff/invoice.invoiceTotal)"/>
                    <entity-find entity-name="mantle.account.invoice.InvoiceItem" list="itemList" for-update="true">
                        <econdition field-name="invoiceId"/>
                    </entity-find>
                    <iterate list="itemList" entry="item">
                        <set field="afecto" from="true"/>
                        <if condition="item.productId">
                            <service-call name="mchile.sii.dte.DteLoadServices.check#Afecto" in-map="[productId:item.productId]" out-map="afectoMap"/>
                            <set field="afecto" from="afectoMap.afecto"/>
                        </if>
                        <if condition="afecto">
                            <set field="dteAmount" from="item.dteAmount ?: item.amount"/>
                            <set field="decimals" from="2"/>
                            <set field="item.amount" from="((item.amount?:0 as BigDecimal) * factor).setScale(decimals, java.math.RoundingMode.HALF_UP)"/>
                            <while condition="decimals > 0 &amp;&amp; (item.amount * (item.quantity?:1)).setScale(0, java.math.RoundingMode.HALF_UP) != item.amount * (item.quantity?:1)">
                                <set field="decimals" from="decimals-1"/>
                                <set field="item.amount" from="item.amount.setScale(decimals, java.math.RoundingMode.HALF_UP)"/>
                            </while>
                            <if condition="((item.amount?:0 as BigDecimal) * (item.quantity?:1 as BigDecimal)).setScale(0, java.math.RoundingMode.HALF_UP) != (item.amount?:0) * (item.quantity?:1)">
                                <set field="item.dteQuantity" from="item.dteQuantity ?: item.quantity"/>
                                <set field="item.amount" from="(item.amount * item.quantity).setScale(0, java.math.RoundingMode.HALF_UP)"/>
                                <set field="item.quantity" from="1"/>
                            </if>
                        </if>
                        <entity-update value-field="item"/>
                    </iterate>

                    <entity-find-one entity-name="mantle.account.invoice.Invoice" auto-field-map="[invoiceId:invoiceId]" value-field="invoice"/>
                    <set field="diff" from="invoice.invoiceTotal - montoTotal"/>
                </if>

                <set field="diffAbs" from="(diff &lt; 0) ? -diff : diff"/>
                <if condition="diffAbs &lt;= invoiceItemCount &amp;&amp; totalExento == montoExento"><then>
                    <entity-find entity-name="mantle.account.invoice.InvoiceItem" list="itemList" for-update="true">
                        <econdition field-name="invoiceId" from="invoiceId"/>
                    </entity-find>
                    <set field="i" from="0"/>
                    <iterate list="itemList" entry="item">
                        <set field="increment" from="diff > 0 ? -1 : 1"/>
                        <set field="diffAbs" from="(diff &lt; 0) ? -diff : diff"/>
                        <if condition="diffAbs &lt; 1"><set field="increment" from="-diff"/></if>
                        <set field="parentItemSeqId" from="item.invoiceItemSeqId"/>
                        <service-call name="mantle.account.InvoiceServices.create#InvoiceItem" in-map="[invoiceId: invoiceId, parentItemSeqId:parentItemSeqId, itemTypeEnumId:'ItemDteRoundingAdjust',
                                    description: 'Ajuste redondeo DTE', quantity: 1, amount:increment]"/>
                        <set field="diff" from="diff+increment"/>
                        <set field="i" from="i+1"/>
                    </iterate>

                    <entity-find-one entity-name="mantle.account.invoice.Invoice" auto-field-map="[invoiceId:invoiceId]" value-field="invoice"/>
                    <set field="diff" from="invoice.invoiceTotal - montoTotal"/>
                    <if condition="diff != 0">
                        <message error="true">Could not handle diff for document ${documento.Documento.'@ID'.text()}</message>
                    </if>
                </then><else>
                    <!-- No se puede resolver automáticamente la diferencia, se trata como discrepancia -->
                    <script>discrepancyMessages.add("No coinciden totales, DTE indica total ${montoTotal} y exento ${montoExento}, calculado: total ${invoice.invoiceTotal} y exento ${totalExento}")</script>
                    <set field="newInvoiceStatusId" value="InvoiceRequiresManualIntervention"/>
                </else></if>
            </if>
        </actions>
    </service>
</services>