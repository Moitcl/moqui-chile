<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="Libro de Compras/Ventas"
        default-menu-index="2">

    <transition name="eliminarLibro">
        <actions>
            <service-call name="mchile.DTEServices.eliminar#DTE" in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="enviarSII">
        <actions>
             <service-call name="mchile.DTEServices.preparaEnvio#Documentos" in-map="[documentIds:fiscalTaxDocumentId, libro:'TRUE']"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="xml" read-only="true">
        <parameter name="fiscalTaxDocumentId"/>
        <actions>

            <set field="extraPathNameList" from="sri.screenUrlInfo.extraPathNameList"/>


            <if condition="extraPathNameList &amp;&amp; !fiscalTaxDocumentId">
                <set field="fiscalTaxDocumentId" from="extraPathNameList[0]"/></if>
            <entity-find-one entity-name="mch.dte.FiscalTaxDocument" value-field="document" cache="true">
                <field-map field-name="fiscalTaxDocumentId"/></entity-find-one>

            <if condition="document == null"><then>
                <!-- NOTE: consider returning a default image instead of 404 -->
                <script>ec.web.sendError(404, null, null)</script>
            </then><else>
                <script>ec.web.sendResourceResponse(document.xml, true)</script>
            </else></if>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="genLibroVentas">
        <actions>
            <service-call name="mchile.DTEServices.genera#LibroVentas" out-map="context" in-map="[tipo:fiscalTaxDocumentTypeEnumId, tipoLibro:tipoLibro, tipoEnvio:tipoEnvio, periodo:periodo]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="genLibroCompras">
        <actions>
            <service-call name="mchile.DTEServices.genera#LibroCompras" out-map="context" in-map="[tipo:fiscalTaxDocumentTypeEnumId, tipoLibro:tipoLibro, tipoEnvio:tipoEnvio, periodo:periodo]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="genLibroGuias">
        <actions>
            <service-call name="mchile.DTEServices.genera#LibroGuias" out-map="context" in-map="[tipo:fiscalTaxDocumentTypeEnumId, tipoLibro:tipoLibro, tipoEnvio:tipoEnvio, periodo:periodo]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <actions>
        <entity-find entity-name="mch.dte.FiscalTaxDocument" list="dteList">
            <search-form-inputs/>
            <!--econdition-object field="searchMap"/-->
            <econdition field-name="fiscalTaxDocumentTypeEnumId" operator="in"
                        from="['Ftdt-LibroVentas','Ftdt-LibroCompras']"/>
        </entity-find>
        <log message="Lista: $dteList" level="warn"/>
    </actions>
    <widgets>
        <label text="Libros de Compraventa generados" type="h4"/>

        <container>
            <link url="genLibroVentas" text="Generar Libro de Ventas" parameter-map="[shipmentId:shipmentId, activeOrgId:activeOrgId, indTrasladoEnumId:indTrasladoEnumId]" link-type="auto"/>
            <link url="genLibroCompras" text="Generar Libro de Compras" parameter-map="[shipmentId:shipmentId, activeOrgId:activeOrgId, indTrasladoEnumId:indTrasladoEnumId]" link-type="auto"/>
            <link url="genLibroGuias" text="Generar Libro de Guías" parameter-map="[shipmentId:shipmentId, activeOrgId:activeOrgId, indTrasladoEnumId:indTrasladoEnumId]" link-type="auto"/>
        </container>

        <!--container-dialog id="GenLibroDialog" button-text="Generar Libro de Compraventa">
            <form-single name="LoadDteForm" transition="genLibro">

                <field name="fiscalTaxDocumentTypeEnumId">
                    <default-field title="Tipo Libro">
                        <drop-down>
                            <option key="Ftdt-LibroVentas"  text="Ventas"/>
                            <option key="Ftdt-LibroCompras" text="Compras"/>
                        </drop-down>
                    </default-field>
                </field>

                <field name="periodo">
                    <default-field title="Período">
                        <date-time format="YYYY-MM"/>
                    </default-field>
                </field>
                <field name="tipoEnvio">
                    <default-field title="Tipo Envío">
                        <drop-down>
                            <option key="TOTAL" text="Total"/>
                            <option key="FINAL" text="Final"/>
                            <option key="AJUSTE" text="Ajuste"/>
                        </drop-down>
                    </default-field>
                </field>
                <field name="tipoLibro">
                    <default-field title="Mensual o Especial">
                        <drop-down>
                            <option key="MENSUAL" text="Mensual"/>
                            <option key="ESPECIAL" text="Especial"/>
                        </drop-down>
                    </default-field>
                </field>
                <field name="Load">
                    <default-field>
                        <submit/>
                    </default-field>
                </field>
            </form-single>
        </container-dialog-->

        <form-list name="DteForm" list="dteList" show-pdf-button="true" show-csv-button="true" header-dialog="true" saved-finds="true" multi="false" transition="eliminarLibro">
            <row-actions>
                <!-- Se busca ubicación de XML y PDF -->
                <service-call name="mchile.DTEServices.get#DTEFilename"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, format:'xml']" out-map="context"/>
                <set field="xmlFilename" from="filename"/>

                <service-call name="mchile.DTEServices.get#DTEFilename"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, format:'pdf']" out-map="context"/>
                <set field="pdfFilename" from="filename"/>
            </row-actions>
            <field name="_useRowSubmit"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId">
                <header-field show-order-by="true" title="Identificador"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="fiscalTaxDocumentTypeEnumId">
                <header-field title="Type" show-order-by="true">
                    <drop-down allow-empty="true" allow-multiple="true">
                        <entity-options key="${enumId}">
                            <entity-find entity-name="moqui.basic.Enumeration">
                                <econdition field-name="enumTypeId" value="FiscalTaxDocumentType"/>
                            </entity-find>
                        </entity-options>
                    </drop-down>
                </header-field>
                <default-field>
                    <display-entity entity-name="moqui.basic.Enumeration"/>
                </default-field>
            </field>
            <field name="fechaEmision">
                <header-field show-order-by="true" title="Fecha Emisión"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="xml">
                <default-field title=" ">
                    <link url="xml/${xml}" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="XML" link-type="anchor"/>
                </default-field>
            </field>
            <field name="eliminar"><default-field title="Eliminar"><submit/></default-field></field>
            <field name="enviarSII">
                <default-field title=" ">
                    <link url="enviarSII" tooltip="Enviar a SII"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="Enviar a SII"/>
                </default-field>
            </field>
        </form-list>
    </widgets>
</screen>