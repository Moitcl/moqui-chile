<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="Facturas Cargadas"
        default-menu-index="2">

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>
    <transition-include name="getGlAccountListPaginated" location="component://SimpleScreens/template/account/AccountTransitions.xml"/>


    <transition name="editInvoice">
        <default-response url="/vapps/PopcAdmin/Accounting/Invoice/EditInvoice"/>
    </transition>

    <transition name="verificarEnSII">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <actions>
            <service-call name="mchile.DTEServices.verificaEnSII#Documento"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]" out-map="verifyOut"/>
            <log message="-> ${verifyOut.statusSii}" level="warn"/>
            <if condition="verifyOut.statusSii == '0'">
                <return error="false" message="${verifyOut.salida}"/>
            </if>
            <if condition="verifyOut.statusSii != '0'">
                <return error="true" message="${verifyOut.salida}"/>
            </if>

        </actions>
        <default-response url="."/>
    </transition>

    <transition name="enviarAceptacion">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <parameter name="fiscalTaxDocumentNumber"/>
        <parameter name="activeOrgId"/>
        <actions>
            <service-call name="mchile.DTEServices.enviar#Aceptacion"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, activeOrgId:activeOrgId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber ]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="resultadoAprobacionComercial">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <parameter name="fiscalTaxDocumentNumber"/>
        <parameter name="activeOrgId"/>
        <actions>
            <service-call name="mchile.DTEServices.enviar#ResultadoAprobacionComercial"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, activeOrgId:activeOrgId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber ]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="recibirMercaderia">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <parameter name="fiscalTaxDocumentNumber"/>
        <parameter name="activeOrgId"/>
        <actions>
            <service-call name="mchile.DTEServices.recibir#Mercaderia"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, activeOrgId:activeOrgId, fiscalTaxDocumentNumber:fiscalTaxDocumentNumber ]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="eliminarDTETercero">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="activeOrgId"/>
        <actions>
            <service-call name="mchile.DTEServices.eliminar#DTE"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, activeOrgId:activeOrgId]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="pdf" read-only="true">
        <parameter name="fiscalTaxDocumentId"/>
        <actions>

            <set field="extraPathNameList" from="sri.screenUrlInfo.extraPathNameList"/>

            <if condition="extraPathNameList &amp;&amp; !fiscalTaxDocumentId">
                <set field="fiscalTaxDocumentId" from="extraPathNameList[0]"/></if>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="document" cache="false">
                <field-map field-name="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId" value="Ftdct-Pdf"/>
            </entity-find-one>
            <if condition="document == null"><then>
                <!-- NOTE: consider returning a default image instead of 404 -->
                <script>ec.web.sendError(404, null, null)</script>
            </then><else>
                <script>ec.web.sendResourceResponse(document.contentLocation, true)</script>
            </else></if>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="xml" read-only="true">
        <parameter name="fiscalTaxDocumentId"/>
        <actions>
            <set field="extraPathNameList" from="sri.screenUrlInfo.extraPathNameList"/>


            <if condition="extraPathNameList &amp;&amp; !fiscalTaxDocumentId">
                <set field="fiscalTaxDocumentId" from="extraPathNameList[0]"/></if>
            <entity-find-one entity-name="mchile.dte.FiscalTaxDocumentContent" value-field="document" cache="false">
                <field-map field-name="fiscalTaxDocumentId"/>
                <field-map field-name="fiscalTaxDocumentContentTypeEnumId" value="Ftdct-Xml"/>
            </entity-find-one>
            <if condition="document == null"><then>
                <!-- NOTE: consider returning a default image instead of 404 -->
                <script>ec.web.sendError(404, null, null)</script>
            </then><else>
                <script>ec.web.sendResourceResponse(document.contentLocation, true)</script>
            </else></if>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition-include name="downloadDocument" location="component://MoquiChile/template/dte/DteTransitions.xml"/>

    <actions>
        <entity-find entity-name="mchile.dte.FiscalTaxDocument" list="dteList">
            <search-form-inputs/>
            <econdition field-name="fiscalTaxDocumentTypeEnumId" operator="in"
                        from="['Ftdt-30','Ftdt-32','Ftdt-33','Ftdt-34','Ftdt-60','Ftdt-61','Ftdt-56','Ftdt-52','Ftdt-39','PvtBoleta', 'PvtFactEl']"/>
            <econdition field-name="receiverPartyId" operator="equals" from="activeOrgId"/>
            <order-by field-name="-date"/>
            <!--econdition field-name="statusId" operator="not-equals" value="InvoiceCancelled"/-->
        </entity-find>
    </actions>
    <widgets>

        <label text="Carga y Listado de Documentos Tributarios recibidos de terceros (proveedores)" type="h4"/>


        <form-list name="DteForm" list="dteList" show-pdf-button="true" show-csv-button="true" header-dialog="true" saved-finds="true" multi="true">
            <row-actions>
                <service-call name="mchile.DTEServices.get#DteContent"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml']" out-map="xmlContext"/>
                <set field="xmlFilename" from="xmlContext.content"/>

                <service-call name="mchile.DTEServices.get#DteContent"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Pdf']" out-map="pdfContext"/>
                <set field="pdfFilename" from="pdfContext.content"/>
                
                <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoiceField"/>
                <!--log message="Leyendo: $invoiceField.invoiceId" level="warn"/-->
                <set field="statusId"/>
                <if condition="invoiceField">
                    <set field="statusId" from="invoiceField.statusId"/>
                </if>
            </row-actions>
            <field name="_useRowSubmit"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId"><default-field><hidden default-value="true"/></default-field></field>
            <field name="idEnvio">
                <header-field title="ID Envío" show-order-by="true"><text-line size="6"/></header-field>
                <default-field>
                    <display format="########"/>
                </default-field>
            </field>
            <field name="fiscalTaxDocumentNumber">
                <header-field title="Folio" show-order-by="true"><text-line size="6"/></header-field>
                <default-field>
                    <display format="########"/>
                </default-field>
            </field>
            <field name="fiscalTaxDocumentTypeEnumId">
                <header-field title="Type" show-order-by="true">
                    <drop-down allow-empty="true" allow-multiple="true">
                        <entity-options key="${enumId}">
                            <entity-find entity-name="moqui.basic.Enumeration">
                                <econdition field-name="enumTypeId" value="FiscalTaxDocumentType"/>
                            </entity-find>
                        </entity-options>
                    </drop-down>
                </header-field>
                <default-field>
                    <display-entity entity-name="moqui.basic.Enumeration"/>
                </default-field>
            </field>

            <field name="issuerPartyId">
                <header-field title="Emisor">
                    <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true" min-length="2"
                                                                   parameter-map="[roleTypeId:'Customer,OrgInternal']"/></drop-down>
                </header-field>
                <default-field><link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"/></default-field>
            </field>

            <field name="invoiceId">
                <header-field title="Invoice" show-order-by="true"><text-find/></header-field>
                <default-field><link url="editInvoice" text="${invoiceId}" link-type="anchor" parameter-map="[invoiceId:invoiceId]"/>
                </default-field>
            </field>

            <field name="statusId">
                <header-field title="Estado Orden"/>
                <default-field><display/></default-field>
            </field>

            <field name="date">
                <header-field show-order-by="true" title="Fecha Emisión"><text-find/></header-field>
                <default-field><display/> </default-field>
            </field>
            <field name="xml">
                <default-field title=" ">
                    <link url="downloadDocument" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fileType:'Ftdct-Xml']" text="XML" link-type="anchor"/>
                </default-field>
            </field>
            <field name="pdf">
                <default-field title=" ">
                    <link url="downloadDocument" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fileType:'Ftdct-Pdf']" text="PDF" link-type="anchor"/>
                </default-field>
            </field>
            <field name="eliminarDTETercero">
                <default-field title=" ">
                    <link url="eliminarDTETercero" tooltip="Eliminar"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="Eliminar/Rechazar" confirmation="El documento será eliminado del sistema .¿Desea continuar?"/>
                </default-field>
            </field>

            <field name="enviarAceptacion">
                <default-field title=" ">
                    <link url="enviarAceptacion" tooltip="Recepcionar"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, emisor:emisor, xml:xml]" text="Recepcionar"
                          condition="xmlFilename != null"/>
                </default-field>
            </field>
            <!--field name="enviarRechazo">
                <default-field title=" ">
                    <link url="enviarAceptacion" tooltip="Rechazar"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, emisor:emisor, xml:xml]" text="Rechazar"
                          condition="xmlFilename != null"/>
                </default-field>
            </field-->
            <field name="recibirMercaderia">
                <default-field title=" ">
                    <link url="recibirMercaderia" tooltip="Recibir Mercadería"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, emisor:emisor, xml:xml]" text="Recibir Mercadería"
                          condition="xmlFilename != null"/>
                </default-field>
            </field>
            <field name="resultadoAprobacionComercial">
                <default-field title=" ">
                    <link url="resultadoAprobacionComercial" tooltip="Aprobación Comercial"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, emisor:emisor, xml:xml]" text="Aprobación Comercial"
                          condition="xmlFilename != null"/>
                </default-field>
            </field>

        </form-list>
    </widgets>
</screen>