<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-include="false">

    <!--parameter name="fiscalTaxDocumentId" required="true"/-->
    <parameter name="returnId" required="true"/>
    <parameter name="invoiceId" required="true"/>

    <transition name="genNotaCredito">
        <parameter name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
        <parameter name="activeOrgId" from="activeOrgId"/>
        <actions>
            <script><![CDATA[
                    items = new StringBuilder()
                    for (int i = 0; ; i++) {
                        if ((context.get("_useRowSubmit") == "true" || context.get("_useRowSubmit_" + i) == "true")
                                && context.get("_rowSubmit_" + i) != "true") continue
                        String curKey = "returnItemSeqId_" + i
                        String returnQuantity = "returnQuantity_" + i
                        String returnPrice = "returnPrice_" + i
                        String description = "description_" + i
                        String pctDiscount = "pctDiscount_" + i
                        if (context.containsKey(curKey))  {
                            if (items.length() > 0) items.append(",")
                            items.append(context.get(curKey)+"-"+context.get(returnQuantity)+"-"+context.get(returnPrice)+"-"+context.get(pctDiscount)+"-"+context.get(description) )
                        } else { break }
                    }
            ]]></script>
            <service-call name="mchile.DTEServices.generar#NotaCredito" in-map="context + [returnId:returnId, fiscalTaxDocumentTypeEnumId:'Ftdt-61', invoiceId:invoiceId, activeOrgId:activeOrgId]"/>
        </actions>
        <default-response url="../FindDTE"/>
    </transition>

    <!--transition name="genNotaCredito">
        <service-call name="mchile.DTEServices.generar#NotaCredito" in-map="[returnId:returnId, fiscalTaxDocumentTypeEnumId:'Ftdt-61', invoiceId:invoiceId, activeOrgId:activeOrgId]"/>
        <default-response url="."/>
    </transition-->

    <pre-actions>
        <service-call name="mantle.party.PartyServices.setup#UserOrganizationInfo" out-map="userOrgList"/>
        <set field="activeOrgId" from="userOrgList.activeOrgId"/>
    </pre-actions>

    <actions>
        <!-- Se buscan referencias de returnId  -->

        <entity-find-one entity-name="mch.dte.ReferenciaReturn" value-field="referenciaField">
            <field-map field-name="returnId" from="returnId"/>
            <!--field-map field-name="fiscalTaxDocumentTypeEnumId" value="Ftdt-34"/-->
        </entity-find-one>
        <if condition="!referenciaField">
            <return error="true" message="No existe factura especificada"/>
        </if>
        <set field="codRef" from="referenciaField.codigoReferenciaEnumId"/>

        <!-- Se busca detalle de items -->
        <entity-find entity-name="mantle.order.return.ReturnItem" list="returnItemList">
            <econdition field-name="returnId"/></entity-find>


    </actions>

    <widgets>
        <container-row>
            <row-col>
                <container>
                    <!--form-single name="EditReturn" skip-start="true">
                        <field name="returnId"><default-field><display/></default-field></field>
                        <field name="fromPartyId"><default-field title="From">
                            <link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"
                                  parameter-map="[partyId:fromPartyId]"/>
                        </default-field></field>
                        <field name="toPartyId"><default-field title="To">
                            <link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"
                                  parameter-map="[partyId:toPartyId]"/>
                        </default-field></field>
                        <field name="invoiceTypeEnumId">
                            <conditional-field title="Type" condition="invoiceEditable">
                                <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                    <set field="enumTypeId" value="InvoiceType"/></widget-template-include>
                            </conditional-field>
                            <default-field title="Type"><display-entity entity-name="moqui.basic.Enumeration"/></default-field>
                        </field>
                        <field name="productStoreId">
                            <conditional-field title="Store" condition="invoiceEditable">
                                <drop-down allow-empty="true"><entity-options key="${productStoreId}" text="${productStoreId}: ${storeName}">
                                    <entity-find entity-name="mantle.product.store.ProductStore">
                                        <order-by field-name="storeName"/></entity-find></entity-options>
                                </drop-down>
                            </conditional-field>
                            <conditional-field title="Store" condition="invoice.productStoreId">
                                <display-entity entity-name="mantle.product.store.ProductStore" text="${productStoreId}: ${storeName}"/>
                            </conditional-field>
                            <default-field><ignored/></default-field>
                        </field>
                        <field name="invoiceDate">
                            <conditional-field condition="invoiceEditable"><date-time/></conditional-field>
                            <default-field title="Date"><display also-hidden="false"/></default-field>
                        </field>
                        <field name="invoiceTotal"><default-field title="Total"><display currency-unit-field="invoice.currencyUomId"/></default-field></field>

                    </form-single-->


                    <form-list name="ReturnItems" list="returnItemList" transition="genNotaCredito" multi="true">
                        <hidden-parameters><parameter name="returnId"/><parameter name="activeOrgId"/></hidden-parameters>
                        <field name="_useRowSubmit"><default-field><hidden default-value="true"/></default-field></field>
                        <field name="returnItemSeqId"><default-field title="Item"><display/></default-field></field>
                        <field name="description"><default-field><display/></default-field></field>
                        <field name="returnQuantity"><default-field><display/></default-field></field>
                        <field name="returnPrice"><default-field><display/></default-field></field>
                        <field name="total" from="((returnQuantity != null ? returnQuantity : 1.0) * (returnPrice ?: 0.0))">
                            <default-field><display/></default-field></field>
                        <field name="pctDiscount"><default-field title="% Descuento"><text-line size="4" default-value="0"/></default-field></field>
                        <field name="_rowSubmit"><default-field title="Corregir">
                            <check no-current-selected-key="false"><option key="true" text=" "/></check></default-field>
                        </field>
                        <field name="submitButton"><default-field title="Generar Nota de Crédito"><submit/>
                            <!--link url="anularNotaCredito" text="Anular Nota de Crédito" url-type="plain" link-type="auto" parameter-map="[returnId:returnId]"/-->
                        </default-field></field>
                    </form-list>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>