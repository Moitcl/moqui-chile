<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="Facturas Generadas" default-menu-index="41">

    <transition name="editInvoice">
        <default-response url="/vapps/PopcAdmin/Accounting/Invoice/EditInvoice"/>
    </transition>

    <transition name="cesionElectronica"><default-response url="../Facturacion/CesionElectronica"/></transition>

    <transition name="enviarAReceptor">
        <service-call name="mchile.DTEServices.send#DteXmlToReceiver"/>
        <default-response url="."/>
    </transition>

    <transition name="envioSII">
        <actions>
            <script><![CDATA[
                    documentIds = []
                    for (int i = 0; ; i++) {
                        if ((context.get("_useRowSubmit") == "true" || context.get("_useRowSubmit_" + i) == "true")
                                && context.get("_rowSubmit_" + i) != "true") continue
                        String curKey = "fiscalTaxDocumentId_" + i
                        if (context.containsKey(curKey))  {
                            documentIds.add(context.get(curKey))
                        } else { break }
                    }
            ]]></script>
            <service-call name="mchile.DTEServices.preparaEnvio#Documentos" in-map="context"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="marcarEnviado">
        <actions>
            <service-call name="mchile.DTEServices.marcarEnviado#Documento" in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" out-map="context"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="verificarEnSII">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <actions>
            <service-call name="mchile.DTEServices.verificaEnSII#Documento" in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId,
                                         organizationPartyId:activeOrgId]" out-map="verifyOut"/>
            <if condition="verifyOut.errCode == '0'"><then>
                <return message="${verifyOut.salida}"/>
            </then><else>
                <return error="true" message="ERROR: ${verifyOut.salida}"/>
            </else></if>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="eliminarDTE">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="activeOrgId"/>
        <actions>
            <service-call name="mchile.DTEServices.eliminar#DTE" in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, organizationPartyId:activeOrgId]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition-include name="downloadDocumentInternal" location="component://MoquiChile/template/dte/DteTransitions.xml"/>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>

    <actions>
        <entity-find entity-name="mchile.dte.FiscalTaxDocument" list="dteList">
            <search-form-inputs/>
            <econdition field-name="fiscalTaxDocumentTypeEnumId" operator="in"
                        from="['Ftdt-33','Ftdt-34','Ftdt-61','Ftdt-56','Ftdt-52','Ftdt-110','Ftdt-112']"/>
            <econdition field-name="statusId" value="Ftd-Issued"/>
            <econdition field-name="sentAuthStatusId" value="Ftd-NotSentAuth"/>
            <order-by field-name="-date"/>
        </entity-find>

    </actions>
    <widgets>

        <label text="DTE listas para ser enviadas al SII" type="h4"/>

        <form-list name="DteForm" list="dteList" show-pdf-button="true" show-csv-button="true" header-dialog="true" saved-finds="true" multi="true" transition="envioSII">
            <row-actions>
                <!-- Se busca ubicación de XML y PDF -->
                <service-call name="mchile.DTEServices.get#DteContent"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Xml']" out-map="context"/>
                <set field="xmlFilename" from="content"/>

                <service-call name="mchile.DTEServices.get#DteContent"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentContentTypeEnumId:'Ftdct-Pdf']" out-map="context"/>
                <set field="pdfFilename" from="content"/>

            </row-actions>
            <field name="_useRowSubmit"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId"><default-field><hidden default-value="true"/></default-field></field>
            <field name="activeOrgId"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId">
                <header-field show-order-by="true" title="Identificador"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="fiscalTaxDocumentNumber">
                <header-field show-order-by="true" title="Folio"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="fiscalTaxDocumentTypeEnumId">
                <header-field title="Type" show-order-by="true">
                    <drop-down allow-empty="true" allow-multiple="true">
                        <entity-options key="${enumId}">
                            <entity-find entity-name="moqui.basic.Enumeration">
                                <econdition field-name="enumTypeId" value="FiscalTaxDocumentType"/>
                            </entity-find>
                        </entity-options>
                    </drop-down>
                </header-field>
                <default-field>
                    <display-entity entity-name="moqui.basic.Enumeration"/>
                </default-field>
            </field>

            <field name="receiverPartyId">
                <header-field title="Receptor">
                    <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true" min-length="2"
                                                                   parameter-map="[roleTypeId:'Customer,OrgInternal']"/></drop-down>
                </header-field>
                <default-field><link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"/></default-field>
            </field>
            <field name="invoiceId">
                <header-field title="Invoice ID" show-order-by="true"><text-find/></header-field>
                <default-field><link url="editInvoice" text="${invoiceId}" link-type="anchor" parameter-map="[invoiceId:invoiceId]"/>
                </default-field>
            </field>
            <field name="xml">
                <default-field title=" ">
                    <link url="downloadDocumentInternal" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fileType:'Ftdct-Xml']" text="XML" link-type="anchor"/>
                </default-field>
            </field>
            <field name="pdf">
                <default-field title=" ">
                    <link url="downloadDocumentInternal" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fileType:'Ftdct-Pdf']" text="PDF" link-type="anchor"/>
                </default-field>
            </field>
            <field name="pdfCedible">
                <default-field title=" ">
                    <link url="downloadDocumentInternal" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fileType:'Ftdct-PdfCedible']" text="PDF Cedible" link-type="anchor"/>
                </default-field>
            </field>

            <field name="verificarEnSII">
                <default-field title=" ">
                    <link url="verificarEnSII" tooltip="Verificar Estado en SII"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]" text="Verificar en SII"/>
                </default-field>
            </field>

            <!-- No soportado aún -->
            <!--field name="cesionElectronica">
                <default-field title=" ">
                    <link url="cesionElectronica" tooltip="Cesión Electrónica"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]" text="Cesión Electrónica" url-type="transition"/>
                </default-field>
            </field-->

            <field name="marcarEnviado">
                <default-field title=" ">
                    <link url="marcarEnviado" tooltip="Marcar como enviado"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]" text="Marcar como enviado"/>
                </default-field>
            </field>

            <field name="eliminar">
                <default-field title=" ">
                    <link url="eliminarDTE" tooltip="Eliminar DTE"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="Eliminar DTE"/>
                </default-field>
            </field>

            <field name="_rowSubmit"><default-field title="Enviar a SII">
                <check no-current-selected-key="false"><option key="true" text=" "/></check></default-field>
            </field>
            <field name="envioSII"><default-field title="Enviar a SII"><submit/></default-field></field>

        </form-list>
    </widgets>
</screen>