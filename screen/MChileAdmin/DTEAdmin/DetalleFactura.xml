<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-include="false">

    <parameter name="fiscalTaxDocumentId" required="true"/>

    <transition name="genNotaDebito">
        <parameter name="fiscalTaxDocumentId" from="fiscalTaxDocumentId"/>
        <actions>
        <script><![CDATA[
                    items = new StringBuilder()
                    for (int i = 0; ; i++) {
                        if ((context.get("_useRowSubmit") == "true" || context.get("_useRowSubmit_" + i) == "true")
                                && context.get("_rowSubmit_" + i) != "true") continue
                        String curKey = "invoiceItemSeqId_" + i
                        String quantity = "quantity_" + i
                        String amount = "amount_" + i
                        String productId = "productId_" + i
                        if (context.containsKey(curKey))  {
                            if (items.length() > 0) items.append(",")
                            items.append(context.get(curKey)+"-"+context.get(quantity)+"-"+context.get(amount)+"-"+context.get(productId))
                        } else { break }
                    }
            ]]></script>
            <service-call name="mchile.DTEServices.generar#NotaDebito" in-map="context + [fiscalTaxDocumentId:fiscalTaxDocumentId, invoiceId:invoiceId]"/>
        </actions>
        <default-response url="./FindDTE"/>
    </transition>


    <actions>
        <!-- Se busca invoiceId asociado a fiscalTaxDocumentId -->

        <entity-find-one entity-name="mch.dte.FiscalTaxDocument" value-field="facturaField"/>
        <if condition="!facturaField">
            <return error="true" message="No existe factura especificada"/>
        </if>
        <set field="invoiceId" from="facturaField.invoiceId"/>

        <!-- Se busca detalle de invoice -->

        <service-call name="mantle.account.InvoiceServices.get#InvoiceDisplayInfo" in-map="[invoiceId:invoiceId]" out-map="context"/>
        <if condition="invoice == null"><return error="true" message="Invoice ${invoiceId} not found"/></if>
        <!-- set statusId for StatusChangeSection -->
        <set field="statusId" from="invoice?.statusId"/>

        <entity-find entity-name="mantle.party.PartyRole" list="fromOrgInternalList">
            <econdition field-name="partyId" from="invoice.fromPartyId"/><econdition field-name="roleTypeId" value="OrgInternal"/></entity-find>
        <set field="isFromPartyOrgInternal" from="fromOrgInternalList as boolean"/>
        <set field="organizationPartyId" from="isFromPartyOrgInternal ? invoice.fromPartyId : invoice.toPartyId"/>


        <entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/>
        <if condition="invoice == null"><return error="true" message="Invoice ${invoiceId} not found"/></if>
        <entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItemList">
            <econdition field-name="invoiceId"/><order-by field-name="invoiceItemSeqId"/></entity-find>
        <set field="topItemList" from="invoiceItemList.findAll({ it.parentItemSeqId == null })"/>

        <!-- put items with parentItemSeqId in the list after their parent -->
        <script><![CDATA[
            itemWithChildrenSet = new HashSet()
            List reverseList = invoiceItemList.cloneList().orderByFields(["-invoiceItemSeqId"])
            for (invoiceItem in reverseList) {
                if (invoiceItem.parentItemSeqId) {
                    itemWithChildrenSet.add(invoiceItem.parentItemSeqId)
                    invoiceItemList.move(invoiceItemList.indexMatching([invoiceItemSeqId:invoiceItem.invoiceItemSeqId]),
                            invoiceItemList.indexMatching([invoiceItemSeqId:invoiceItem.parentItemSeqId])+1)
                }
            }
        ]]></script>

        <set field="editableStatusIds" from="new HashSet(['InvoiceInProcess', 'InvoiceIncoming', 'InvoiceReceived'])"/>
        <set field="invoiceEditable" from="invoice.statusId in editableStatusIds"/>

        <entity-find entity-name="mantle.party.PartyRole" list="fromOrgInternalList">
            <econdition field-name="partyId" from="invoice.fromPartyId"/><econdition field-name="roleTypeId" value="OrgInternal"/></entity-find>
        <set field="isFromPartyOrgInternal" from="fromOrgInternalList as boolean"/>
        <set field="organizationPartyId" from="isFromPartyOrgInternal ? invoice.fromPartyId : invoice.toPartyId"/>

        <if condition="invoice.invoiceTypeEnumId == 'InvoiceSales' || invoice.invoiceTypeEnumId == 'InvoiceReturn'"><then>
            <entity-find entity-name="moqui.basic.EnumAndGroup" list="itemTypeEnumList">
                <econdition field-name="enumGroupEnumId" from="isFromPartyOrgInternal ? 'EngItemsSales' : 'EngItemsPurchase'"/><order-by field-name="description"/></entity-find>
        </then><else-if condition="invoice.invoiceTypeEnumId == 'InvoicePayroll'">
            <entity-find entity-name="moqui.basic.EnumAndParent" list="itemTypeEnumList">
                <econdition field-name="parentEnumId" operator="in" value="ItemPayrollIncome,ItemPayrollDeduct,ItemPayrollTaxes,ItemPayrollExpense"/>
                <order-by field-name="description"/></entity-find>
        </else-if><else>
            <entity-find entity-name="moqui.basic.Enumeration" list="itemTypeEnumList">
                <econdition field-name="enumTypeId" value="ItemType"/><order-by field-name="description"/></entity-find>
        </else></if>

    </actions>

    <widgets>
        <container-row>
            <row-col>
                <container>
                    <form-single name="EditInvoice" skip-start="true">
                        <field name="invoiceId"><default-field><display/></default-field></field>
                        <field name="fromPartyId"><default-field title="From">
                            <link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"
                                  parameter-map="[partyId:fromPartyId]"/>
                        </default-field></field>
                        <field name="toPartyId"><default-field title="To">
                            <link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"
                                  parameter-map="[partyId:toPartyId]"/>
                        </default-field></field>
                        <field name="invoiceTypeEnumId">
                            <conditional-field title="Type" condition="invoiceEditable">
                                <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#enumDropDown">
                                    <set field="enumTypeId" value="InvoiceType"/></widget-template-include>
                            </conditional-field>
                            <default-field title="Type"><display-entity entity-name="moqui.basic.Enumeration"/></default-field>
                        </field>
                        <field name="productStoreId">
                            <conditional-field title="Store" condition="invoiceEditable">
                                <drop-down allow-empty="true"><entity-options key="${productStoreId}" text="${productStoreId}: ${storeName}">
                                    <entity-find entity-name="mantle.product.store.ProductStore">
                                        <order-by field-name="storeName"/></entity-find></entity-options>
                                </drop-down>
                            </conditional-field>
                            <conditional-field title="Store" condition="invoice.productStoreId">
                                <display-entity entity-name="mantle.product.store.ProductStore" text="${productStoreId}: ${storeName}"/>
                            </conditional-field>
                            <default-field><ignored/></default-field>
                        </field>
                        <field name="invoiceDate">
                            <conditional-field condition="invoiceEditable"><date-time/></conditional-field>
                            <default-field title="Date"><display also-hidden="false"/></default-field>
                        </field>
                        <field name="invoiceTotal"><default-field title="Total"><display currency-unit-field="invoice.currencyUomId"/></default-field></field>

                        <field-layout>
                            <field-row><field-ref name="invoiceId"/><field-ref name="invoiceTypeEnumId"/></field-row>
                            <field-row><field-ref name="invoiceDate"/><field-ref name="invoiceTotal"/></field-row>
                            <fields-not-referenced/>
                        </field-layout>
                    </form-single>


                    <form-list name="EditInvoiceItems" list="invoiceItemList" transition="genNotaDebito" multi="true">
                        <hidden-parameters><parameter name="invoiceId"/></hidden-parameters>
                        <field name="_useRowSubmit"><default-field><hidden default-value="true"/></default-field></field>
                        <field name="invoiceItemSeqId"><default-field title="Item"><display/></default-field></field>
                        <field name="productId">
                            <default-field title="Product"><display text=" "/>
                                <link url="editProduct" text="ProductNameTemplate" entity-name="mantle.product.Product" link-type="anchor" condition="productId"/>
                            </default-field>
                        </field>
                        <field name="itemTypeEnumId">
                            <conditional-field condition="invoiceEditable">
                                <drop-down><list-options list="itemTypeEnumList" key="${enumId}" text="${description}"/></drop-down></conditional-field>
                            <default-field title="Type"><display-entity entity-name="moqui.basic.Enumeration"/></default-field>
                        </field>
                        <field name="quantity"><default-field><text-line size="4"/></default-field></field>
                        <field name="amount"><default-field><text-line size="8"/></default-field></field>
                        <field name="itemDate"><default-field><display/></default-field></field>
                        <field name="total" from="((quantity != null ? quantity : 1.0) * (amount ?: 0.0))">
                            <default-field><display currency-unit-field="invoice.currencyUomId"/></default-field></field>
                        <field name="deleteButton"><default-field title="">
                            <link url="deleteInvoiceItem" text="Delete" condition="invoiceEditable" confirmation="Delete this item?"
                                  parameter-map="[invoiceId:invoiceId, invoiceItemSeqId:invoiceItemSeqId]"/>
                        </default-field></field>
                        <field name="_rowSubmit"><default-field title="Corregir">
                            <check no-current-selected-key="false"><option key="true" text=" "/></check></default-field>
                        </field>
                        <field name="submitButton"><default-field title="Generar Nota de Débito"><submit/></default-field></field>

                    </form-list>
                </container>
            </row-col>
        </container-row>
    </widgets>
</screen>