<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="Envíos" default-menu-index="90">

    <transition name="verificaEnvio">
        <service-call name="mchile.sii.DTECommServices.check#EnviosEnviadosSii"/>
        <default-response url="."/>
    </transition>

    <transition name="sendEnvio">
        <service-call name="mchile.sii.DTECommServices.send#PendingEnvioDteReceiver"/>
        <default-response url="."/>
    </transition>

    <transition name="processEnvio">
        <service-call name="mchile.sii.DTECommServices.process#PendingDteEnvio"/>
        <default-response url="."/>
    </transition>

    <transition name="downloadEnvio" read-only="true">
        <actions>
            <entity-find-one entity-name="mchile.dte.DteEnvio" value-field="envio"/>
            <script>
                if (envio?.documentLocation)
                    ec.web.sendResourceResponse(envio.documentLocation)
                else
                    ec.message.addError("No se encuentra documento de envío ${envioId}")
            </script>
        </actions>
        <default-response type="none"/>
    </transition>

    <actions>
        <entity-find entity-name="mchile.dte.DteEnvio" list="envioList">
            <search-form-inputs default-order-by="-registerDate"/>
        </entity-find>
    </actions>

    <widgets>
        <form-list name="FindEnvioForm" list="envioList" header-dialog="true">
            <auto-fields-entity entity-name="mchile.dte.DteEnvio" auto-columns="false"/>
            <field name="actions">
                <header-field><submit text="Search"/></header-field>
                <default-field>
                    <link url="verificaEnvio" text="Verificar en SII" condition="statusId == 'Ftde-Sent' &amp;&amp; rutReceptor == '60803000-K'" parameter-map="[initialDelaySeconds:0, checkAttempts:1, envioId:envioId]"/>
                    <link url="sendEnvio" text="Enviar" condition="statusId == 'Ftde-Created'" parameter-map="[envioIdList:[envioId]]"/>
                    <link url="processEnvio" text="Procesar" condition="statusId == 'Ftde-Received'" parameter-map="[envioIdList:[envioId], ignoreLastAttempt:true]"/>
                </default-field>
            </field>
            <field name="documentLocation">
                <default-field>
                    <link url="downloadEnvio" parameter-map="[envioId:envioId]" text="${documentLocation}" link-type="anchor"/>
                </default-field>
            </field>
            <columns>
                <column><field-ref name="envioId"/></column>
                <column><field-ref name="rutEmisor"/><field-ref name="rutReceptor"/></column>
                <column><field-ref name="statusId"/><field-ref name="envioTypeEnumId"/></column>
                <column><field-ref name="registerDate"/><field-ref name="lastAttempt"/></column>
                <column><field-ref name="attemptCount"/></column>
                <column><field-ref name="internalId"/><field-ref name="trackId"/></column>
                <column><field-ref name="documentLocation"/><field-ref name="emailMessageId"/></column>
                <column><field-ref name="actions"/></column>
            </columns>
        </form-list>
    </widgets>

</screen>