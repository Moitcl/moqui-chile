<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="DTE Recibidas"
        default-menu-index="2">

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>

    <transition name="loadDte">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <parameter name="activeOrgId"/>
        <actions>
            <service-call name="mchile.DTEServices.load#Dte" in-map="[xml:xml, pdf:pdf, activeOrgId:activeOrgId, amount:amount, emisor:emisor, emailEmisor:emailEmisor,
                amount:amount, montoNeto:montoNeto, nroDocumento:nroDocumento, tasaImpuesto:tasaImpuesto, tipoImpuesto:tipoImpuesto,
                razonSocial:razonSocial, fechaEmision:fechaEmision, documentoAnulado:documentoAnulado, montoExento:montoExento, montoIVARecuperable:montoIVARecuperable,
                codigoIVANoRecuperable:codigoIVANoRecuperable, montoIVANoRecuperable:montoIVANoRecuperable, montoIVAUsoComun:montoIVAUsoComun,
                codigoOtroImpuestoORetencion:codigoOtroImpuestoORetencion, tasaOtroImpuestoORetencion:tasaOtroImpuestoORetencion, montoOtroImpuestoORetencionConCredito:montoOtroImpuestoORetencionConCredito,
                montoOtroImpuestoORetencionSinCredito:montoOtroImpuestoORetencionSinCredito, montoNetoActivoFijo:montoNetoActivoFijo, montoIVAActivoFijo:montoIVAActivoFijo,
                montoIVANoRetenido:montoIVANoRetenido, codigoSucursal:codigoSucursal, notasDebitoCreditoFacturasCompra:notasDebitoCreditoFacturasCompra, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]"/>
                <!-- Creación y envio de aceptación -->
            <!--service-call name="mchile.DTEServices.enviar#Aceptacion"
                      in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, rutRecibe:emisor, xml:xml, activeOrgId:activeOrgId ]"/-->
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="loadDt">
        <service-call name="mchile.DTEServices.load#Dt" in-map="[pdf:pdf, amount:amount, emisor:emisor, emailEmisor:emailEmisor,
            amount:amount, montoNeto:montoNeto, nroDocumento:nroDocumento, tasaImpuesto:tasaImpuesto, tipoImpuesto:tipoImpuesto,
            razonSocial:razonSocial, fechaEmision:fechaEmision, documentoAnulado:documentoAnulado, montoExento:montoExento, montoIVARecuperable:montoIVARecuperable,
            codigoIVANoRecuperable:codigoIVANoRecuperable, montoIVANoRecuperable:montoIVANoRecuperable, montoIVAUsoComun:montoIVAUsoComun,
            codigoOtroImpuestoORetencion:codigoOtroImpuestoORetencion, tasaOtroImpuestoORetencion:tasaOtroImpuestoORetencion, montoOtroImpuestoORetencionConCredito:montoOtroImpuestoORetencionConCredito,
            montoOtroImpuestoORetencionSinCredito:montoOtroImpuestoORetencionSinCredito, montoNetoActivoFijo:montoNetoActivoFijo, montoIVAActivoFijo:montoIVAActivoFijo,
            montoIVANoRetenido:montoIVANoRetenido, codigoSucursal:codigoSucursal, notasDebitoCreditoFacturasCompra:notasDebitoCreditoFacturasCompra, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, vendorPartyId:vendorPartyId]"/>
        <default-response url="."/>
    </transition>

    <transition name="verificarEnSII">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <actions>
            <service-call name="mchile.DTEServices.verificaEnSII#Documento"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]" out-map="verifyOut"/>
            <log message="-> ${verifyOut.statusSii}" level="warn"/>
            <if condition="verifyOut.statusSii == '0'">
                <return error="false" message="${verifyOut.salida}"/>
            </if>
            <if condition="verifyOut.statusSii != '0'">
                <return error="true" message="${verifyOut.salida}"/>
            </if>

        </actions>
        <default-response url="."/>
    </transition>

    <!-- TODO: Enviar aceptación a tercero -->
    <transition name="enviarAceptacion">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <parameter name="activeOrgId"/>
        <parameter name="emisor"/>
        <parameter name="xml"/>
        <actions>
            <service-call name="mchile.DTEServices.enviar#Aceptacion"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, activeOrgId:activeOrgId, rutRecibe:emisor, xml:xml ]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="eliminarDTETercero">
        <parameter name="fiscalTaxDocumentId"/>
        <parameter name="fiscalTaxDocumentTypeEnumId"/>
        <actions>
            <service-call name="mchile.DTEServices.eliminar#DTE"
                          in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]"/>
        </actions>
        <default-response url="."/>
    </transition>

    <transition name="pdf" read-only="true">
        <parameter name="fiscalTaxDocumentId"/>
        <actions>

            <set field="extraPathNameList" from="sri.screenUrlInfo.extraPathNameList"/>

            <if condition="extraPathNameList &amp;&amp; !fiscalTaxDocumentId">
                <set field="fiscalTaxDocumentId" from="extraPathNameList[0]"/></if>
            <entity-find-one entity-name="MoquiChile.FiscalTaxDocument" value-field="document" cache="false">
                <field-map field-name="fiscalTaxDocumentId"/></entity-find-one>
            <log level="warn" message="------- $document.pdf param: $fiscalTaxDocumentId"/>

            <if condition="document == null"><then>
                <!-- NOTE: consider returning a default image instead of 404 -->
                <script>ec.web.sendError(404, null, null)</script>
            </then><else>
                <script>ec.web.sendResourceResponse(document.pdf, true)</script>
            </else></if>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="xml" read-only="true">
        <parameter name="fiscalTaxDocumentId"/>
        <actions>

            <set field="extraPathNameList" from="sri.screenUrlInfo.extraPathNameList"/>


            <if condition="extraPathNameList &amp;&amp; !fiscalTaxDocumentId">
                <set field="fiscalTaxDocumentId" from="extraPathNameList[0]"/></if>
            <entity-find-one entity-name="MoquiChile.FiscalTaxDocument" value-field="document" cache="true">
                <field-map field-name="fiscalTaxDocumentId"/></entity-find-one>

            <if condition="document == null"><then>
                <!-- NOTE: consider returning a default image instead of 404 -->
                <script>ec.web.sendError(404, null, null)</script>
            </then><else>
                <script>ec.web.sendResourceResponse(document.xml, true)</script>
            </else></if>
        </actions>
        <default-response type="none"/>
    </transition>
    <pre-actions>
        <service-call name="mantle.party.PartyServices.setup#UserOrganizationInfo" out-map="userOrgList"/>
        <set field="activeOrgId" from="userOrgList.activeOrgId"/>
    </pre-actions>
    <actions>
        <service-call name="mchile.DTEServices.load#DTEConfig" in-map="[resourceName:'RUT_EMPRESA']" out-map="context"/>
        <set field="emisorS" from="resourceValue"/>

        <entity-find entity-name="MoquiChile.FiscalTaxDocument" list="dteList">
            <search-form-inputs/>
            <econdition field-name="fiscalTaxDocumentTypeEnumId" operator="in"
                        from="['30','32','33','34','60','61','56','52']"/>
            <econdition field-name="emisor" operator="not-equals" from="emisorS"/>
        </entity-find>

    </actions>
    <widgets>

        <label text="Carga y Listado de Documentos Tributarios recibidos de terceros (proveedores)" type="h4"/>

        <container-dialog id="LoadDteDialog" button-text="Cargar DTE">
            <form-single name="LoadDteForm" transition="loadDte">
                <field name="activeOrgId"><default-field><hidden default-value="true"/></default-field></field>
                <field name="xml">
                    <default-field>
                        <file size="30"/>
                    </default-field>
                </field>
                <field name="pdf">
                    <default-field>
                        <file size="30"/>
                    </default-field>
                </field>
                <field name="emisor">
                    <default-field title="Rut Emisor (Automático)">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="emailEmisor">
                    <default-field title="Email Emisor (Automático)">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="amount">
                    <default-field title="Monto Total">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="montoNeto">
                    <default-field title="Monto Neto">
                        <text-line size="15"/>
                    </default-field>
                </field>
                <field name="nroDocumento">
                    <default-field title="Nro. Documento/Folio">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="fiscalTaxDocumentTypeEnumId">
                    <default-field title="DTE Type">
                        <drop-down>
                            <entity-options key="${enumId}">
                                <entity-find entity-name="moqui.basic.Enumeration">
                                    <econdition field-name="enumTypeId" value="FiscalTaxDocumentType"/>
                                </entity-find>
                            </entity-options>
                        </drop-down>
                    </default-field>
                </field>
                <field name="tasaImpuesto">
                    <default-field title="Tasa Impuesto (19% para IVA)">
                        <text-line size="3" default-value="19"/>
                    </default-field>
                </field>
                <field name="tipoImpuesto">
                    <default-field title="Tipo Impuesto (1 si es IVA)">
                        <text-line size="3" default-value="1"/>
                    </default-field>
                </field>
                <field name="razonSocial">
                    <default-field title="Razón Social">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="fechaEmision">
                    <default-field title="Fecha Emisión">
                        <date-time format="YYYY-MM-DD"/>
                    </default-field>
                </field>
                <field name="documentoAnulado">
                    <default-field title="Documento Anulado">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoExento">
                    <default-field title="Monto Exento">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVARecuperable">
                    <default-field title="Monto IVA Recuperable">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="codigoIVANoRecuperable">
                    <default-field title="Código IVA No Recuperable">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVANoRecuperable">
                    <default-field title="Monto IVA No Recuperable">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVAUsoComun">
                    <default-field title="Monto IVA Uso Común">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="codigoOtroImpuestoORetencion">
                    <default-field title="Código Otro Impuesto O Retención">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="tasaOtroImpuestoORetencion">
                    <default-field title="Tasa Otro Impuesto O Retención">
                        <text-line size="2"/>
                    </default-field>
                </field>
                <field name="montoOtroImpuestoORetencionConCredito">
                    <default-field title="Monto Otro Impuesto O Retención con Crédito">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoOtroImpuestoORetencionSinCredito">
                    <default-field title="Monto Otro Impuesto O Retención con Crédito">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoNetoActivoFijo">
                    <default-field title="Monto Neto Activo Fijo">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVAActivoFijo">
                    <default-field title="Monto IVA Activo Fijo">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVANoRetenido">
                    <default-field title="Monto IVA No Retenido">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="codigoSucursal">
                    <default-field title="Código Sucursal">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="notasDebitoCreditoFacturasCompra">
                    <default-field title="Notas de Débito/Crédito por Facturas de Compra">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="Load">
                    <default-field>
                        <submit/>
                    </default-field>
                </field>
            </form-single>
        </container-dialog>

        <container-dialog id="LoadDtDialog" button-text="Cargar Documentos no Electrónicos">
            <form-single name="LoadDtForm" transition="loadDt">
                <field name="activeOrgId"><default-field><hidden default-value="true"/></default-field></field>
                <field name="vendorPartyId"><default-field title="Supplier"><drop-down allow-empty="true">
                    <dynamic-options transition="searchPartyList" server-search="true" min-length="2" parameter-map="[roleTypeId:vendorRole]"/>
                </drop-down></default-field></field>

                <field name="xml">
                    <default-field>
                        <file size="30"/>
                    </default-field>
                </field>
                <field name="pdf">
                    <default-field>
                        <file size="30"/>
                    </default-field>
                </field>
                <field name="emisor">
                    <default-field title="Rut Emisor (automático)">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="emailEmisor">
                    <default-field title="Email Emisor (automático)">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="amount">
                    <default-field title="Monto Total">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="montoNeto">
                    <default-field title="Monto Neto">
                        <text-line size="15"/>
                    </default-field>
                </field>
                <field name="nroDocumento">
                    <default-field title="Nro. Documento/Folio">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="fiscalTaxDocumentTypeEnumId">
                    <default-field title="DTE Type">
                        <drop-down>
                            <entity-options key="${enumId}">
                                <entity-find entity-name="moqui.basic.Enumeration">
                                    <econdition field-name="enumTypeId" value="FiscalTaxDocumentType"/>
                                </entity-find>
                            </entity-options>
                        </drop-down>
                    </default-field>
                </field>
                <field name="tasaImpuesto">
                    <default-field title="Tasa Impuesto (19% para IVA)">
                        <text-line size="3" default-value="19"/>
                    </default-field>
                </field>
                <field name="tipoImpuesto">
                    <default-field title="Tipo Impuesto (1 si es IVA)">
                        <text-line size="3" default-value="1"/>
                    </default-field>
                </field>
                <field name="razonSocial">
                    <default-field title="Razón Social">
                        <text-line size="30"/>
                    </default-field>
                </field>
                <field name="fechaEmision">
                    <default-field title="Fecha Emisión">
                        <date-time format="YYYY-MM-DD"/>
                    </default-field>
                </field>
                <field name="documentoAnulado">
                    <default-field title="Documento Anulado">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoExento">
                    <default-field title="Monto Exento">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVARecuperable">
                    <default-field title="Monto IVA Recuperable">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="codigoIVANoRecuperable">
                    <default-field title="Código IVA No Recuperable">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVANoRecuperable">
                    <default-field title="Monto IVA No Recuperable">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVAUsoComun">
                    <default-field title="Monto IVA Uso Común">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="codigoOtroImpuestoORetencion">
                    <default-field title="Código Otro Impuesto O Retención">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="tasaOtroImpuestoORetencion">
                    <default-field title="Tasa Otro Impuesto O Retención">
                        <text-line size="2"/>
                    </default-field>
                </field>
                <field name="montoOtroImpuestoORetencionConCredito">
                    <default-field title="Monto Otro Impuesto O Retención con Crédito">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoOtroImpuestoORetencionSinCredito">
                    <default-field title="Monto Otro Impuesto O Retención con Crédito">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoNetoActivoFijo">
                    <default-field title="Monto Neto Activo Fijo">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVAActivoFijo">
                    <default-field title="Monto IVA Activo Fijo">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="montoIVANoRetenido">
                    <default-field title="Monto IVA No Retenido">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="codigoSucursal">
                    <default-field title="Código Sucursal">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="notasDebitoCreditoFacturasCompra">
                    <default-field title="Notas de Débito/Crédito por Facturas de Compra">
                        <text-line size="10"/>
                    </default-field>
                </field>
                <field name="load">
                    <default-field>
                        <submit/>
                    </default-field>
                </field>
            </form-single>
        </container-dialog>

        <form-list name="DteForm" list="dteList" show-pdf-button="true" show-csv-button="true" header-dialog="true" saved-finds="true" multi="true">
            <row-actions>
                <!-- Se busca ubicación de XML y PDF -->
                <service-call name="mchile.DTEServices.get#DTEFilename"
                              in-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, format:'xml']" out-map="context"/>
                <set field="xmlFilename" from="filename"/>
            </row-actions>
            <field name="_useRowSubmit"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId"><default-field><hidden default-value="true"/></default-field></field>
            <field name="fiscalTaxDocumentId">
                <header-field title="Folio o Identificador" show-order-by="true"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="fiscalTaxDocumentTypeEnumId">
                <header-field title="Type" show-order-by="true">
                    <drop-down allow-empty="true" allow-multiple="true">
                        <entity-options key="${enumId}">
                            <entity-find entity-name="moqui.basic.Enumeration">
                                <econdition field-name="enumTypeId" value="FiscalTaxDocumentType"/>
                            </entity-find>
                        </entity-options>
                    </drop-down>
                </header-field>
                <default-field>
                    <display-entity entity-name="moqui.basic.Enumeration"/>
                </default-field>
            </field>
            <field name="emisor">
                <header-field show-order-by="true" title="Rut Emisor"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="amount">
                <header-field show-order-by="true"><text-line size="6"/></header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="xml">
                <default-field title=" ">
                    <link url="xml/${xml}" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="XML" link-type="anchor"/>
                </default-field>
            </field>
            <field name="pdf">
                   <default-field title=" ">
                    <link url="pdf/${pdf}" parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="PDF" link-type="anchor"/>
                   </default-field>
            </field>
            <field name="verificarEnSII">
                <default-field title=" ">
                    <link url="verificarEnSII" tooltip="Verificar Estado en SII"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId]" text="Verificar en SII"/>
                </default-field>
            </field>

            <field name="eliminarDTETercero">
                <default-field title=" ">
                    <link url="eliminarDTETercero" tooltip="Eliminar"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId]" text="Eliminar"/>
                </default-field>
            </field>

            <!-- Movido a Dialog -->
            <field name="enviarAceptacion">
                <default-field title=" ">
                    <link url="enviarAceptacion" tooltip="Enviar Aceptación"  parameter-map="[fiscalTaxDocumentId:fiscalTaxDocumentId, fiscalTaxDocumentTypeEnumId:fiscalTaxDocumentTypeEnumId, emisor:emisor, xml:xml]" text="Enviar Aceptación"/>
                </default-field>
            </field>
        </form-list>
    </widgets>
</screen>