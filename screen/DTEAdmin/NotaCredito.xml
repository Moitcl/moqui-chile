<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="Nota de Crédito"
        default-menu-index="30">

    <transition name="genNotaCredito">
        <!--parameter name="genReturnId" from="genReturnId"/-->
        <service-call name="mchile.DTEServices.generar#NotaCredito" in-map="[returnId:returnId]"/>
        <default-response url="."/>
    </transition>

    <transition name="agregarReferencia">
        <service-call name="mchile.DTEServices.agregar#Referencia" in-map="[returnId:returnId, dteTypeEnumId:dteTypeEnumId, fecha:fecha,
            rutOtroContribuyente:rutOtroContribuyente, codigoReferenciaEnumId:codigoReferenciaEnumId, razonReferencia:razonReferencia, idAdicional:idAdicional, folio:folio]"/>
        <default-response url="." save-current-screen="true"/>
    </transition>

    <transition name="verReferencias">
        <parameter name="returnId" from="returnId"/>
        <actions>
            <entity-find entity-name="MoquiChile.ReferenciaReturn" list="referenciaList">
                <econdition field-name="returnId" from="returnId"/>
            </entity-find>
        </actions>
        <default-response url="." save-current-screen="true"/>
    </transition>

    <transition name="eliminarReferencia">
        <parameter name="referenciaReturnId" from="referenciaReturnId"/>
        <actions>
            <service-call name="mchile.DTEServices.eliminar#Referencia" in-map="[referenciaReturnId:referenciaReturnId]"/>
        </actions>
        <default-response url="." save-current-screen="true"/>
    </transition>

    <transition name="createReturn"><service-call name="mantle.order.ReturnServices.create#Return"/>
        <default-response url="/vapps/PopcAdmin/Return/EditReturn"/></transition>

    <transition name="editReturn"><default-response url="/vapps/PopcAdmin/Return/EditReturn"/></transition>

    <transition-include name="searchPartyList" location="component://SimpleScreens/template/party/PartyForms.xml"/>
    <transition-include name="getFacilityList" location="component://SimpleScreens/template/facility/FacilityTransitions.xml"/>

    <transition name="getWhFacilitiesByVendor">
        <service-call name="mantle.facility.FacilityServices.get#FacilitiesByOwner"
                      in-map="[ownerPartyId:vendorPartyId, facilityTypeEnumId:'FcTpWarehouse']" web-send-json-response="resultList"/>
        <default-response type="none"/>
    </transition>

    <actions>
        <entity-find entity-name="mantle.order.return.ReturnHeaderDetail" list="returnHeaderList">
            <search-form-inputs/><select-field field-name="returnId,statusId,entryDate,facilityId,vendorPartyId,customerPartyId"/>
            <econditions combine="or">
                <econdition field-name="vendorPartyId" value="cvsport"/>
                <!--econdition field-name="customerPartyId" value="cvsport"/-->
            </econditions>
        </entity-find>

        <set field="vendorRole" value="Supplier,Vendor,VendorBillFrom"/>
        <set field="customerRole" value="Customer,CustomerBillTo"/>

        <set field="defaultFacilityId" from="ec.user.getPreference('FacilityGeneralDefault')"/>

    </actions>

    <widgets>
        <container-dialog id="CreateSupplierReturnDialog" button-text="Create Supplier Return">
            <form-single name="CreateSupplierReturn" transition="createReturn">
                <field name="vendorPartyId"><default-field title="Supplier"><drop-down>
                    <dynamic-options transition="searchPartyList" server-search="true" min-length="2" parameter-map="[roleTypeId:vendorRole]"/>
                </drop-down></default-field></field>
                <field name="customerPartyId"><default-field title="Customer Org">
                    <drop-down><entity-options key="${partyId}" text="PartyNameTemplate">
                        <entity-find entity-name="mantle.party.PartyDetailAndRole">
                            <econdition field-name="roleTypeId" value="OrgInternal"/>
                            <econdition field-name="partyId" from="activeOrgId" ignore="!activeOrgId"/>
                            <econdition field-name="disabled" value="N" or-null="true"/>
                            <order-by field-name="organizationName,firstName,lastName"/>
                        </entity-find>
                    </entity-options></drop-down>
                </default-field></field>
                <field name="facilityId" from="facilityId ?: defaultFacilityId"><default-field title="Facility">
                    <drop-down><dynamic-options transition="getFacilityList" server-search="true" min-length="0"
                                                parameter-map="[facilityTypeEnumId:'FcTpWarehouse']"/></drop-down>
                </default-field></field>
                <field name="submitButton"><default-field title="Create"><submit/></default-field></field>
            </form-single>
        </container-dialog>

        <form-list name="ReturnsForm" list="returnHeaderList" header-dialog="true" saved-finds="true" show-csv-button="false" skip-form="true" transition="genNotaCredito">
            <row-actions>
                <!-- Encontrar username -->
                <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:customerPartyId]" out-map="context"/>
                <set field="username" from="emailAddress"/>
                <set field="genReturnId" from="returnId"/>
            </row-actions>

            <field name="returnId">
                <header-field show-order-by="case-insensitive"><text-find hide-options="true" size="10"/></header-field>
                <default-field><link url="editReturn" text="${returnId}" link-type="anchor"/></default-field>
            </field>
            <field name="statusId">
                <header-field title="Status" show-order-by="true">
                    <widget-template-include location="component://webroot/template/screen/BasicWidgetTemplates.xml#statusDropDown">
                        <set field="statusTypeId" value="Return"/><set field="allowEmpty" value="true"/>
                        <set field="allowMultiple" value="true"/></widget-template-include>
                </header-field>
                <default-field><display-entity entity-name="moqui.basic.StatusItem"/></default-field>
            </field>
            <field name="vendorPartyId">
                <header-field title="Vendor">
                    <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true" min-length="0"
                                                                   parameter-map="[roleTypeId:'Supplier,Vendor,OrgInternal']"/></drop-down>
                </header-field>
                <default-field><link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"/></default-field>
            </field>
            <field name="customerPartyId">
                <header-field title="Customer">
                    <drop-down allow-empty="true"><dynamic-options transition="searchPartyList" server-search="true" min-length="2"
                                                                   parameter-map="[roleTypeId:'Customer,OrgInternal']"/></drop-down>
                </header-field>
                <default-field><link url="editParty" entity-name="mantle.party.PartyDetail" text="PartyNameTemplate" link-type="anchor"/></default-field>
            </field>
            <field name="facilityId">
                <header-field title="Warehouse"><drop-down allow-empty="true"><dynamic-options transition="getFacilityList" server-search="true" min-length="0"
                                                                                               parameter-map="[facilityTypeEnumId:'FcTpWarehouse']"/></drop-down></header-field>
                <default-field><link url="editFacility" entity-name="mantle.facility.Facility" text="FacilityNameTemplate" link-type="anchor"/></default-field>
            </field>
            <field name="genNotaCreditoForm">
                <default-field title="">
                    <container-dialog id="AgregarReferenciaDialog" button-text="Agregar Referencia">
                        <form-single name="AgregarReferenciaForm" transition="agregarReferencia">
                            <field name="returnId"><default-field><hidden/></default-field>
                            </field>
                            <field name="dteTypeEnumId"><default-field title="Tipo DTE Referencia">
                                <drop-down><entity-options key="${enumId}" text="">
                                    <entity-find entity-name="moqui.basic.Enumeration">
                                        <econdition field-name="enumTypeId" value="DteType"/>
                                    </entity-find>
                                </entity-options></drop-down>
                            </default-field></field>

                            <field name="folio">
                                <default-field title="Folio Referencia"><text-line size="10"/></default-field>
                            </field>
                            <field name="rutOtroContribuyente">
                                <default-field title="RUT Otro Contribuyente"><text-line size="15"/></default-field>
                            </field>
                            <field name="idAdicional">
                                <default-field title="ID Adicional Otro Contribuyente"><text-line size="15"/></default-field>
                            </field>
                            <field name="fecha">
                                <default-field title="Fecha Documento Referencia"><date-time format="YYYY-MM-DD"/> </default-field>
                            </field>
                            <field name="codigoReferenciaEnumId"><default-field title="Código Referencia">
                                <drop-down><entity-options key="${enumId}" text="">
                                    <entity-find entity-name="moqui.basic.Enumeration">
                                        <econdition field-name="enumTypeId" value="CodigoReferencia"/>
                                    </entity-find>
                                </entity-options></drop-down>
                            </default-field></field>
                            <field name="razonReferencia">
                                <default-field title="Razón Referencia"><text-line size="20"/></default-field>
                            </field>
                            <field name="submitButton"><default-field title="Añadir"><submit/></default-field></field>
                        </form-single>
                    </container-dialog>
                    <!-- Listado de Referencias -->
                    <container-dialog id="VerReferenciaDialog" button-text="Ver Referencias" width="70%">
                        <form-list name="VerReferenciaForm" dynamic="true" list="referenciaList" multi="false" transition="eliminarReferencia">
                            <entity-find entity-name="MoquiChile.ReferenciaReturn" list="referenciaList">
                                <econdition field-name="returnId" from="returnId"/>
                            </entity-find>
                            <field name="referenciaReturnId"><default-field><hidden/></default-field>
                            </field>
                            <field name="returnId"><default-field><hidden/></default-field>
                            </field>
                            <field name="folio">
                                <default-field title="Folio Referencia"><display format="######"/></default-field>
                            </field>
                            <field name="rut">
                                <default-field title="RUT Otro Contribuyente"><display/></default-field>
                            </field>
                            <field name="fecha">
                                <default-field title="Fecha"><display/></default-field>
                            </field>

                            <field name="dteTypeEnumId">
                                <default-field>
                                    <display-entity entity-name="moqui.basic.Enumeration"/>
                                </default-field>
                            </field>

                            <field name="codigoReferenciaEnumId">
                                <default-field>
                                    <display-entity entity-name="moqui.basic.Enumeration"/>
                                </default-field>
                            </field>
                            <field name="razonReferencia">
                                <default-field title="Razón Referencia"><display/> </default-field>
                            </field>
                            <field name="submitButton"><default-field title="Eliminar"><submit/></default-field></field>
                        </form-list>
                    </container-dialog>
                    <link url="genNotaCredito" text="Crear Nota de Crédito" url-type="transition" link-type="auto"/>
                </default-field>
            </field>
        </form-list>
    </widgets>
</screen>