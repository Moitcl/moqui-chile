<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns=""
        xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="FacturaciÃ³n"
        default-menu-index="30">
    <transition name="facturarInvoice">
        <actions>
            <if condition="genFactForm">
                <service-call name="mchile.DTEServices.facturar#Invoice" in-map="[invoiceId:invoiceId, dteTypeEnumId:'33', textoReferencia:textoReferencia]"/>
            </if>
            <if condition="genFactExForm">
                <service-call name="mchile.DTEServices.facturar#Invoice" in-map="[invoiceId:invoiceId, dteTypeEnumId:'34', textoReferencia:textoReferencia]"/>
            </if>

        </actions>
        <default-response url="."/>
    </transition>
    <actions>
        <!-- Ventas web tienen campo salesChannelEnumId -->
        <!--entity-find entity-name="mantle.order.OrderHeader" list="webOrders"-->
        <entity-find entity-name="tfpos.InvoiceAndFiscalTaxDocument" list="invoices">
            <search-form-inputs default-order-by="-invoiceDate"/>
            <econdition field-name="invoiceTypeEnumId" value="InvoiceSales"/>
            <!-- TODO: Revisar condiciones para no listar lo ya facturado -->
            <econdition field-name="statusId" value="PmntConfirmed"/>
            <econdition field-name="folio" operator="is-null"/>
        </entity-find>
    </actions>
    <widgets>
        <form-list name="InvoiceForm" list="invoices" header-dialog="true" saved-finds="true" show-csv-button="true" transition="facturarInvoice">
            <row-actions>
                <!-- Encontrar username -->
                <service-call name="mantle.party.ContactServices.get#PrimaryEmailAddress" in-map="[partyId:toPartyId]" out-map="context"/>
                <set field="username" from="emailAddress"/>
            </row-actions>
            <field name="invoiceId">
                <header-field title="Invoice ID" show-order-by="true"><text-find/></header-field>
                <default-field><display/></default-field>
            </field>
            <field name="paymentId">
                <header-field title="Payment ID" show-order-by="true"><text-find/></header-field>
                <default-field><display/></default-field>
            </field>
            <field name="toPartyId">
                <header-field title="Customer" show-order-by="true"><text-find/></header-field>
                <default-field><display/></default-field>
            </field>
            <field name="username">
                <header-field show-order-by="true"><text-line size="20"/></header-field>
                <conditional-field condition="username != null">
                    <display text="${username}"/>
                </conditional-field>
            </field>
            <field name="orderId">
                <header-field title="Order ID" show-order-by="true"><text-find/></header-field>
                <default-field><display/></default-field>
            </field>
            <field name="effectiveDate">
                <header-field title="placedDate" show-order-by="true"><text-find/></header-field>
                <default-field><display/></default-field>
            </field>
            <field name="invoiceTotal">
                <header-field title="Total" show-order-by="true"><text-find/></header-field>
                <default-field><display/></default-field>
            </field>
            <field name="paymentId"><default-field><hidden/></default-field></field>
            <field name="genFactForm"><default-field title="Generar Factura"><submit/></default-field></field>
            <field name="genFactExForm"><default-field title="Generar Fact. Exenta"><submit/></default-field></field>
            <!--field name="genBoletaForm"><default-field title="Generar Boleta"><submit/></default-field></field-->
        </form-list>
    </widgets>
</screen>