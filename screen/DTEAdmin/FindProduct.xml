<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        menu-image="glyphicon glyphicon-shopping-cart" menu-image-type="icon" default-menu-title="Products"
        default-menu-index="1">
    <transition name="createProduct">
        <service-call name="tfpos.ProductServices.create#Product" in-map="context+[productCategoryId:'StoreProducts', productTypeEnumId:'PtAsset',
                    assetTypeEnumId:'AstTpInventory', assetClassEnumId:'AsClsInventory']"/>
        <default-response url="."/>
    </transition>
    <transition name="addBarcode"><default-response url="../AddBarcode.xml" save-current-screen="true"/></transition>
    <transition name="editProduct"><default-response url="../../PopcAdmin/Catalog/Product/EditProduct"/></transition>
    <transition name="discontinueProduct">
        <service-call name="tfpos.ProductServices.discontinue#Product" in-map="[productId:productId]"/>
        <default-response url="."/>
    </transition>
    <transition name="reactivateProduct">
        <service-call name="tfpos.ProductServices.reactivate#Product" in-map="[productId:productId]"/>
        <default-response url="."/>
    </transition>
    <actions>
        <set field="searchMap" from="[productCategoryId:'StoreProducts', productTypeEnumId:'PtAsset',
                    assetClassEnumId:'AsClsInventory']"/>
        <if condition="idValue">
            <entity-find entity-name="mantle.product.ProductIdentification" list="productsByBarcode">
                <econdition field-name="idValue" from="idValue"/>
            </entity-find>
            <if condition="productsByBarcode">
                <set field="searchMap.productId" from="productsByBarcode.first.productId"/>
            </if>
            <set field="idValue" from="null"/>
        </if>
        <entity-find entity-name="mantle.product.ProductAndCategoryAndClass" list="products" distinct="true">
            <search-form-inputs/>
            <date-filter ignore="active == 'showDiscontinued'" from-field-name="salesIntroductionDate" thru-field-name="salesDiscontinuationDate"/>
            <econdition-object field="searchMap"/>
        </entity-find>
        <entity-find entity-name="mantle.party.PartyRelationship" list="agentFor">
            <econdition field-name="relationshipTypeEnumId" value="PrtAgent"/>
            <econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/>
        </entity-find>
        <if condition="agentFor.size() == 1">
            <set field="pricePartyId" from="agentFor.first.toPartyId"/>
        </if>
    </actions>
    <widgets>
        <form-single name="QuickSearchForm">
            <field name="productName"><default-field><text-line size="40"/></default-field></field>
            <field name="productName_op"><default-field><hidden default-value="contains"/></default-field></field>
            <field name="productName_ic"><default-field><hidden default-value="Y"/></default-field></field>
            <field name="description"><default-field><text-line size="40"/></default-field></field>
            <field name="description_op"><default-field><hidden default-value="contains"/></default-field></field>
            <field name="description_ic"><default-field><hidden default-value="Y"/></default-field></field>
            <field name="search"><default-field><submit/></default-field></field>
        </form-single>
        <container-dialog id="CreateProductDialog" button-text="Create Product">
            <form-single name="CreateProductForm" transition="createProduct">
                <field name="productName">
                    <default-field>
                        <text-line/>
                    </default-field>
                </field>
                <field name="description">
                    <default-field>
                        <text-area/>
                    </default-field>
                </field>
                <field name="productClassEnumId">
                    <default-field title="Product Class">
                        <drop-down>
                            <entity-options key="${enumId}">
                                <entity-find entity-name="moqui.basic.Enumeration">
                                    <econdition field-name="enumTypeId" value="ProductClass"/>
                                </entity-find>
                            </entity-options>
                        </drop-down>
                    </default-field>
                </field>
                <field name="barcodeIdValue">
                    <header-field title="Barcode"/>
                    <conditional-field condition="scanUrl">
                        <link url="${scanUrl}" text="Scan" link-type="anchor-button" url-type="plain" parameter-map="scanUrlParameterMap"/>
                        <text-line size="20"/>
                    </conditional-field>
                    <default-field title="Barcode"><text-line size="20"/></default-field>
                </field>
                <field name="barcodeType"><default-field title="Barcode Type">
                    <drop-down no-current-selected-key="PidtEan">
                        <entity-options><entity-find entity-name="moqui.basic.Enumeration"><econdition field-name="enumTypeId" value="ProductIdentificationType"/></entity-find></entity-options>
                    </drop-down>
                </default-field></field>
                <field name="pricePartyId"><default-field><hidden/></default-field></field>
                <field name="salePrice">
                    <default-field><text-line format="Number" size="10"/>
                    </default-field></field>
                <field name="purchasePrice">
                    <default-field><text-line format="Number" size="10"/>
                    </default-field></field>
                <field name="priceUomId"><default-field title="Currency"><drop-down no-current-selected-key="${ec.user.getPreference('Currency.DefaultCurrency') ?: 'USD'}">
                    <entity-options key="${uomId}" text="${description} [${uomId}]">
                        <entity-find entity-name="moqui.basic.Uom">
                            <econdition field-name="uomTypeEnumId" value="UT_CURRENCY_MEASURE"/>
                            <order-by field-name="description"/>
                        </entity-find></entity-options>
                </drop-down></default-field></field>
                <field name="vatTaxable">
                    <default-field>
                        <check no-current-selected-key="subjectToVatTax"><option key="subjectToVatTax" text=" "/></check>
                    </default-field>
                </field>
                <field name="create">
                    <default-field>
                        <submit/>
                    </default-field>
                </field>
            </form-single>
        </container-dialog>
        <form-list name="ProductsForm" list="products" show-pdf-button="true" show-csv-button="true" header-dialog="true">
            <row-actions>
                <entity-find entity-name="mantle.product.ProductIdentification" list="pids">
                    <econdition field-name="productId" from="productId"/>
                    <select-field field-name="idValue"/>
                </entity-find>
                <iterate entry="pid" list="pids">
                    <set field="idValue" from="idValue? (idValue + ' ' + pid.idValue): pid.idValue"/>
                </iterate>
                <if condition="(salesIntroductionDate == null || salesIntroductionDate &lt;= ec.user.nowTimestamp) &amp;&amp; (salesDiscontinuationDate == null || salesDiscontinuationDate > ec.user.nowTimestamp)">
                    <then><set field="active" from="true"/></then>
                    <else><set field="active" from="false"/></else>
                </if>
                <entity-find entity-name="mantle.product.category.ProductCategoryAndMember" list="productCategories">
                    <econdition field-name="productId" from="productId"/>
                    <econdition field-name="productCategoryId" operator="not-equals" value="StoreProducts"/>
                    <econdition field-name="productCategoryTypeEnumId" value="PctCatalog"/>
                    <date-filter/>
                </entity-find>
                <set field="categories" value=""/>
                <iterate list="productCategories" entry="productCategory">
                    <entity-find-related-one value-field="productCategory" relationship-name="category" to-value-field="cat"/>
                    <set field="categories" from="categories == ''? cat.categoryName: (categories + ', ' + cat.categoryName)"/>
                </iterate>
            </row-actions>
            <field name="productId">
                <header-field show-order-by="true"><text-line size="10"/></header-field>
                <default-field><link url="editProduct" text="${pseudoId}" link-type="anchor"/></default-field>
            </field>
            <field name="productClassEnumId">
                <header-field title="Class" show-order-by="true">
                    <drop-down allow-empty="true" allow-multiple="true">
                        <entity-options key="${enumId}">
                            <entity-find entity-name="moqui.basic.Enumeration">
                                <econdition field-name="enumTypeId" value="ProductClass"/>
                            </entity-find>
                        </entity-options>
                    </drop-down>
                </header-field>
                <default-field>
                    <display-entity entity-name="moqui.basic.Enumeration"/>
                </default-field>
            </field>
            <field name="idValue">
                <header-field title="Barcode"><text-line size="10"/></header-field>
                <conditional-field condition="!idValue">
                    <link url="addBarcode" text="Add"><parameter name="productId"/></link>
                </conditional-field>
                <default-field><display/></default-field>
            </field>
            <field name="productName">
                <header-field show-order-by="true">
                    <text-find hide-options="true"/>
                </header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="categories">
                <header-field>
                    <drop-down allow-multiple="true" allow-empty="true">
                        <entity-options key="${productCategoryId}" text="${categoryName}">
                            <entity-find entity-name="mantle.product.category.ProductCategory">
                                <econdition field-name="productCategoryTypeEnumId" value="PctCatalog"/>
                                <econdition field-name="productCategoryId" operator="not-equals" value="StoreProducts"/>
                            </entity-find>
                        </entity-options>
                    </drop-down>
                </header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="description">
                <header-field>
                    <text-find hide-options="true" size="40"/>
                </header-field>
                <default-field>
                    <display/>
                </default-field>
            </field>
            <field name="active">
                <header-field>
                    <check>
                        <option key="showDiscontinued" text="Show All"/>
                    </check>
                </header-field>
                <conditional-field condition="active">
                    <display text="Active"/>
                    <link url="discontinueProduct" text="Discontinue"/>
                </conditional-field>
                <default-field>
                    <display text="Discontinued"/>
                    <link url="reactivateProduct" text="Reactivate"/>
                </default-field>
            </field>
            <field name="search">
                <header-field>
                    <submit/>
                </header-field>
                <conditional-field condition="sri.renderMode in ['html', 'vuet']">
                    <link url="/apps/PopcAdmin/Catalog/Product/EditProduct" parameter-map="[productId:productId]" text="Details"/>
                </conditional-field>
                <default-field/>
            </field>
        </form-list>
    </widgets>
</screen>